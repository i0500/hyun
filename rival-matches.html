<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>현클럽 경기 기록 관리</title>
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://i0500.github.io/hyun/rival-matches.html">
    <meta property="og:title" content="현클럽 테니스 경기 기록 관리">
    <meta property="og:description" content="승부 기록, 경기 유형별 통계">
    <meta property="og:image" content="https://i0500.github.io/hyun/tennis-club-preview.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://i0500.github.io/hyun/rival-matches.html">
    <meta property="twitter:title" content="현클럽 테니스 경기 기록 관리">
    <meta property="twitter:description" content="승부 기록, 경기 유형별 통계">
    <meta property="twitter:image" content="https://i0500.github.io/hyun/tennis-club-preview.png">

    <!-- Meta description for SEO -->
    <meta name="description" content="승부 기록, 경기 유형별 통계">
    <meta name="keywords" content="테니스, 동호회, 경기기록, 승점, 랭킹, 현클럽">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Chart.js for statistics charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 10px;
            margin: 0;
        }

        /* 로딩 오버레이 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .loading-modal {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 320px;
            width: 90%;
            text-align: center;
            transform: scale(1);
            animation: modalFadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid #f1f5f9;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }

        .loading-progress {
            width: 100%;
            height: 8px;
            background: #f1f5f9;
            border-radius: 4px;
            overflow: hidden;
            margin: 0 auto 20px;
            position: relative;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            border-radius: 4px;
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
        }

        .loading-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: progressShine 1.5s infinite;
        }

        .loading-text {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .loading-subtext {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.4;
        }

        .loading-percentage {
            font-size: 12px;
            color: #4f46e5;
            font-weight: 600;
            margin-top: 8px;
        }

        .loading-progress {
            width: 100%;
            height: 6px;
            background: #f3f4f6;
            border-radius: 3px;
            overflow: hidden;
            margin: 16px 0 8px 0;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5, #6366f1);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
        }

        .loading-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: progressShine 1.5s infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes modalFadeIn {
            0% { 
                opacity: 0; 
                transform: scale(0.9) translateY(20px);
            }
            100% { 
                opacity: 1; 
                transform: scale(1) translateY(0);
            }
        }

        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        @keyframes fadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }

        @keyframes slideUp {
            0% { 
                opacity: 0;
                transform: scale(0.7) translateY(50px);
            }
            100% { 
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes slideDown {
            0% { 
                opacity: 1;
                transform: scale(1) translateY(0);
            }
            100% { 
                opacity: 0;
                transform: scale(0.7) translateY(50px);
            }
        }

        @keyframes progressShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(200%); }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c5f2d 0%, #1a3a1b 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
        }

        /* 탭 네비게이션 */
        .tab-navigation {
            display: flex;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 6px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        /* 스크롤 시 상단에 고정되는 상태 */
        .tab-navigation.sticky {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            z-index: 1000;
            margin: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            background: #ffffff;
            border: 1px solid #e9ecef;
        }

        .tab-btn {
            flex: 1;
            background: transparent;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            min-height: 44px;
            position: relative;
            white-space: nowrap;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .tab-btn:hover {
            color: #2c5f2d;
            background: rgba(44, 95, 45, 0.1);
        }

        .tab-btn.active {
            background: #2c5f2d;
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(44, 95, 45, 0.3);
        }

        .tab-btn.active:hover {
            background: #1a3a1b;
            color: white;
        }

        .tab-btn svg {
            width: 16px;
            height: 16px;
        }

        .toolbar {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }

        .btn {
            background: #2c5f2d;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            min-height: 44px; /* 터치 친화적인 최소 높이 */
            white-space: nowrap;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .btn:hover {
            background: #1a3a1b;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-dot.connected {
            background: #28a745;
        }

        .main-content {
            padding: 30px;
        }

        .page-info {
            color: rgba(0, 0, 0, 0.4);
            font-size: 13px;
            font-weight: 500;
            text-align: left;
            margin: 10px 0 15px 0;
            padding-left: 5px;
        }

        .matches-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        }

        .match-card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: default;
        }

        .match-card:hover {
            transform: translateY(-5px);
        }

        .match-header {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .match-title {
            font-weight: 600;
            color: #2c5f2d;
            font-size: 1.1rem;
        }

        .match-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 12px;
            border-radius: 6px;
        }

        .match-body {
            padding: 20px;
        }

        .team-vs {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: nowrap !important;
            width: 100%;
        }

        .team-name {
            font-weight: 600;
            font-size: 1rem;
            color: #495057;
            flex: 1 1 0;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .team-name:first-child {
            text-align: right;
        }

        .team-name:last-child {
            text-align: left;
        }

        .vs-badge {
            background: #6c757d;
            color: white;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            flex: 0 0 auto;
        }

        .score-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 15px 0;
        }

        .score {
            font-size: 2rem;
            font-weight: 700;
            color: #2c5f2d;
        }

        .score-separator {
            font-size: 1.5rem;
            color: #6c757d;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* 탭 콘텐츠 영역 */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 랭킹 페이지 스타일 */
        .ranking-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 0 20px;
        }

        .ranking-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c5f2d;
            margin-bottom: 8px;
        }

        .ranking-header p {
            color: #666;
            font-size: 14px;
        }

        .ranking-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .ranking-item {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .ranking-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .ranking-item:hover .player-name {
            color: #333 !important;
        }

        .ranking-item.rank-1 {
            border-left-color: #ffd700;
            background: linear-gradient(135deg, #fff9e6 0%, white 100%);
        }

        .ranking-item.rank-2 {
            border-left-color: #c0c0c0;
            background: linear-gradient(135deg, #f5f5f5 0%, white 100%);
        }

        .ranking-item.rank-3 {
            border-left-color: #cd7f32;
            background: linear-gradient(135deg, #fff5e6 0%, white 100%);
        }

        .rank-number {
            font-size: 1.2rem;
            font-weight: 700;
            min-width: 60px;
            text-align: center;
            color: #2c5f2d;
        }

        .rank-number.rank-1 {
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .rank-number.rank-2 {
            color: #c0c0c0;
        }

        .rank-number.rank-3 {
            color: #cd7f32;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333 !important;
            margin-bottom: 4px;
        }

        .player-stats {
            font-size: 13px;
            color: #666;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .total-points {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2c5f2d;
            min-width: 80px;
            text-align: right;
        }

        .points-suffix {
            font-size: 0.9rem;
            font-weight: 500;
            color: #666;
        }

        .empty-ranking {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-ranking svg {
            width: 64px;
            height: 64px;
            color: #ddd;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            font-weight: 600;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100dvh;
            background-color: rgba(0, 0, 0, 0);
            backdrop-filter: blur(0px);
            overflow: hidden;
            opacity: 0;
            transition: all 0.3s ease;
            align-items: center;
            justify-content: center;
        }
        
        /* 바디 스크롤 방지 */
        body.modal-open {
            overflow: hidden;
        }

        .modal.show {
            display: flex;
            opacity: 1;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            width: 95%;
            max-width: 1200px;
            max-height: 95dvh;
            overflow-y: auto;
            transform: scale(0.7) translateY(-50px);
            transition: all 0.3s ease;
            opacity: 0;
        }

        .modal.show .modal-content {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-weight: 600;
            color: #2c5f2d;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 자동완성 드롭다운 스타일 */
        .autocomplete-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10001;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
            width: 100%;
            margin-top: 2px;
        }

        .autocomplete-item {
            padding: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background-color: #f0f0f0;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        /* 점수 입력 세련된 스타일 */
        .score-container {
            background: #ffffff;
            border-radius: 8px;
            padding: 8px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .score-display {
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #2c5282;
            padding: 8px;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 6px;
            border: 2px solid #e2e8f0;
            min-width: 32px;
            flex-shrink: 0;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .score-buttons {
            display: flex;
            gap: 4px;
            flex: 1;
        }

        .score-button {
            flex: 1;
            padding: 8px 4px;
            font-size: 14px;
            font-weight: 600;
            background: #ffffff;
            color: #4a5568;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 0;
            height: 34px;
        }

        .score-button.selected {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border-color: #3182ce;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(49, 130, 206, 0.3);
        }

        .score-button:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .score-button.selected:hover {
            background: linear-gradient(135deg, #3182ce, #2c5282);
        }

        .score-clear-button {
            padding: 8px 12px;
            background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
            color: #c53030;
            border: 2px solid #fed7d7;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s ease;
            flex-shrink: 0;
            white-space: nowrap;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .score-clear-button:hover {
            background: linear-gradient(135deg, #feb2b2 0%, #fc8181 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(197, 48, 48, 0.2);
        }

        .player-input-wrapper {
            position: relative;
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }

        .form-group input {
            width: 100%;
            padding: 14px 12px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 16px; /* iOS에서 줌 방지를 위한 16px */
            transition: border-color 0.3s ease;
            min-height: 44px; /* 터치 친화적인 높이 */
            box-sizing: border-box;
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2c5f2d;
            box-shadow: 0 0 0 3px rgba(44, 95, 45, 0.1);
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Mobile Modal Footer - 좌우 정렬 */
        @media (max-width: 768px) {
            .modal-footer {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 8px;
                padding: 15px;
            }

            .modal-footer .btn {
                flex: 1;
                margin: 0;
                padding: 10px 8px;
                font-size: 14px;
                min-width: 0;
                white-space: nowrap;
            }
        }

        /* 더 작은 화면에서 버튼 추가 조정 */
        @media (max-width: 400px) {
            .modal-footer {
                gap: 6px;
                padding: 12px;
            }

            .modal-footer .btn {
                padding: 10px 6px;
                font-size: 13px;
            }
        }

        /* 경기 유형 체크박스 스타일 */
        .match-type-group {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fb;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            justify-content: space-between;
        }

        .match-type-label {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 12px 18px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            text-align: center;
            min-width: 80px;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .match-type-label::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .match-type-label:hover {
            border-color: #2c5f2d;
            background: linear-gradient(135deg, #f0f8f0 0%, #e8f5e8 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(44, 95, 45, 0.15);
        }

        .match-type-label:hover::before {
            left: 100%;
        }

        .match-type-label input[type="radio"] {
            display: none;
        }

        .match-type-label.selected {
            background: linear-gradient(135deg, #2c5f2d 0%, #1a3a1b 100%);
            border-color: #2c5f2d;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(44, 95, 45, 0.3);
        }

        .match-type-label.selected::before {
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        }

        .type-label-text {
            font-size: 14px;
            font-weight: 500;
        }

        /* 모바일에서 경기유형 선택 스타일 */
        @media (max-width: 768px) {
            .match-type-group {
                gap: 8px;
                padding: 12px;
                flex-wrap: wrap;
                overflow-x: visible;
            }
            
            .match-type-label {
                padding: 8px 12px;
                font-size: 12px;
                min-width: 60px;
                flex-shrink: 0;
            }
        }
        
        /* 타이틀 선택 전용 스타일 (5개 항목) */
        .match-type-group .match-type-label {
            flex: 1;
            min-width: 70px;
        }
        
        @media (max-width: 480px) {
            .match-type-group .match-type-label {
                padding: 6px 8px;
                font-size: 11px;
                min-width: 50px;
            }

            .type-label-text {
                font-size: 11px;
            }
        }

        /* 승/무/패 라벨 반응형 스타일 */
        .stat-label-short {
            display: none;
        }

        @media (max-width: 480px) {
            .stat-label-full {
                display: none;
            }
            .stat-label-short {
                display: inline;
            }
        }

        /* 경기 유형 인라인 스타일 (타이틀 앞에 표시) */
        .match-type-inline {
            display: inline-block;
            background: linear-gradient(135deg, #2c5f2d 0%, #1a3a1b 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-right: 8px;
            vertical-align: middle;
        }

        .match-type-inline.men-doubles {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        }

        .match-type-inline.women-doubles {
            background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
        }

        .match-type-inline.mixed-doubles {
            background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
        }

        .match-type-inline.singles {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }

        /* 필터 버튼 스타일 */
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 25px;
            padding: 0 20px;
        }

        .filter-btn {
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #dee2e6;
            background: white;
            color: #666;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 50px;
        }

        .filter-btn:hover {
            border-color: #2c5f2d;
            color: #2c5f2d;
        }

        .filter-btn.active {
            background: #2c5f2d !important;
            color: white !important;
            border-color: #2c5f2d !important;
        }
        
        /* 기간 필터는 파란색 계열 */
        .period-filter-btn.active {
            background: #1e40af !important;
            color: white !important;
            border-color: #1e40af !important;
        }
        
        /* 유형 필터는 기존 녹색 유지 */
        .type-filter-btn.active {
            background: #2c5f2d !important;
            color: white !important;
            border-color: #2c5f2d !important;
        }
        
        /* Focus 상태에서도 색상 유지 */
        .period-filter-btn:focus,
        .type-filter-btn:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(44, 95, 45, 0.2);
        }
        
        .period-filter-btn.active:focus,
        .period-filter-btn.active:hover {
            color: white !important;
            background: #1e40af !important;
        }
        
        .type-filter-btn.active:focus,
        .type-filter-btn.active:hover {
            color: white !important;
            background: #2c5f2d !important;
        }

        .period-filter-btn,
        .type-filter-btn {
            padding: 5px 2px;
            border-radius: 12px;
            border: 1px solid #dee2e6;
            background: white;
            color: #666;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 32px;
            max-width: 55px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .period-filter-btn:hover {
            border-color: #1e40af;
            color: #1e40af;
        }
        
        .type-filter-btn:hover {
            border-color: #2c5f2d;
            color: #2c5f2d;
        }

        /* 모바일에서 필터 버튼 더 작게 */
        @media (max-width: 768px) {
            .filter-container {
                gap: 6px;
                padding: 0 15px;
            }
            
            .filter-btn,
            .period-filter-btn,
            .type-filter-btn {
                padding: 3px 6px;
                font-size: 10px;
                min-width: auto;
            }
        }

        /* 페이지네이션 스타일 */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 30px 0;
            padding: 20px;
        }

        .pagination-btn {
            background: white;
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.3s ease;
            min-width: 36px;
            text-align: center;
        }

        .pagination-btn:hover {
            border-color: #2c5f2d;
            background: #f8f9fa;
        }

        .pagination-btn.active {
            background: #2c5f2d;
            color: white;
            border-color: #2c5f2d;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f8f9fa;
        }

        .pagination-info {
            font-size: 14px;
            color: #666;
            margin: 0 15px;
        }

        .pagination-ellipsis {
            color: #999;
            padding: 8px 4px;
            font-size: 14px;
            user-select: none;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .container {
                border-radius: 8px;
                margin: 0;
            }

            .header {
                padding: 20px 15px;
                text-align: left;
            }

            /* 탭 네비게이션 모바일 */
            .tab-navigation {
                margin: 15px 10px;
                padding: 4px;
            }

            .tab-btn {
                padding: 10px 12px;
                font-size: 13px;
                min-height: 42px;
                gap: 6px;
            }

            .tab-btn svg {
                width: 14px;
                height: 14px;
            }

            /* 랭킹 모바일 */
            .ranking-header {
                padding: 0 15px;
                margin-bottom: 20px;
            }

            .ranking-header h2 {
                font-size: 1.5rem;
            }

            .ranking-list {
                padding: 0 15px;
                gap: 10px;
                grid-template-columns: 1fr;
                max-width: 600px;
            }

            .ranking-item {
                padding: 14px 16px;
                gap: 12px;
            }

            .rank-number {
                font-size: 1.1rem;
                min-width: 50px;
            }

            .player-name {
                font-size: 1rem;
            }

            .player-stats {
                font-size: 12px;
                gap: 8px;
            }

            .total-points {
                font-size: 1.2rem;
                min-width: 60px;
            }

            .points-suffix {
                font-size: 0.8rem;
            }

            .header h1 {
                font-size: 1.5rem;
                margin-bottom: 5px;
            }

            .header p {
                font-size: 0.9rem;
            }

            .toolbar {
                padding: 15px;
                flex-direction: column;
                gap: 10px;
            }

            .toolbar > div {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                justify-content: center;
            }

            .btn {
                flex: 1;
                min-width: 120px;
                font-size: 12px;
                padding: 10px 12px;
            }

            .status-indicator {
                justify-content: center;
                font-size: 12px;
            }

            .main-content {
                padding: 15px;
            }

            .page-info {
                font-size: 12px;
                margin: 5px 0 10px 0;
                padding-left: 3px;
            }

            .matches-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .match-card {
                margin-bottom: 10px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            }

            .match-header {
                padding: 15px;
                flex-direction: row !important;
                align-items: center !important;
                justify-content: space-between !important;
                gap: 10px;
            }

            .match-title {
                font-size: 1rem;
                flex: 1;
            }

            .match-actions {
                align-self: auto;
                flex-shrink: 0;
            }

            .match-body {
                padding: 15px;
            }

            .team-vs {
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
                justify-content: space-between !important;
                gap: 8px !important;
                text-align: center;
                width: 100% !important;
                flex-wrap: nowrap !important;
            }

            .team-name {
                font-size: 0.9rem;
                flex: 1 1 0 !important;
                min-width: 0 !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }
            
            .team-name:first-child {
                text-align: right !important;
            }
            
            .team-name:last-child {
                text-align: left !important;
            }

            .vs-badge {
                flex: 0 0 auto !important;
                font-size: 10px;
                padding: 2px 6px;
            }

            .score-display {
                padding: 12px;
                margin: 10px 0;
            }

            .score {
                font-size: 1.5rem;
            }

            .modal-content {
                margin: 2px;
                width: calc(100% - 4px);
                max-height: calc(100dvh - 10px);
                height: calc(100dvh - 10px);
                max-width: none;
            }

            .modal-header {
                padding: 15px 20px;
            }
            
            .modal-content .stat-card {
                grid-column: 1 / -1 !important;
            }
            
            .modal-content[style*="grid"] {
                display: block !important;
            }
            
            .modal-content {
                overflow-x: hidden !important;
                width: calc(100vw - 8px) !important;
                max-width: calc(100vw - 8px) !important;
                height: calc(100dvh - 8px) !important;
                max-height: calc(100dvh - 8px) !important;
                margin: 4px !important;
                border-radius: 8px !important;
            }
            
            .modal-content > div[style*="grid"] {
                overflow-x: hidden !important;
                max-width: 100% !important;
                height: calc(100dvh - 60px) !important;
                max-height: calc(100dvh - 60px) !important;
                padding: 12px !important;
            }
            
            .modal-content .stat-card {
                max-width: 100% !important;
                overflow-x: hidden !important;
                box-sizing: border-box !important;
                margin-bottom: 6px !important;
            }
            
            .modal-content[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: 6px !important;
            }
            
            .modal-content div[style*="minmax(350px"] {
                grid-template-columns: 1fr !important;
            }

            .modal-body {
                padding: 20px;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .form-group input {
                padding: 10px;
                font-size: 14px;
            }

            .modal-footer {
                padding: 15px 20px;
                flex-direction: row;
                justify-content: space-between;
                gap: 15px;
            }

            .modal-footer .btn {
                flex: 1;
                margin: 0;
            }

            .empty-state {
                padding: 40px 15px;
            }

            .empty-state-icon {
                font-size: 3rem;
                margin-bottom: 15px;
            }

            .empty-state h3 {
                font-size: 1.1rem;
                margin-bottom: 8px;
            }

            .empty-state p {
                font-size: 0.9rem;
            }
            
            /* 모바일에서 날짜 위치 조정 */
            .match-date-mobile {
                display: block !important;
            }
            
            .match-date-desktop {
                display: none !important;
            }
            
            /* 모바일 페이지네이션 */
            .pagination {
                gap: 5px;
                margin: 20px 0;
                padding: 15px;
                flex-wrap: wrap;
            }
            
            .pagination-btn {
                padding: 6px 10px;
                font-size: 13px;
                min-width: 32px;
            }
            
            .pagination-info {
                font-size: 12px;
                margin: 5px 10px;
                width: 100%;
                text-align: center;
                order: 10;
            }
        }

        /* Small Mobile (iPhone SE, etc.) */
        @media (max-width: 375px) {
            .header h1 {
                font-size: 1.3rem;
            }

            .btn {
                min-width: 100px;
                font-size: 11px;
                padding: 8px 10px;
            }

            .score {
                font-size: 1.3rem;
            }

            .team-name {
                font-size: 0.85rem;
            }

            .team-vs {
                gap: 5px;
            }

            .vs-badge {
                padding: 2px 5px;
                font-size: 9px;
            }
        }

        /* 토글 스위치 스타일 */
        .toggle-switch input:checked + span {
            background-color: #4f46e5 !important;
        }
        
        .toggle-switch input:checked + span + span {
            transform: translateX(22px);
        }
        
        .toggle-switch input:not(:checked) + span {
            background-color: #cbd5e1 !important;
        }
        
        .toggle-switch input:not(:checked) + span + span {
            transform: translateX(4px);
        }
        
        @media (max-width: 768px) {
            .toolbar > div {
                flex-direction: column;
                gap: 15px;
            }
            
            /* 모바일에서 토글 영역 개선 */
            .toggle-container {
                gap: 10px !important;
            }
            
            .toggle-switch-wrapper {
                padding: 8px 12px !important;
                font-size: 13px !important;
            }
            
            .toggle-switch-wrapper label {
                font-size: 13px !important;
            }
            
            .toggle-switch-wrapper span {
                font-size: 13px !important;
            }
            
            /* 개인 승점 탭에서 경기 유형 줄바꿈 처리 */
            .match-types {
                flex-wrap: wrap !important;
            }
            
            /* 경기 유형 아이템이 2개까지는 한 줄, 3개부터는 줄바꿈 */
            .match-type-item {
                flex: 0 0 auto;
                min-width: 45%;
            }
            
            /* 경기 유형이 3개 이상일 때 자동 줄바꿈 */
            .match-types .match-type-item:nth-child(n+3) {
                margin-top: 4px;
            }
        }

        /* 플로팅 검색 버튼 스타일 */
        .player-search-fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2c5f2d 0%, #1a3a1b 100%);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(44, 95, 45, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transform: scale(0);
            opacity: 0;
            visibility: hidden;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.3s ease,
                        visibility 0.3s ease;
        }

        .player-search-fab.visible {
            transform: scale(1);
            opacity: 1;
            visibility: visible;
        }

        .player-search-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(44, 95, 45, 0.5);
        }

        .player-search-fab svg {
            width: 24px;
            height: 24px;
        }

        /* 검색창 컨테이너 */
        .player-search-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 28px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            padding: 8px 12px;
            z-index: 1001;
            height: 56px;
            width: 56px;
            overflow: hidden;
            visibility: hidden;
            opacity: 0;
            /* 닫힐 때: 내부 사라짐 대기 → width 접힘 → 완전히 사라짐 */
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1) 0.1s,
                        opacity 0.1s ease 0.35s,
                        visibility 0.1s ease 0.35s;
        }

        .player-search-container.active {
            width: 320px;
            opacity: 1;
            visibility: visible;
            overflow: visible;
            /* 열릴 때: 바로 나타나고, width 펼쳐짐 */
            transition: width 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.1s ease,
                        visibility 0.1s ease;
        }

        /* 검색창 내부 요소들 */
        .player-search-container .player-search-input-wrapper,
        .player-search-container .player-search-close {
            opacity: 0;
            /* 닫힐 때: 빠르게 사라짐 */
            transition: opacity 0.1s ease;
        }

        .player-search-container.active .player-search-input-wrapper,
        .player-search-container.active .player-search-close {
            opacity: 1;
            /* 열릴 때: 펼쳐진 후 나타남 */
            transition: opacity 0.2s ease 0.25s;
        }

        .player-search-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2c5f2d 0%, #1a3a1b 100%);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .player-search-btn:hover {
            background: linear-gradient(135deg, #3a7a3b 0%, #2c5f2d 100%);
        }

        .player-search-btn svg {
            width: 18px;
            height: 18px;
        }

        .player-search-input-wrapper {
            flex: 1;
            position: relative;
            margin: 0 10px;
        }

        .player-search-input {
            width: 100%;
            padding: 10px 12px;
            border: none;
            border-radius: 20px;
            background: #f5f5f5;
            font-size: 14px;
            outline: none;
            transition: background 0.2s ease;
        }

        .player-search-input:focus {
            background: #eeeeee;
        }

        .player-search-input::placeholder {
            color: #999;
        }

        .player-search-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f0f0f0;
            color: #666;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .player-search-close:hover {
            background: #e0e0e0;
            color: #333;
        }

        .player-search-close svg {
            width: 18px;
            height: 18px;
        }

        /* 최근 검색 드롭다운 */
        .recent-search-dropdown {
            position: absolute;
            bottom: calc(100% + 15px);
            left: -52px;
            right: -48px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.15);
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
            z-index: 1003;
            max-height: 250px;
            overflow-y: auto;
        }

        .recent-search-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .recent-search-header {
            padding: 10px 14px;
            font-size: 12px;
            color: #888;
            background: #f8f8f8;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s ease;
        }

        .recent-search-header:hover {
            background: #f0f0f0;
        }

        .recent-search-header .toggle-arrow {
            width: 16px;
            height: 16px;
            transition: transform 0.3s ease;
        }

        .recent-search-dropdown.collapsed .recent-search-header .toggle-arrow {
            transform: rotate(180deg);
        }

        .recent-search-dropdown.collapsed #recentSearchList {
            display: none;
        }

        .recent-search-dropdown.collapsed {
            border-radius: 12px;
        }

        .recent-search-dropdown.collapsed .recent-search-header {
            border-bottom: none;
            border-radius: 12px;
        }

        .recent-search-item {
            padding: 12px 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s ease;
        }

        .recent-search-item:hover {
            background: #f5f5f5;
        }

        .recent-search-item svg {
            width: 16px;
            height: 16px;
            color: #999;
            flex-shrink: 0;
        }

        .recent-search-item span {
            flex: 1;
            font-size: 14px;
            color: #333;
        }

        .recent-search-item .remove-recent {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            transition: all 0.2s ease;
        }

        .recent-search-item .remove-recent:hover {
            background: #e0e0e0;
            color: #666;
        }

        /* 검색 결과 하이라이트 */
        .ranking-item.search-highlight {
            animation: highlightPulse 2s ease-in-out;
            box-shadow: 0 0 0 3px #2c5f2d;
        }

        @keyframes highlightPulse {
            0%, 100% { box-shadow: 0 0 0 3px #2c5f2d; }
            50% { box-shadow: 0 0 0 6px rgba(44, 95, 45, 0.3); }
        }

        /* 태블릿 검색창 조정 */
        @media (max-width: 768px) {
            .player-search-container.active {
                width: min(320px, calc(100vw - 40px));
            }
        }

        /* 모바일 검색창 조정 */
        @media (max-width: 480px) {
            .player-search-fab {
                right: 15px;
                bottom: 15px;
                width: 50px;
                height: 50px;
            }

            .player-search-container {
                right: 15px;
                bottom: 15px;
                height: 50px;
                width: 50px;
            }

            .player-search-container.active {
                width: calc(100vw - 30px);
            }

            .player-search-btn {
                width: 36px;
                height: 36px;
            }

            .player-search-close {
                width: 32px;
                height: 32px;
            }

            .player-search-input {
                padding: 8px 10px;
                font-size: 14px;
            }
        }

        /* 아주 작은 화면 */
        @media (max-width: 360px) {
            .player-search-fab {
                right: 10px;
                bottom: 10px;
                width: 46px;
                height: 46px;
            }

            .player-search-container {
                right: 10px;
                bottom: 10px;
                height: 46px;
                width: 46px;
            }

            .player-search-container.active {
                width: calc(100vw - 20px);
            }

            .player-search-input-wrapper {
                margin: 0 6px;
            }
        }

        /* 검색 필터 배지 - 돋보기 버튼 위 */
        .search-filter-badge {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: linear-gradient(135deg, #2c5f2d 0%, #1a3a1b 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(44, 95, 45, 0.4);
            z-index: 1002;
            font-size: 14px;
            font-weight: 500;
            animation: badgeSlideUp 0.3s ease;
        }

        @keyframes badgeSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .search-filter-badge span {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .search-filter-badge button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            transition: background 0.2s ease;
        }

        .search-filter-badge button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* 경기 기록 검색 결과 하이라이트 */
        .match-item.search-highlight {
            animation: matchHighlightPulse 2s ease-in-out;
            box-shadow: 0 0 0 3px #2c5f2d !important;
        }

        @keyframes matchHighlightPulse {
            0%, 100% { box-shadow: 0 0 0 3px #2c5f2d !important; }
            50% { box-shadow: 0 0 0 6px rgba(44, 95, 45, 0.3) !important; }
        }

        /* 검색된 이름 하이라이트 */
        .name-highlight {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
            color: #856404;
            padding: 1px 4px;
            border-radius: 4px;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* 검색 결과 없음 메시지 */
        .no-search-results {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .no-search-results .icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .no-search-results p {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .no-search-results .hint {
            font-size: 14px;
            color: #999;
        }

        @media (max-width: 480px) {
            .search-filter-badge {
                bottom: 85px;
                right: 16px;
                padding: 6px 12px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <!-- 로딩 오버레이 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-modal">
            <div class="loading-spinner"></div>
            <div class="loading-progress">
                <div class="loading-progress-bar" id="loadingProgressBar"></div>
            </div>
            <div class="loading-text" id="loadingText">데이터 로딩 중...</div>
            <div class="loading-subtext" id="loadingSubtext">잠시만 기다려주세요</div>
            <div class="loading-percentage" id="loadingPercentage">0%</div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>🏆 현클럽 배틀 아레나</h1>
            <p>치열한 경기의 순간들을 기록하세요! 🔥</p>
        </div>

        <!-- 탭 네비게이션 -->
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('matches')" id="matchesTab">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 0a8 8 0 110 16A8 8 0 018 0zM1.5 8a6.5 6.5 0 1113 0 6.5 6.5 0 01-13 0z"/>
                    <path d="M8 3.5a4.5 4.5 0 100 9 4.5 4.5 0 000-9z"/>
                </svg>
                경기기록
            </button>
            <button class="tab-btn" onclick="switchTab('rankings')" id="rankingsTab">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M7.5 3.5c0-1.105.895-2 2-2s2 .895 2 2-2 4.5-2 4.5S7.5 4.605 7.5 3.5z"/>
                    <path d="M2.5 6.5c0-1.105.895-2 2-2s2 .895 2 2-2 4.5-2 4.5S2.5 7.605 2.5 6.5z"/>
                    <path d="M12.5 6.5c0-1.105.895-2 2-2s2 .895 2 2-2 4.5-2 4.5s-2-3.395-2-4.5z"/>
                    <path d="M0 13h16v3H0z"/>
                </svg>
                개인승점
            </button>
            <button class="tab-btn" onclick="switchTab('clubstats')" id="clubstatsTab">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M1.5 14h13v-1h-13v1zm0-2h13v-1h-13v1zm0-2h13v-1h-13v1z"/>
                    <path d="M3 9V3h2v6H3zm3-4v4h2V5H6zm3-2v6h2V3H9zm3 4v2h2V7h-2z"/>
                </svg>
                클럽통계
            </button>
        </div>

        <!-- 경기기록 탭 (홈) -->
        <div id="matchesContent" class="tab-content active">
            <div class="toolbar">
                <div style="width: 100%; display: flex; justify-content: center;">
                    <button class="btn" onclick="showAddModal()" style="padding: 15px 30px; font-size: 16px; font-weight: 600; background: linear-gradient(135deg, #2c5f2d 0%, #1a3a1b 100%); box-shadow: 0 4px 15px rgba(44, 95, 45, 0.3);">
                        <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8 0a1 1 0 011 1v6h6a1 1 0 110 2H9v6a1 1 0 11-2 0V9H1a1 1 0 010-2h6V1a1 1 0 011-1z"/>
                        </svg>
                        경기 기록 추가
                    </button>
                </div>
        </div>

            <div class="main-content">
                <div id="matchesContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">🏆</div>
                        <h3>등록된 경기 기록이 없습니다</h3>
                        <p>새로운 경기 기록을 추가해보세요!</p>
                    </div>
                </div>
                
                <!-- 엑셀 내보내기 버튼 하단 위치 -->
                <div class="toggle-container" style="display: flex; justify-content: space-between; align-items: center; gap: 20px; margin: 40px 0 20px 0; padding-top: 30px; border-top: 1px solid #e5e7eb; flex-wrap: nowrap;">
                    <button class="btn btn-secondary" onclick="exportToExcel()" style="padding: 12px 24px;">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8.5 1.5A1.5 1.5 0 0110 0h4a2 2 0 012 2v12a2 2 0 01-2 2H2a2 2 0 01-2-2V2a2 2 0 012-2h4a1.5 1.5 0 011.5 1.5v1a.5.5 0 001 0v-1z"/>
                            <path d="M8 16L4 12h3V4h2v8h3l-4 4z"/>
                        </svg>
                        엑셀 내보내기
                    </button>
                    <div class="toggle-switch-wrapper" style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                        <label style="font-size: 14px; color: #6b7280; margin: 0;">표시 범위:</label>
                        <label class="toggle-switch" style="position: relative; display: inline-block; width: 50px; height: 28px;">
                            <input type="checkbox" id="showAllRecords" checked onchange="toggleDataRange()" style="opacity: 0; width: 0; height: 0;">
                            <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #4f46e5; transition: 0.4s; border-radius: 28px;"></span>
                            <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%;"></span>
                        </label>
                        <span id="rangeLabel" style="font-size: 14px; color: #374151; font-weight: 500;">최근 2년</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 개인 승점 탭 -->
        <div id="rankingsContent" class="tab-content">
            <div class="ranking-header">
                <!-- 필터 버튼들을 한 줄에 표시 -->
                <div style="display: flex; align-items: center; gap: 3px; margin-bottom: 15px; width: 100%;">
                    <div style="display: flex; gap: 3px; flex: 1; max-width: 120px;">
                        <button class="period-filter-btn" onclick="filterByPeriod('전체')">전체</button>
                        <button class="period-filter-btn active" onclick="filterByPeriod('이번달')">이번달</button>
                    </div>
                    <span style="width: 1px; height: 16px; background: #d1d5db; margin: 0 5px; flex-shrink: 0;"></span>
                    <div style="display: flex; gap: 3px; flex: 2;">
                        <button class="type-filter-btn active" onclick="filterByType('전체')">전체</button>
                        <button class="type-filter-btn" onclick="filterByType('남복')">남복</button>
                        <button class="type-filter-btn" onclick="filterByType('여복')">여복</button>
                        <button class="type-filter-btn" onclick="filterByType('혼복')">혼복</button>
                        <button class="type-filter-btn" onclick="filterByType('단식')">단식</button>
                    </div>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; max-width: 500px; margin-left: auto; margin-right: auto;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 25px;">
                        <span style="display: flex; align-items: center; gap: 5px;">
                            <span style="font-size: 14px; font-weight: bold; color: #28a745;">승리:</span>
                            <span style="font-size: 14px; font-weight: bold; color: #28a745;">3점</span>
                        </span>
                        <span style="display: flex; align-items: center; gap: 5px;">
                            <span style="font-size: 14px; font-weight: bold; color: #6c757d;">무승부:</span>
                            <span style="font-size: 14px; font-weight: bold; color: #6c757d;">1점</span>
                        </span>
                        <span style="display: flex; align-items: center; gap: 5px;">
                            <span style="font-size: 14px; font-weight: bold; color: #dc3545;">패배:</span>
                            <span style="font-size: 14px; font-weight: bold; color: #dc3545;">-1점</span>
                        </span>
                    </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #dee2e6; font-size: 13px; color: #6c757d;">
                        <div>• 단식/복식 구분 없이 동일한 점수 적용</div>
                        <div>• 팀 경기에서도 개인별로 점수 획득</div>
                        <div>• 플레이어 이름을 클릭하면 개인 통계를 확인할 수 있습니다</div>
                    </div>
                </div>
            </div>
            <div id="rankingsContainer">
                <div class="empty-ranking">
                    <svg width="64" height="64" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M7.5 3.5c0-1.105.895-2 2-2s2 .895 2 2-2 4.5-2 4.5S7.5 4.605 7.5 3.5z"/>
                        <path d="M2.5 6.5c0-1.105.895-2 2-2s2 .895 2 2-2 4.5-2 4.5S2.5 7.605 2.5 6.5z"/>
                        <path d="M12.5 6.5c0-1.105.895-2 2-2s2 .895 2 2-2 4.5-2 4.5s-2-3.395-2-4.5z"/>
                        <path d="M0 13h16v3H0z"/>
                    </svg>
                    <h3>등록된 경기가 없습니다</h3>
                    <p>경기 기록을 추가하면 개인별 승점이 계산됩니다</p>
                </div>
            </div>
        </div>

        <!-- 클럽 통계 탭 -->
        <div id="clubstatsContent" class="tab-content">
            
            <!-- 클럽 통계 필터 -->
            <div style="margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; justify-content: center; align-items: center;">
                    <button id="clubStatsPeriodAll" class="filter-btn period-filter" onclick="setClubStatsPeriod('all')" style="padding: 8px 24px; min-width: 80px; font-size: 12px !important;">전체</button>
                    <button id="clubStatsPeriodMonth" class="filter-btn period-filter active" onclick="setClubStatsPeriod('month')" style="padding: 8px 24px; min-width: 80px; font-size: 12px !important;">이번달</button>
                </div>
            </div>
            
            <div id="clubStatsContainer">
                <div class="empty-stats" style="text-align: center; padding: 60px 20px; color: #6b7280;">
                    <div style="font-size: 64px; margin-bottom: 20px;">📈</div>
                    <h3>클럽 통계를 준비하고 있습니다</h3>
                    <p>경기 기록이 쌓이면 클럽 전체 통계를 확인할 수 있습니다</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="matchModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">경기 기록 추가</h3>
                <button class="modal-close" onclick="hideModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="matchForm">
                    <div class="form-group">
                        <label>타이틀</label>
                        <div class="match-type-group" style="display: flex; gap: 10px; margin-top: 10px;">
                            <label class="match-type-label selected" id="titleFriendlyLabel">
                                <input type="radio" name="matchTitle" value="친선" id="titleFriendly" checked>
                                <span class="type-label-text">친선</span>
                            </label>
                            <label class="match-type-label" id="titleRivalLabel">
                                <input type="radio" name="matchTitle" value="라이벌" id="titleRival">
                                <span class="type-label-text">라이벌</span>
                            </label>
                            <label class="match-type-label" id="titleWarmupLabel">
                                <input type="radio" name="matchTitle" value="몸풀기" id="titleWarmup">
                                <span class="type-label-text">몸풀기</span>
                            </label>
                            <label class="match-type-label" id="titleMonthlyLabel">
                                <input type="radio" name="matchTitle" value="월례대회" id="titleMonthly">
                                <span class="type-label-text">월례대회</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group" id="dateTimeGroup" style="display: none;">
                        <label for="matchDateTime">경기 일시</label>
                        <input type="datetime-local" id="matchDateTime">
                    </div>
                    <div class="form-group">
                        <label>경기 유형</label>
                        <div class="match-type-group">
                            <label class="match-type-label selected" id="menDoublesLabel">
                                <input type="radio" name="matchType" value="남복" id="menDoubles" checked>
                                <span class="type-label-text">남복</span>
                            </label>
                            <label class="match-type-label" id="womenDoublesLabel">
                                <input type="radio" name="matchType" value="여복" id="womenDoubles">
                                <span class="type-label-text">여복</span>
                            </label>
                            <label class="match-type-label" id="mixedDoublesLabel">
                                <input type="radio" name="matchType" value="혼복" id="mixedDoubles">
                                <span class="type-label-text">혼복</span>
                            </label>
                            <label class="match-type-label" id="singlesLabel">
                                <input type="radio" name="matchType" value="단식" id="singles">
                                <span class="type-label-text">단식</span>
                            </label>
                        </div>
                    </div>
                    <!-- 월례대회 경기 번호 선택 (기본 숨김) -->
                    <div class="form-group" id="matchNumberGroup" style="display: none;">
                        <label>경기 번호</label>
                        <div class="match-type-group" style="display: flex; gap: 10px; margin-top: 10px;">
                            <label class="match-type-label selected" id="match1Label">
                                <input type="radio" name="matchNumber" value="1경기" id="match1" checked>
                                <span class="type-label-text">1경기</span>
                            </label>
                            <label class="match-type-label" id="match2Label">
                                <input type="radio" name="matchNumber" value="2경기" id="match2">
                                <span class="type-label-text">2경기</span>
                            </label>
                            <label class="match-type-label" id="match3Label">
                                <input type="radio" name="matchNumber" value="3경기" id="match3">
                                <span class="type-label-text">3경기</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label id="teamALabel">팀 A 이름/점수</label>
                        <div style="display: flex; gap: 10px;">
                            <div class="player-input-wrapper" style="flex: 1;">
                                <input type="text" id="teamA1" placeholder="선수1" style="width: 100%;" autocomplete="off">
                                <div id="autocompleteA1" class="autocomplete-dropdown"></div>
                            </div>
                            <div class="player-input-wrapper" style="flex: 1;">
                                <input type="text" id="teamA2" placeholder="선수2 (복식)" style="width: 100%;" autocomplete="off">
                                <div id="autocompleteA2" class="autocomplete-dropdown"></div>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <div class="score-container">
                                <div class="score-display" id="scoreADisplay">0</div>
                                <div class="score-buttons">
                                    <button type="button" class="score-button" onclick="setScore('A', 1)">1</button>
                                    <button type="button" class="score-button" onclick="setScore('A', 2)">2</button>
                                    <button type="button" class="score-button" onclick="setScore('A', 3)">3</button>
                                    <button type="button" class="score-button" onclick="setScore('A', 4)">4</button>
                                    <button type="button" class="score-button" onclick="setScore('A', 5)">5</button>
                                    <button type="button" class="score-button" onclick="setScore('A', 6)">6</button>
                                </div>
                                <button type="button" class="score-clear-button" onclick="clearScore('A')">↻</button>
                            </div>
                            <input type="hidden" id="scoreA" min="0" value="0" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label id="teamBLabel">팀 B 이름/점수</label>
                        <div style="display: flex; gap: 10px;">
                            <div class="player-input-wrapper" style="flex: 1;">
                                <input type="text" id="teamB1" placeholder="선수1" style="width: 100%;" autocomplete="off">
                                <div id="autocompleteB1" class="autocomplete-dropdown"></div>
                            </div>
                            <div class="player-input-wrapper" style="flex: 1;">
                                <input type="text" id="teamB2" placeholder="선수2 (복식)" style="width: 100%;" autocomplete="off">
                                <div id="autocompleteB2" class="autocomplete-dropdown"></div>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <div class="score-container">
                                <div class="score-display" id="scoreBDisplay">0</div>
                                <div class="score-buttons">
                                    <button type="button" class="score-button" onclick="setScore('B', 1)">1</button>
                                    <button type="button" class="score-button" onclick="setScore('B', 2)">2</button>
                                    <button type="button" class="score-button" onclick="setScore('B', 3)">3</button>
                                    <button type="button" class="score-button" onclick="setScore('B', 4)">4</button>
                                    <button type="button" class="score-button" onclick="setScore('B', 5)">5</button>
                                    <button type="button" class="score-button" onclick="setScore('B', 6)">6</button>
                                </div>
                                <button type="button" class="score-clear-button" onclick="clearScore('B')">↻</button>
                            </div>
                            <input type="hidden" id="scoreB" min="0" value="0" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="saveMatch()">저장</button>
                <button class="btn btn-secondary" onclick="hideModal()">취소</button>
                <button class="btn btn-danger" id="deleteBtn" onclick="deleteMatch()" style="display: none;">삭제</button>
            </div>
        </div>
    </div>

    <!-- 경기 기록 검색 플로팅 버튼 -->
    <button class="player-search-fab" id="matchSearchFab" onclick="openMatchSearch()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="M21 21l-4.35-4.35"/>
        </svg>
    </button>

    <!-- 경기 기록 검색창 -->
    <div class="player-search-container" id="matchSearchContainer">
        <button class="player-search-btn" onclick="executeMatchSearch()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="M21 21l-4.35-4.35"/>
            </svg>
        </button>
        <div class="player-search-input-wrapper">
            <input type="text" class="player-search-input" id="matchSearchInput"
                   placeholder="선수 검색"
                   onfocus="showMatchRecentSearches()"
                   onkeyup="handleMatchSearchKeyup(event)">
            <div class="recent-search-dropdown" id="matchRecentSearchDropdown">
                <div class="recent-search-header" onclick="toggleMatchRecentSearchList(event)">
                    <span>최근 검색</span>
                    <svg class="toggle-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                </div>
                <div id="matchRecentSearchList"></div>
            </div>
        </div>
        <button class="player-search-close" onclick="closeMatchSearch()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
        </button>
    </div>

    <!-- 검색 필터 표시 배지 -->
    <div class="search-filter-badge" id="searchFilterBadge" style="display: none;">
        <span id="searchFilterName"></span>
        <button onclick="clearMatchSearchFilter()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
        </button>
    </div>

    <!-- 플레이어 검색 플로팅 버튼 (개인승점 탭) -->
    <button class="player-search-fab" id="playerSearchFab" onclick="openPlayerSearch()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="M21 21l-4.35-4.35"/>
        </svg>
    </button>

    <!-- 플레이어 검색창 (개인승점 탭) -->
    <div class="player-search-container" id="playerSearchContainer">
        <button class="player-search-btn" onclick="executePlayerSearch()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="M21 21l-4.35-4.35"/>
            </svg>
        </button>
        <div class="player-search-input-wrapper">
            <input type="text" class="player-search-input" id="playerSearchInput"
                   placeholder="선수 검색"
                   onfocus="showRecentSearches()"
                   onkeyup="handleSearchKeyup(event)">
            <div class="recent-search-dropdown" id="recentSearchDropdown">
                <div class="recent-search-header" onclick="toggleRecentSearchList(event)">
                    <span>최근 검색</span>
                    <svg class="toggle-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                </div>
                <div id="recentSearchList"></div>
            </div>
        </div>
        <button class="player-search-close" onclick="closePlayerSearch()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
        </button>
    </div>

    <script>
        // Global variables
        let matches = [];
        let editingIndex = -1;
        let currentFilter = '전체'; // 현재 필터 상태
        let currentPage = 1;
        let matchesPerPage = 10;
        let isDeleting = false; // 삭제 중 플래그 (전역 변수)

        // 플레이어 검색 관련 변수
        const RECENT_SEARCHES_KEY = 'recentPlayerSearches';
        const MAX_STORED_SEARCHES = 50;  // 저장 최대 개수
        const DISPLAY_RECENT_SEARCHES = 5;  // 표시 최대 개수
        let isProcessingRecentSearch = false;  // 최근 검색 처리 중 플래그

        // 경기 기록 검색 관련 변수
        const MATCH_RECENT_SEARCHES_KEY = 'recentMatchSearches';
        let currentMatchSearchFilter = '';  // 현재 검색 필터
        let isProcessingMatchRecentSearch = false;

        // 경기 기록 검색 FAB 표시/숨기기 (경기 기록 탭에서만)
        function updateMatchSearchFabVisibility() {
            const fab = document.getElementById('matchSearchFab');
            const container = document.getElementById('matchSearchContainer');
            const badge = document.getElementById('searchFilterBadge');
            const matchesTab = document.getElementById('matchesTab');
            const isMatchesTabActive = matchesTab && matchesTab.classList.contains('active');

            if (fab) {
                if (isMatchesTabActive && !container?.classList.contains('active')) {
                    fab.classList.add('visible');
                } else {
                    fab.classList.remove('visible');
                }
            }

            // 배지도 경기기록 탭에서만 표시
            if (badge && currentMatchSearchFilter) {
                badge.style.display = isMatchesTabActive ? 'flex' : 'none';
            }
        }

        // 경기 기록 검색창 열기
        function openMatchSearch() {
            const fab = document.getElementById('matchSearchFab');
            const container = document.getElementById('matchSearchContainer');
            const input = document.getElementById('matchSearchInput');

            if (fab) fab.classList.remove('visible');

            setTimeout(() => {
                if (container) {
                    container.classList.add('active');
                    // 키보드 높이 즉시 적용
                    updateSearchContainerPosition('matchSearchContainer');

                    // 애니메이션 후 검색 이력 표시 및 포커스
                    setTimeout(() => {
                        if (input) {
                            showMatchRecentSearches();
                            // 포커스는 검색 이력 표시 후에
                            setTimeout(() => {
                                input.focus();
                            }, 50);
                        }
                    }, 350);
                }
            }, 150);
        }

        // 경기 기록 검색창 닫기
        function closeMatchSearch() {
            const fab = document.getElementById('matchSearchFab');
            const container = document.getElementById('matchSearchContainer');
            const dropdown = document.getElementById('matchRecentSearchDropdown');
            const input = document.getElementById('matchSearchInput');

            if (dropdown) dropdown.classList.remove('show');
            if (container) container.classList.remove('active');
            if (input) input.value = '';

            setTimeout(() => {
                if (fab) {
                    fab.style.transition = 'none';
                    updateMatchSearchFabVisibility();
                    requestAnimationFrame(() => {
                        fab.style.transition = '';
                    });
                }
            }, 450);
        }

        // 경기 기록 검색 실행
        function executeMatchSearch() {
            const input = document.getElementById('matchSearchInput');
            const searchName = input?.value.trim();

            if (!searchName) return;

            // 검색 기록 저장
            saveMatchRecentSearch(searchName);

            // 필터 적용
            currentMatchSearchFilter = searchName;

            // 배지 표시 (건수는 renderFilteredMatches에서 업데이트)
            const badge = document.getElementById('searchFilterBadge');
            if (badge) {
                badge.style.display = 'flex';
            }

            // 검색창 닫기
            closeMatchSearch();

            // 경기 목록 다시 렌더링
            renderFilteredMatches();
        }

        // 이름 하이라이트 적용 함수
        function highlightName(text, searchName) {
            if (!text || !searchName) return text || '';
            const regex = new RegExp(`(${searchName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<span class="name-highlight">$1</span>');
        }

        // 필터링된 경기 목록 렌더링
        function renderFilteredMatches() {
            if (!currentMatchSearchFilter) {
                // 직접 렌더링 (무한 루프 방지)
                renderMatchesWithoutFilter();
                return;
            }

            const searchName = currentMatchSearchFilter.toLowerCase();
            const container = document.getElementById('matchesContainer');

            // 최신 경기가 위로 오도록 정렬
            const sortedMatches = [...matches].sort((a, b) => b.timestamp - a.timestamp);

            // 검색 필터 적용 - 해당 이름이 포함된 경기만
            const searchFilteredMatches = sortedMatches.filter(match => {
                const teamA = ((match.teamA1 || '') + ' ' + (match.teamA2 || '') + ' ' + (match.teamA || '')).toLowerCase();
                const teamB = ((match.teamB1 || '') + ' ' + (match.teamB2 || '') + ' ' + (match.teamB || '')).toLowerCase();
                return teamA.includes(searchName) || teamB.includes(searchName);
            });

            if (searchFilteredMatches.length === 0) {
                container.innerHTML = `
                    <div class="no-search-results">
                        <div class="icon">🔍</div>
                        <p>"${currentMatchSearchFilter}" 선수의 경기 기록이 없습니다</p>
                        <div class="hint">다른 이름으로 검색해보세요</div>
                    </div>
                `;
                return;
            }

            // 페이지네이션 적용
            const totalPages = Math.ceil(searchFilteredMatches.length / matchesPerPage);
            if (currentPage > totalPages) currentPage = totalPages;

            const startIndex = (currentPage - 1) * matchesPerPage;
            const endIndex = startIndex + matchesPerPage;
            const pageMatches = searchFilteredMatches.slice(startIndex, endIndex);

            // 원본 matches 배열에서의 인덱스 찾기 (하이라이트 적용)
            const matchesHTML = pageMatches.map(match => {
                const originalIndex = matches.findIndex(m => m.timestamp === match.timestamp);
                return createMatchCard(match, originalIndex, currentMatchSearchFilter);
            }).join('');

            // 페이지네이션 HTML
            let paginationHTML = '';
            if (totalPages > 1) {
                paginationHTML = '<div class="pagination">';
                if (currentPage > 1) {
                    paginationHTML += `<button onclick="goToSearchPage(${currentPage - 1})">이전</button>`;
                }
                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                        paginationHTML += `<button class="${i === currentPage ? 'active' : ''}" onclick="goToSearchPage(${i})">${i}</button>`;
                    } else if (i === currentPage - 3 || i === currentPage + 3) {
                        paginationHTML += '<span>...</span>';
                    }
                }
                if (currentPage < totalPages) {
                    paginationHTML += `<button onclick="goToSearchPage(${currentPage + 1})">다음</button>`;
                }
                paginationHTML += '</div>';
            }

            container.innerHTML = `
                <div class="matches-list">
                    ${matchesHTML}
                </div>
                ${paginationHTML}
            `;

            // 플로팅 배지에 건수 업데이트
            const badgeName = document.getElementById('searchFilterName');
            if (badgeName) {
                badgeName.textContent = `🔍 ${currentMatchSearchFilter} ${searchFilteredMatches.length}건`;
            }
        }

        // 필터 없이 경기 목록 렌더링 (내부용)
        function renderMatchesWithoutFilter() {
            const container = document.getElementById('matchesContainer');

            if (matches.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🏆</div>
                        <h3>등록된 경기 기록이 없습니다</h3>
                        <p>새로운 경기 기록을 추가해보세요!</p>
                    </div>
                `;
            } else {
                const sortedMatches = [...matches].sort((a, b) => b.timestamp - a.timestamp);
                const totalPages = Math.ceil(sortedMatches.length / matchesPerPage);
                const startIndex = (currentPage - 1) * matchesPerPage;
                const endIndex = startIndex + matchesPerPage;
                const currentMatches = sortedMatches.slice(startIndex, endIndex);

                const matchesHTML = currentMatches.map((match, index) => {
                    const originalIndex = matches.findIndex(m => m.timestamp === match.timestamp);
                    return createMatchCard(match, originalIndex);
                }).join('');

                let paginationHTML = '';
                if (totalPages > 1) {
                    paginationHTML = '<div class="pagination">';
                    if (currentPage > 1) {
                        paginationHTML += `<button onclick="changePage(${currentPage - 1})">이전</button>`;
                    }
                    for (let i = 1; i <= totalPages; i++) {
                        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                            paginationHTML += `<button class="${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                        } else if (i === currentPage - 3 || i === currentPage + 3) {
                            paginationHTML += '<span>...</span>';
                        }
                    }
                    if (currentPage < totalPages) {
                        paginationHTML += `<button onclick="changePage(${currentPage + 1})">다음</button>`;
                    }
                    paginationHTML += '</div>';
                }

                container.innerHTML = `
                    <div class="matches-header">
                        <span>총 ${sortedMatches.length}건의 경기 기록</span>
                    </div>
                    <div class="matches-list">
                        ${matchesHTML}
                    </div>
                    ${paginationHTML}
                `;
            }
        }

        // 검색용 페이지네이션 렌더링
        function renderSearchPagination(totalMatches, totalPages) {
            const pagination = document.getElementById('pagination');
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '<div class="pagination">';

            if (currentPage > 1) {
                html += `<button onclick="goToSearchPage(${currentPage - 1})">이전</button>`;
            }

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<button class="${i === currentPage ? 'active' : ''}" onclick="goToSearchPage(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += '<span>...</span>';
                }
            }

            if (currentPage < totalPages) {
                html += `<button onclick="goToSearchPage(${currentPage + 1})">다음</button>`;
            }

            html += '</div>';
            pagination.innerHTML = html;
        }

        // 검색 결과 페이지 이동
        function goToSearchPage(page) {
            currentPage = page;
            renderFilteredMatches();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 검색 필터 해제
        function clearMatchSearchFilter() {
            currentMatchSearchFilter = '';
            currentPage = 1;

            const badge = document.getElementById('searchFilterBadge');
            if (badge) badge.style.display = 'none';

            const input = document.getElementById('matchSearchInput');
            if (input) input.value = '';

            renderMatches();
        }

        // 경기 기록 검색 키 입력 처리
        function handleMatchSearchKeyup(event) {
            if (event.key === 'Enter') {
                executeMatchSearch();
            } else if (event.key === 'Escape') {
                closeMatchSearch();
            }
        }

        // 경기 기록 최근 검색 기록 가져오기
        function getMatchRecentSearches() {
            try {
                const searches = localStorage.getItem(MATCH_RECENT_SEARCHES_KEY);
                return searches ? JSON.parse(searches) : [];
            } catch (e) {
                return [];
            }
        }

        // 경기 기록 최근 검색 기록 저장
        function saveMatchRecentSearch(name) {
            if (!name || name.trim() === '') return;

            let searches = getMatchRecentSearches();
            searches = searches.filter(s => s !== name);
            searches.unshift(name);
            if (searches.length > MAX_STORED_SEARCHES) {
                searches = searches.slice(0, MAX_STORED_SEARCHES);
            }

            try {
                localStorage.setItem(MATCH_RECENT_SEARCHES_KEY, JSON.stringify(searches));
            } catch (e) {
                console.error('검색 기록 저장 실패:', e);
            }
        }

        // 경기 기록 최근 검색 기록 삭제
        function removeMatchRecentSearch(name) {
            let searches = getMatchRecentSearches();
            searches = searches.filter(s => s !== name);
            localStorage.setItem(MATCH_RECENT_SEARCHES_KEY, JSON.stringify(searches));
            showMatchRecentSearches();
        }

        // 경기 기록 최근 검색 목록 접기/펼치기
        function toggleMatchRecentSearchList(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('matchRecentSearchDropdown');
            if (dropdown) {
                dropdown.classList.toggle('collapsed');
            }
        }

        // 경기 기록 최근 검색 목록 표시
        function showMatchRecentSearches() {
            const dropdown = document.getElementById('matchRecentSearchDropdown');
            const list = document.getElementById('matchRecentSearchList');
            const searches = getMatchRecentSearches();

            if (!dropdown || !list) return;

            if (searches.length === 0) {
                dropdown.classList.remove('show');
                return;
            }

            const displaySearches = searches.slice(0, DISPLAY_RECENT_SEARCHES);

            list.innerHTML = displaySearches.map((name, index) => `
                <div class="recent-search-item" data-index="${index}" data-name="${name.replace(/"/g, '&quot;')}">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    <span>${name}</span>
                    <button class="remove-recent" data-remove="${index}">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <path d="M18 6L6 18M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `).join('');

            dropdown.classList.add('show');

            // 이벤트 위임
            list.onclick = function(e) {
                const removeBtn = e.target.closest('.remove-recent');
                if (removeBtn) {
                    e.stopPropagation();
                    const index = parseInt(removeBtn.dataset.remove);
                    const searches = getMatchRecentSearches();
                    if (searches[index]) {
                        removeMatchRecentSearch(searches[index]);
                    }
                    return;
                }

                const item = e.target.closest('.recent-search-item');
                if (item) {
                    const name = item.dataset.name;
                    if (name) {
                        isProcessingMatchRecentSearch = true;
                        const input = document.getElementById('matchSearchInput');
                        if (input) input.value = name;
                        executeMatchSearch();
                        setTimeout(() => {
                            isProcessingMatchRecentSearch = false;
                        }, 100);
                    }
                }
            };
        }

        // 최근 검색 기록 가져오기
        function getRecentSearches() {
            try {
                const searches = localStorage.getItem(RECENT_SEARCHES_KEY);
                return searches ? JSON.parse(searches) : [];
            } catch (e) {
                return [];
            }
        }

        // 최근 검색 기록 저장
        function saveRecentSearch(name) {
            if (!name || name.trim() === '') return;

            let searches = getRecentSearches();
            // 이미 있으면 제거 (맨 위로 올리기 위해)
            searches = searches.filter(s => s !== name);
            // 맨 앞에 추가
            searches.unshift(name);
            // 최대 개수 제한
            if (searches.length > MAX_STORED_SEARCHES) {
                searches = searches.slice(0, MAX_STORED_SEARCHES);
            }
            localStorage.setItem(RECENT_SEARCHES_KEY, JSON.stringify(searches));

            // 최근 검색 목록 UI 즉시 업데이트 (드롭다운이 열려있을 때)
            const dropdown = document.getElementById('recentSearchDropdown');
            if (dropdown && dropdown.classList.contains('show')) {
                showRecentSearches();
            }
        }

        // 최근 검색 기록 삭제
        function removeRecentSearch(name) {
            let searches = getRecentSearches();
            searches = searches.filter(s => s !== name);
            localStorage.setItem(RECENT_SEARCHES_KEY, JSON.stringify(searches));
            showRecentSearches();
        }

        // 최근 검색 목록 접기/펼치기
        function toggleRecentSearchList(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('recentSearchDropdown');
            if (dropdown) {
                dropdown.classList.toggle('collapsed');
            }
        }

        // 플로팅 검색 버튼 표시/숨기기 (개인승점 탭에서만)
        function updateSearchFabVisibility() {
            const fab = document.getElementById('playerSearchFab');
            const container = document.getElementById('playerSearchContainer');
            const rankingsTab = document.getElementById('rankingsContent');

            if (fab && rankingsTab) {
                const isRankingsActive = rankingsTab.classList.contains('active');
                const isSearchOpen = container && container.classList.contains('active');

                if (isRankingsActive && !isSearchOpen) {
                    fab.classList.add('visible');
                } else {
                    fab.classList.remove('visible');
                }
            }
        }

        // 검색창 열기 (개인승점)
        function openPlayerSearch() {
            const fab = document.getElementById('playerSearchFab');
            const container = document.getElementById('playerSearchContainer');
            const input = document.getElementById('playerSearchInput');

            // FAB 숨기기
            if (fab) fab.classList.remove('visible');

            // 검색창 열기
            setTimeout(() => {
                if (container) {
                    container.classList.add('active');
                    // 키보드 높이 즉시 적용
                    updateSearchContainerPosition('playerSearchContainer');

                    // 애니메이션 후 포커스 및 검색 이력 표시
                    setTimeout(() => {
                        if (input) {
                            showRecentSearches();
                            // 포커스는 검색 이력 표시 후에
                            setTimeout(() => {
                                input.focus();
                            }, 50);
                        }
                    }, 350);
                }
            }, 150);
        }

        // 검색 컨테이너 위치 업데이트 (키보드 높이 반영)
        function updateSearchContainerPosition(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const initialBottom = 20;

            if (window.visualViewport) {
                const keyboardHeight = window.innerHeight - window.visualViewport.height;
                if (keyboardHeight > 50) { // 키보드가 올라온 경우
                    container.style.bottom = (initialBottom + keyboardHeight) + 'px';
                } else {
                    container.style.bottom = initialBottom + 'px';
                }
            }
        }

        // 통합 모바일 키보드 핸들러
        function initMobileKeyboardHandler() {
            if (!window.visualViewport) return;

            const updateAllSearchPositions = () => {
                const playerContainer = document.getElementById('playerSearchContainer');
                const matchContainer = document.getElementById('matchSearchContainer');
                const initialBottom = 20;
                const keyboardHeight = window.innerHeight - window.visualViewport.height;
                const offset = keyboardHeight > 50 ? keyboardHeight : 0;

                // 개인승점 검색창
                if (playerContainer && playerContainer.classList.contains('active')) {
                    playerContainer.style.bottom = (initialBottom + offset) + 'px';
                }

                // 경기기록 검색창
                if (matchContainer && matchContainer.classList.contains('active')) {
                    matchContainer.style.bottom = (initialBottom + offset) + 'px';
                }
            };

            window.visualViewport.addEventListener('resize', updateAllSearchPositions);
            window.visualViewport.addEventListener('scroll', updateAllSearchPositions);
        }

        // 더 이상 별도 핸들러 필요 없음
        function initMatchSearchKeyboardHandler() {
            // initMobileKeyboardHandler에서 통합 처리
        }

        // 검색창 닫기
        function closePlayerSearch() {
            const fab = document.getElementById('playerSearchFab');
            const container = document.getElementById('playerSearchContainer');
            const dropdown = document.getElementById('recentSearchDropdown');
            const input = document.getElementById('playerSearchInput');

            // 드롭다운 먼저 닫기
            if (dropdown) dropdown.classList.remove('show');

            // 검색창 접기 (내부 페이드아웃 → width 접힘 → 사라짐)
            if (container) container.classList.remove('active');
            if (input) input.value = '';

            // FAB 다시 표시 (애니메이션 없이 바로)
            setTimeout(() => {
                if (fab) {
                    fab.style.transition = 'none';
                    updateSearchFabVisibility();
                    // 다음 프레임에서 transition 복원
                    requestAnimationFrame(() => {
                        fab.style.transition = '';
                    });
                }
            }, 450);
        }

        // 최근 검색 목록 표시
        function showRecentSearches() {
            const dropdown = document.getElementById('recentSearchDropdown');
            const list = document.getElementById('recentSearchList');
            const searches = getRecentSearches();

            if (!dropdown || !list) return;

            if (searches.length === 0) {
                dropdown.classList.remove('show');
                return;
            }

            // 현재 랭킹에서 플레이어 정보 찾기
            function getPlayerRankInfo(playerName) {
                const rankingItems = document.querySelectorAll('.ranking-item');
                for (const item of rankingItems) {
                    const nameEl = item.querySelector('.player-name');
                    if (nameEl) {
                        // 첫 번째 텍스트 노드에서 이름 추출
                        let name = '';
                        for (const node of nameEl.childNodes) {
                            if (node.nodeType === Node.TEXT_NODE) {
                                name = node.textContent.trim();
                                if (name) break;
                            }
                        }
                        if (name === playerName) {
                            // 순위 가져오기
                            const rankEl = item.querySelector('.rank-number');
                            const rank = rankEl ? rankEl.textContent.trim() : '';
                            // 타이틀 가져오기 (상위권 등)
                            const titleEl = nameEl.querySelector('span');
                            const title = titleEl ? titleEl.textContent.trim() : '';
                            return { rank, title };
                        }
                    }
                }
                return { rank: '', title: '' };
            }

            // 표시할 검색 목록 (최대 5개)
            const displaySearches = searches.slice(0, DISPLAY_RECENT_SEARCHES);

            // data 속성 사용으로 특수문자 문제 해결
            list.innerHTML = displaySearches.map((name, index) => {
                const info = getPlayerRankInfo(name);
                const rankBadge = info.rank ? `<span style="color: #2c5f2d; font-weight: 600; margin-right: 4px;">${info.rank}</span>` : '';
                const titleBadge = info.title ? `<span style="color: #888; font-size: 11px; margin-left: 4px;">${info.title}</span>` : '';

                return `
                <div class="recent-search-item" data-index="${index}">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    <span class="recent-name">${rankBadge}${escapeHtml(name)}${titleBadge}</span>
                    <button class="remove-recent" data-remove-index="${index}">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `}).join('');

            dropdown.classList.add('show');
        }

        // HTML 이스케이프 함수
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 최근 검색 목록 클릭 이벤트 위임
        document.addEventListener('click', function(e) {
            // 삭제 버튼 클릭
            const removeBtn = e.target.closest('.remove-recent');
            if (removeBtn) {
                e.stopPropagation();
                const index = parseInt(removeBtn.dataset.removeIndex);
                const searches = getRecentSearches();
                if (searches[index]) {
                    removeRecentSearch(searches[index]);
                }
                return;
            }

            // 최근 검색 항목 클릭
            const item = e.target.closest('.recent-search-item');
            if (item && item.dataset.index !== undefined) {
                e.stopPropagation();
                // 최근 검색 처리 중 플래그 설정 (DOM 재구성 후 드롭다운 닫힘 방지)
                isProcessingRecentSearch = true;
                const index = parseInt(item.dataset.index);
                const searches = getRecentSearches();
                if (searches[index]) {
                    selectRecentSearch(searches[index]);
                }
                // 플래그 해제 (다음 이벤트 루프에서)
                setTimeout(() => {
                    isProcessingRecentSearch = false;
                }, 0);
                return;
            }
        });

        // 최근 검색에서 선택
        // 최근 검색에서 선택 시 해당 위치로 바로 이동 (입력창 변경 없음, 순서 유지)
        function selectRecentSearch(name) {
            const rankingItems = document.querySelectorAll('.ranking-item');

            // 기존 하이라이트 제거
            rankingItems.forEach(item => {
                item.classList.remove('search-highlight');
            });

            for (const item of rankingItems) {
                const nameEl = item.querySelector('.player-name');
                if (nameEl) {
                    let playerName = '';
                    for (const node of nameEl.childNodes) {
                        if (node.nodeType === Node.TEXT_NODE) {
                            playerName = node.textContent.trim();
                            if (playerName) break;
                        }
                    }

                    if (playerName === name) {
                        // 해당 위치로 스크롤
                        item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // 하이라이트 효과
                        item.classList.add('search-highlight');
                        // 3초 후 하이라이트 제거
                        setTimeout(() => {
                            item.classList.remove('search-highlight');
                        }, 3000);
                        break;
                    }
                }
            }
        }

        // 검색 실행
        function executePlayerSearch() {
            const input = document.getElementById('playerSearchInput');

            if (!input) return;

            const searchName = input.value.trim();
            if (!searchName) return;

            // 플레이어 찾기
            const rankingItems = document.querySelectorAll('.ranking-item');
            let found = false;

            // 기존 하이라이트 제거
            rankingItems.forEach(item => {
                item.classList.remove('search-highlight');
            });

            for (const item of rankingItems) {
                const nameEl = item.querySelector('.player-name');
                if (nameEl) {
                    // 첫 번째 텍스트 노드만 가져오기 (상위권 등 제외)
                    let playerName = '';
                    for (const node of nameEl.childNodes) {
                        if (node.nodeType === Node.TEXT_NODE) {
                            playerName = node.textContent.trim();
                            if (playerName) break;
                        }
                    }

                    if (playerName && playerName.includes(searchName)) {
                        // 해당 위치로 스크롤
                        item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // 하이라이트 효과
                        item.classList.add('search-highlight');
                        // 3초 후 하이라이트 제거
                        setTimeout(() => {
                            item.classList.remove('search-highlight');
                        }, 3000);

                        found = true;
                        // 검색 기록 저장 (이름만)
                        saveRecentSearch(playerName);
                        // 입력창에 이름 표시
                        input.value = playerName;
                        break;
                    }
                }
            }

            if (!found) {
                alert(`'${searchName}' 플레이어를 찾을 수 없습니다.`);
            }
        }

        // 검색 키 입력 처리
        function handleSearchKeyup(event) {
            if (event.key === 'Enter') {
                executePlayerSearch();
            } else if (event.key === 'Escape') {
                closePlayerSearch();
            }
        }

        // 검색창 외부 클릭 시 드롭다운 닫기
        document.addEventListener('click', function(event) {
            // 최근 검색 처리 중이면 드롭다운 닫지 않음
            if (isProcessingRecentSearch || isProcessingMatchRecentSearch) return;

            // 개인승점 검색 드롭다운
            const playerContainer = document.getElementById('playerSearchContainer');
            const playerDropdown = document.getElementById('recentSearchDropdown');
            if (playerContainer && playerDropdown && !playerContainer.contains(event.target)) {
                playerDropdown.classList.remove('show');
            }

            // 경기기록 검색 드롭다운
            const matchContainer = document.getElementById('matchSearchContainer');
            const matchDropdown = document.getElementById('matchRecentSearchDropdown');
            if (matchContainer && matchDropdown && !matchContainer.contains(event.target)) {
                matchDropdown.classList.remove('show');
            }
        });

        // 경기 유형 선택 처리
        function setupMatchTypeSelection() {
            const labels = document.querySelectorAll('.match-type-label');
            labels.forEach(label => {
                label.addEventListener('click', function() {
                    // 같은 그룹의 라벨들 찾기
                    const radioName = this.querySelector('input[type="radio"]').name;
                    const groupLabels = document.querySelectorAll(`.match-type-label input[name="${radioName}"]`);
                    
                    // 같은 그룹의 모든 라벨에서 selected 클래스 제거
                    groupLabels.forEach(radio => {
                        radio.closest('.match-type-label').classList.remove('selected');
                    });
                    
                    // 클릭된 라벨에 selected 클래스 추가
                    this.classList.add('selected');
                    // 라디오 버튼 선택
                    const radio = this.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.checked = true;
                        
                        // 타이틀 선택이 변경된 경우 UI 업데이트
                        if (radioName === 'matchTitle') {
                            updateMonthlyMatchUI();
                        }
                    }
                });
            });
        }
        
        // 월례대회 UI 업데이트 함수
        function updateMonthlyMatchUI() {
            const selectedTitle = document.querySelector('input[name="matchTitle"]:checked');
            const isMonthly = selectedTitle && selectedTitle.value === '월례대회';
            
            // 경기 번호 선택 영역 표시/숨김
            const matchNumberGroup = document.getElementById('matchNumberGroup');
            if (matchNumberGroup) {
                matchNumberGroup.style.display = isMonthly ? 'block' : 'none';
            }
            
            // 팀 레이블 변경
            const teamALabel = document.getElementById('teamALabel');
            const teamBLabel = document.getElementById('teamBLabel');
            if (isMonthly) {
                if (teamALabel) teamALabel.textContent = '회장팀 이름/점수';
                if (teamBLabel) teamBLabel.textContent = '부회장팀 이름/점수';
            } else {
                if (teamALabel) teamALabel.textContent = '팀 A 이름/점수';
                if (teamBLabel) teamBLabel.textContent = '팀 B 이름/점수';
            }
        }

        // 탭 전환 함수
        function switchTab(tabName) {
            // 탭 클릭 시 맨 위로 즉시 이동 (스크롤 효과 없음)
            window.scrollTo(0, 0);

            // 탭 버튼 상태 업데이트
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');

            // 탭 콘텐츠 상태 업데이트
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Content').classList.add('active');

            // 탭별 데이터 업데이트
            if (tabName === 'rankings') {
                updateRankings();
            } else if (tabName === 'clubstats') {
                updateClubStats();
            }

            // 검색창 닫고 플로팅 버튼 상태 업데이트
            closePlayerSearch();
            closeMatchSearch();
            updateSearchFabVisibility();
            updateMatchSearchFabVisibility();

            // 경기기록 탭이 아니면 검색 필터 배지 숨기기
            const badge = document.getElementById('searchFilterBadge');
            if (badge) {
                badge.style.display = (tabName === 'matches' && currentMatchSearchFilter) ? 'flex' : 'none';
            }
        }

        // 기간 필터 변수 (기본값: 이번달)
        let currentPeriodFilter = '이번달';
        let currentTypeFilter = '전체';

        // 기간 필터링 함수
        function filterByPeriod(period) {
            currentPeriodFilter = period;
            
            // 필터 버튼 상태 업데이트
            document.querySelectorAll('.period-filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // 필터링된 랭킹 업데이트
            updateRankings();
        }

        // 경기 유형 필터링 함수
        function filterByType(type) {
            currentTypeFilter = type;
            
            // 필터 버튼 상태 업데이트
            document.querySelectorAll('.type-filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // 필터링된 랭킹 업데이트
            updateRankings();
        }

        // 개인별 승점 계산 및 랭킹 업데이트 (필터링 포함)
        function updateRankings() {
            const playerStats = {};
            
            // 필터링된 경기만 선택 (기간과 유형을 조합)
            let filteredMatches = matches;
            
            // 1. 기간 필터링
            if (currentPeriodFilter === '이번달') {
                const now = new Date();
                const thisMonth = now.getMonth();
                const thisYear = now.getFullYear();
                filteredMatches = filteredMatches.filter(match => {
                    const matchDate = new Date(match.date || match.timestamp);
                    return matchDate.getMonth() === thisMonth && matchDate.getFullYear() === thisYear;
                });
            }
            
            // 2. 경기 유형 필터링
            if (currentTypeFilter !== '전체') {
                filteredMatches = filteredMatches.filter(match => match.matchType === currentTypeFilter);
            }
            
            // 각 경기에서 플레이어별 승점 계산
            filteredMatches.forEach(match => {
                const scoreA = parseInt(match.scoreA || 0);
                const scoreB = parseInt(match.scoreB || 0);
                
                // 팀 이름에서 개별 플레이어 추출 (공백, 쉼표, / 등으로 구분)
                const playersA = extractPlayers(match.teamA);
                const playersB = extractPlayers(match.teamB);
                
                // A팀 플레이어들 처리
                playersA.forEach(player => {
                    // 게스트는 통계에서 제외
                    if (isGuestPlayer(player)) {
                        return;
                    }
                    
                    if (!playerStats[player]) {
                        playerStats[player] = { 
                            wins: 0, 
                            losses: 0, 
                            totalMatches: 0, 
                            totalPoints: 0,
                            singleMatches: 0,
                            doubleMatches: 0,
                            menDoubles: 0,
                            womenDoubles: 0,
                            mixedDoubles: 0
                        };
                    }
                    
                    playerStats[player].totalMatches++;
                    
                    // 경기 유형별 카운트
                    const matchType = match.matchType || '혼복';
                    if (matchType === '단식') {
                        playerStats[player].singleMatches++;
                    } else {
                        playerStats[player].doubleMatches++;
                        if (matchType === '남복') {
                            playerStats[player].menDoubles++;
                        } else if (matchType === '여복') {
                            playerStats[player].womenDoubles++;
                        } else {
                            playerStats[player].mixedDoubles++;
                        }
                    }
                    
                    // 승부 및 승점 계산
                    if (scoreA > scoreB) {
                        playerStats[player].wins++;
                        playerStats[player].totalPoints += 3; // 승리시 3점
                    } else if (scoreA < scoreB) {
                        playerStats[player].losses++;
                        playerStats[player].totalPoints -= 1; // 패배시 -1점
                    } else {
                        playerStats[player].totalPoints += 1; // 무승부시 1점
                    }
                });
                
                // B팀 플레이어들 처리
                playersB.forEach(player => {
                    // 게스트는 통계에서 제외
                    if (isGuestPlayer(player)) {
                        return;
                    }
                    
                    if (!playerStats[player]) {
                        playerStats[player] = { 
                            wins: 0, 
                            losses: 0, 
                            totalMatches: 0, 
                            totalPoints: 0,
                            singleMatches: 0,
                            doubleMatches: 0,
                            menDoubles: 0,
                            womenDoubles: 0,
                            mixedDoubles: 0
                        };
                    }
                    
                    playerStats[player].totalMatches++;
                    
                    // 경기 유형별 카운트
                    const matchType = match.matchType || '혼복';
                    if (matchType === '단식') {
                        playerStats[player].singleMatches++;
                    } else {
                        playerStats[player].doubleMatches++;
                        if (matchType === '남복') {
                            playerStats[player].menDoubles++;
                        } else if (matchType === '여복') {
                            playerStats[player].womenDoubles++;
                        } else {
                            playerStats[player].mixedDoubles++;
                        }
                    }
                    
                    // 승부 및 승점 계산
                    if (scoreB > scoreA) {
                        playerStats[player].wins++;
                        playerStats[player].totalPoints += 3; // 승리시 3점
                    } else if (scoreB < scoreA) {
                        playerStats[player].losses++;
                        playerStats[player].totalPoints -= 1; // 패배시 -1점
                    } else {
                        playerStats[player].totalPoints += 1; // 무승부시 1점
                    }
                });
            });
            
            // 승점이 0점 이하로 내려가지 않도록 처리
            Object.keys(playerStats).forEach(player => {
                if (playerStats[player].totalPoints < 0) {
                    playerStats[player].totalPoints = 0;
                }
            });
            
            // 승점 순으로 정렬
            const rankings = Object.entries(playerStats)
                .map(([name, stats]) => ({ name, ...stats }))
                .sort((a, b) => {
                    // 1순위: 총 승점
                    if (b.totalPoints !== a.totalPoints) return b.totalPoints - a.totalPoints;
                    // 2순위: 승률
                    const aWinRate = a.totalMatches > 0 ? (a.wins / a.totalMatches) : 0;
                    const bWinRate = b.totalMatches > 0 ? (b.wins / b.totalMatches) : 0;
                    if (bWinRate !== aWinRate) return bWinRate - aWinRate;
                    // 3순위: 경기수
                    return b.totalMatches - a.totalMatches;
                });
            
            renderRankings(rankings);
        }

        // 팀 이름에서 개별 플레이어 추출
        function extractPlayers(teamName) {
            if (!teamName) return [];
            
            // 다양한 구분자로 분리: 공백, 쉼표, 슬래시, 하이픈, &, +
            const players = teamName
                .split(/[\s,\/\-&+]+/)
                .map(name => name.trim())
                .filter(name => name.length > 0)
                .filter(name => !name.match(/^(팀|vs|대|VS)$/i)); // 팀, vs 등 키워드 제거
            
            return players.length > 0 ? players : [teamName]; // 분리되지 않으면 전체를 하나의 플레이어로
        }

        // 게스트 유저인지 체크하는 함수
        function isGuestPlayer(playerName) {
            if (!playerName) return false;
            return playerName.includes('게스트');
        }

        // 월례대회 분기별 성적 계산 함수
        function calculateMonthlyTournamentStats(allMatches, playerName) {
            const currentYear = new Date().getFullYear();
            const quarterlyStats = {
                [currentYear]: {
                    Q1: { matches: [], wins: 0, losses: 0, draws: 0, details: {} },
                    Q2: { matches: [], wins: 0, losses: 0, draws: 0, details: {} },
                    Q3: { matches: [], wins: 0, losses: 0, draws: 0, details: {} },
                    Q4: { matches: [], wins: 0, losses: 0, draws: 0, details: {} }
                }
            };

            // 분기 계산 함수
            function getQuarter(month) {
                if (month <= 3) return 'Q1';
                if (month <= 6) return 'Q2';
                if (month <= 9) return 'Q3';
                return 'Q4';
            }

            // 월례대회 경기 필터링 및 분석
            allMatches.forEach(match => {
                if (!match.title || !match.title.includes('월례대회')) return;

                const playersA = extractPlayers(match.teamA);
                const playersB = extractPlayers(match.teamB);
                
                // 플레이어가 참여한 경기인지 확인
                const isInTeamA = playersA.includes(playerName);
                const isInTeamB = playersB.includes(playerName);
                if (!isInTeamA && !isInTeamB) return;

                const matchDate = new Date(match.timestamp || match.date || Date.now());
                const year = matchDate.getFullYear();
                const month = matchDate.getMonth() + 1;
                const quarter = getQuarter(month);

                if (!quarterlyStats[year]) {
                    quarterlyStats[year] = {
                        Q1: { matches: [], wins: 0, losses: 0, draws: 0, details: {} },
                        Q2: { matches: [], wins: 0, losses: 0, draws: 0, details: {} },
                        Q3: { matches: [], wins: 0, losses: 0, draws: 0, details: {} },
                        Q4: { matches: [], wins: 0, losses: 0, draws: 0, details: {} }
                    };
                }

                const scoreA = parseInt(match.scoreA) || 0;
                const scoreB = parseInt(match.scoreB) || 0;
                
                // 경기 결과 판정
                let result, team;
                if (isInTeamA) {
                    team = '회장팀';
                    if (scoreA > scoreB) result = 'W';
                    else if (scoreA < scoreB) result = 'L';
                    else result = 'D';
                } else {
                    team = '부회장팀';
                    if (scoreB > scoreA) result = 'W';
                    else if (scoreB < scoreA) result = 'L';
                    else result = 'D';
                }

                // 경기 번호 추출
                const matchNumber = match.title.match(/(\d+경기)/)?.[1] || '1경기';
                
                // 통계 업데이트
                const quarterData = quarterlyStats[year][quarter];
                quarterData.matches.push({
                    date: matchDate,
                    title: match.title,
                    matchNumber: matchNumber,
                    team: team,
                    result: result,
                    score: `${scoreA}-${scoreB}`,
                    opponent: isInTeamA ? playersB.join(', ') : playersA.join(', ')
                });

                if (result === 'W') quarterData.wins++;
                else if (result === 'L') quarterData.losses++;
                else quarterData.draws++;

                // 경기별 세부 통계
                if (!quarterData.details[matchNumber]) {
                    quarterData.details[matchNumber] = { wins: 0, losses: 0, draws: 0 };
                }
                if (result === 'W') quarterData.details[matchNumber].wins++;
                else if (result === 'L') quarterData.details[matchNumber].losses++;
                else quarterData.details[matchNumber].draws++;
            });

            return quarterlyStats;
        }

        // 클럽 월례대회 현황 계산 함수
        function calculateClubMonthlyTournamentStats(allMatches) {
            const currentYear = new Date().getFullYear();
            const quarterlyStats = {
                [currentYear]: {
                    Q1: { presidentTeam: {wins: 0, losses: 0, draws: 0, details: {}}, vicePresidentTeam: {wins: 0, losses: 0, draws: 0, details: {}}, total: 0 },
                    Q2: { presidentTeam: {wins: 0, losses: 0, draws: 0, details: {}}, vicePresidentTeam: {wins: 0, losses: 0, draws: 0, details: {}}, total: 0 },
                    Q3: { presidentTeam: {wins: 0, losses: 0, draws: 0, details: {}}, vicePresidentTeam: {wins: 0, losses: 0, draws: 0, details: {}}, total: 0 },
                    Q4: { presidentTeam: {wins: 0, losses: 0, draws: 0, details: {}}, vicePresidentTeam: {wins: 0, losses: 0, draws: 0, details: {}}, total: 0 }
                }
            };

            // 분기 계산 함수
            function getQuarter(month) {
                if (month <= 3) return 'Q1';
                if (month <= 6) return 'Q2';
                if (month <= 9) return 'Q3';
                return 'Q4';
            }

            // 월례대회 경기 필터링 및 분석
            allMatches.forEach(match => {
                if (!match.title || !match.title.includes('월례대회')) return;

                const matchDate = new Date(match.timestamp || match.date || Date.now());
                const year = matchDate.getFullYear();
                const month = matchDate.getMonth() + 1;
                const quarter = getQuarter(month);

                if (!quarterlyStats[year]) {
                    quarterlyStats[year] = {
                        Q1: { presidentTeam: {wins: 0, losses: 0, draws: 0, details: {}}, vicePresidentTeam: {wins: 0, losses: 0, draws: 0, details: {}}, total: 0 },
                        Q2: { presidentTeam: {wins: 0, losses: 0, draws: 0, details: {}}, vicePresidentTeam: {wins: 0, losses: 0, draws: 0, details: {}}, total: 0 },
                        Q3: { presidentTeam: {wins: 0, losses: 0, draws: 0, details: {}}, vicePresidentTeam: {wins: 0, losses: 0, draws: 0, details: {}}, total: 0 },
                        Q4: { presidentTeam: {wins: 0, losses: 0, draws: 0, details: {}}, vicePresidentTeam: {wins: 0, losses: 0, draws: 0, details: {}}, total: 0 }
                    };
                }

                const scoreA = parseInt(match.scoreA) || 0;
                const scoreB = parseInt(match.scoreB) || 0;
                const matchNumber = match.title.match(/(\d+경기)/)?.[1] || '1경기';
                
                const quarterData = quarterlyStats[year][quarter];
                quarterData.total++;

                // 회장팀(팀A) vs 부회장팀(팀B) 결과
                if (scoreA > scoreB) {
                    quarterData.presidentTeam.wins++;
                    if (!quarterData.presidentTeam.details[matchNumber]) {
                        quarterData.presidentTeam.details[matchNumber] = {wins: 0, losses: 0, draws: 0};
                    }
                    quarterData.presidentTeam.details[matchNumber].wins++;
                } else if (scoreA < scoreB) {
                    quarterData.vicePresidentTeam.wins++;
                    if (!quarterData.vicePresidentTeam.details[matchNumber]) {
                        quarterData.vicePresidentTeam.details[matchNumber] = {wins: 0, losses: 0, draws: 0};
                    }
                    quarterData.vicePresidentTeam.details[matchNumber].wins++;
                } else {
                    quarterData.presidentTeam.draws++;
                    quarterData.vicePresidentTeam.draws++;
                    if (!quarterData.presidentTeam.details[matchNumber]) {
                        quarterData.presidentTeam.details[matchNumber] = {wins: 0, losses: 0, draws: 0};
                    }
                    if (!quarterData.vicePresidentTeam.details[matchNumber]) {
                        quarterData.vicePresidentTeam.details[matchNumber] = {wins: 0, losses: 0, draws: 0};
                    }
                    quarterData.presidentTeam.details[matchNumber].draws++;
                    quarterData.vicePresidentTeam.details[matchNumber].draws++;
                }
            });

            return quarterlyStats;
        }

        // 랭킹 렌더링
        function renderRankings(rankings) {
            const container = document.getElementById('rankingsContainer');
            
            if (rankings.length === 0) {
                container.innerHTML = `
                    <div class="empty-ranking">
                        <svg width="64" height="64" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M7.5 3.5c0-1.105.895-2 2-2s2 .895 2 2-2 4.5-2 4.5S7.5 4.605 7.5 3.5z"/>
                            <path d="M2.5 6.5c0-1.105.895-2 2-2s2 .895 2 2-2 4.5-2 4.5S2.5 7.605 2.5 6.5z"/>
                            <path d="M12.5 6.5c0-1.105.895-2 2-2s2 .895 2 2-2 4.5-2 4.5s-2-3.395-2-4.5z"/>
                            <path d="M0 13h16v3H0z"/>
                        </svg>
                        <h3>등록된 경기가 없습니다</h3>
                        <p>경기 기록을 추가하면 개인별 승점이 계산됩니다</p>
                    </div>
                `;
                return;
            }
            
            const rankingHTML = rankings.map((player, index) => {
                // 공동순위 계산
                let rank = index + 1;
                let isSharedRank = false;
                
                if (index > 0 && rankings[index - 1].totalPoints === player.totalPoints) {
                    // 이전 플레이어와 같은 점수면 같은 순위 사용
                    let prevIndex = index - 1;
                    while (prevIndex >= 0 && rankings[prevIndex].totalPoints === player.totalPoints) {
                        prevIndex--;
                    }
                    rank = prevIndex + 2; // 공동순위
                    isSharedRank = true;
                } else if (index < rankings.length - 1 && rankings[index + 1].totalPoints === player.totalPoints) {
                    // 다음 플레이어와 같은 점수면 공동순위
                    isSharedRank = true;
                }
                
                const winRate = player.totalMatches > 0 ? ((player.wins / player.totalMatches) * 100).toFixed(1) : '0.0';
                
                let rankClass = '';
                if (rank === 1) rankClass = 'rank-1';
                else if (rank === 2) rankClass = 'rank-2';
                else if (rank === 3) rankClass = 'rank-3';
                
                // 순위별 이모지와 타이틀
                let rankEmoji = '';
                let rankTitle = '';
                if (rank === 1) {
                    rankEmoji = '🥇';
                    rankTitle = '👑 챔피언';
                } else if (rank === 2) {
                    rankEmoji = '🥈';
                    rankTitle = '🔥 2위';
                } else if (rank === 3) {
                    rankEmoji = '🥉';
                    rankTitle = '⚡ 3위';
                } else if (rank <= 5) {
                    rankEmoji = '🏅';
                    rankTitle = '💪 상위권';
                } else {
                    rankEmoji = '🎾';
                    rankTitle = '🌟 도전자';
                }

                // 승률에 따른 특별 배지
                let specialBadge = '';
                if (winRate == 100) {
                    specialBadge = `<span style="color: #dc3545; font-size: 12px;">승률 ${winRate}% 🔥 무적</span>`;
                } else if (winRate >= 80) {
                    specialBadge = `<span style="color: #e91e63; font-size: 12px;">승률 ${winRate}% 🔥 최강</span>`;
                } else if (winRate >= 60) {
                    specialBadge = `<span style="color: #28a745; font-size: 12px;">승률 ${winRate}% 💪 강자</span>`;
                } else if (winRate >= 40) {
                    specialBadge = `<span style="color: #17a2b8; font-size: 12px;">승률 ${winRate}% ⚖️ 균형</span>`;
                } else {
                    specialBadge = `<span style="color: #fd7e14; font-size: 12px;">승률 ${winRate}% 🔥 성장중</span>`;
                }

                return `
                    <div class="ranking-item ${rankClass}" style="cursor: pointer; transition: all 0.3s;" onclick="viewPlayerStats('${player.name.replace(/'/g, "\\'")}')"
                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 20px rgba(0,0,0,0.15)';" 
                         onmouseout="this.style.transform=''; this.style.boxShadow='';">
                        <div class="rank-number ${rankClass}">
                            <div style="font-size: 1.2em;">${rankEmoji}</div>
                            <div>${rank}위</div>
                        </div>
                        <div class="player-info">
                            <div class="player-name">
                                ${player.name}
                                <span style="font-size: 11px; color: #666; margin-left: 6px;">${rankTitle}</span>
                            </div>
                            <div style="margin-top: 2px;">
                                ${specialBadge}
                            </div>
                            <div class="player-stats" style="margin-top: 2px;">
                                <div class="stat-row" style="display: flex; gap: 12px;">
                                    ${player.wins > 0 ? `<div class="stat-item"><span style="color: #28a745; font-weight: 500;"><span class="stat-label-full">승리</span><span class="stat-label-short">승</span>: ${player.wins}회</span></div>` : ''}
                                    ${(player.totalMatches - player.wins - player.losses) > 0 ? `<div class="stat-item"><span style="color: #6c757d; font-weight: 500;"><span class="stat-label-full">무승부</span><span class="stat-label-short">무</span>: ${player.totalMatches - player.wins - player.losses}회</span></div>` : ''}
                                    ${player.losses > 0 ? `<div class="stat-item"><span style="color: #dc3545; font-weight: 500;"><span class="stat-label-full">패배</span><span class="stat-label-short">패</span>: ${player.losses}회</span></div>` : ''}
                                </div>
                                <div class="stat-row match-types" style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    ${player.singleMatches > 0 ? `<div class="stat-item match-type-item"><span>👤 단식:</span><span>${player.singleMatches}회</span></div>` : ''}
                                    ${player.menDoubles > 0 ? `<div class="stat-item match-type-item"><span>👥 남복:</span><span>${player.menDoubles}회</span></div>` : ''}
                                    ${player.womenDoubles > 0 ? `<div class="stat-item match-type-item"><span>👭 여복:</span><span>${player.womenDoubles}회</span></div>` : ''}
                                    ${player.mixedDoubles > 0 ? `<div class="stat-item match-type-item"><span>👫 혼복:</span><span>${player.mixedDoubles}회</span></div>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="total-points">
                            ${player.totalPoints}<span class="points-suffix">점</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `<div class="ranking-list">${rankingHTML}</div>`;
        }
        const GITHUB_CONFIG = {
            owner: 'i0500',
            repo: 'hyun', 
            branch: 'main',
            fileName: 'rival-matches.json',
            token: null,
            // 토큰 조각들 (런타임에 조합)
            tokenParts: [
                'Z2hwX1dUMllR',
                'eEZpeDI1cTJV',
                'd3hrSEpqVHQ4',
                'MG40RmFHMjJT',
                'ZllHTg=='
            ]
        };

        // 로딩 관리 함수들
        let currentProgress = 0;

        function showLoading(text = '데이터 로딩 중...', subtext = '잠시만 기다려주세요', resetProgress = true) {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            const loadingSubtext = document.getElementById('loadingSubtext');
            const progressBar = document.getElementById('loadingProgressBar');
            const progressPercent = document.getElementById('loadingPercentage');
            
            if (overlay) {
                overlay.classList.remove('hidden');
                if (loadingText) loadingText.textContent = text;
                if (loadingSubtext) loadingSubtext.textContent = subtext;
                
                if (resetProgress) {
                    currentProgress = 0;
                    if (progressBar) progressBar.style.width = '0%';
                    if (progressPercent) progressPercent.textContent = '0%';
                }
            }
        }

        function updateLoadingProgress(progress, text = '', subtext = '') {
            const overlay = document.getElementById('loadingOverlay');
            const progressBar = document.getElementById('loadingProgressBar');
            const progressPercent = document.getElementById('loadingPercentage');
            const loadingText = document.getElementById('loadingText');
            const loadingSubtext = document.getElementById('loadingSubtext');
            
            currentProgress = Math.min(100, Math.max(0, progress));
            
            if (progressBar) {
                progressBar.style.width = currentProgress + '%';
                progressBar.style.transition = 'width 0.3s ease';
            }
            if (progressPercent) {
                progressPercent.textContent = Math.round(currentProgress) + '%';
            }
            if (text && loadingText) {
                loadingText.textContent = text;
            }
            if (subtext && loadingSubtext) {
                loadingSubtext.textContent = subtext;
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                // 100% 완료 표시
                updateLoadingProgress(100, '완료!', '로딩이 완료되었습니다');
                
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    currentProgress = 0;
                }, 800); // 최소 로딩 시간 보장
            }
        }

        function updateLoadingText(text, subtext = '') {
            const loadingText = document.getElementById('loadingText');
            const loadingSubtext = document.getElementById('loadingSubtext');
            
            if (loadingText) loadingText.textContent = text;
            if (loadingSubtext) loadingSubtext.textContent = subtext;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // 초기 로딩 표시
            showLoading('앱 시작 중...', '현클럽 배틀 아레나 로딩');
            updateLoadingProgress(10, '앱 시작 중...', '시스템 초기화');

            // 먼저 최신 데이터 로드 시도
            try {
                updateLoadingProgress(20, '서버 연결 중...', '최신 데이터 확인');
                await initializeGitHub();
                updateLoadingProgress(90, '데이터 로드 완료', '경기 기록 준비 완료');
            } catch (error) {
                console.log('[초기화] 원격 로드 실패, 로컬 데이터 사용:', error.message);
                updateLoadingProgress(50, '저장된 데이터 로드 중...', '기존 경기 기록 불러오는 중');
                loadMatches();
                updateLoadingProgress(90, '저장된 데이터 로드 완료', '경기 기록 준비 완료');
            }
            
            // 경기 유형 선택 이벤트 설정
            updateLoadingProgress(95, '인터페이스 설정 중...', '마지막 설정');
            setupMatchTypeSelection();

            // 로딩 완료
            hideLoading();

            // 플로팅 검색 버튼 초기화
            updateSearchFabVisibility();
            updateMatchSearchFabVisibility();

            // 모바일 키보드 핸들러 초기화
            initMobileKeyboardHandler();
            initMatchSearchKeyboardHandler();

            // 초기 필터링 상태 확인 및 적용
            setTimeout(() => {
                const checkbox = document.getElementById('showAllRecords');
                if (checkbox && checkbox.checked) {
                        // 이미 loadMatches()가 호출되었지만 혹시 모르니 다시 확인
                    if (matches.length === 0) {
                        toggleDataRange();
                    }
                }
            }, 100);
            
            // 페이지 포커스시 제한적 동기화 (3초 간격)
            let lastFocusSync = 0;
            window.addEventListener('focus', () => {
                if (GITHUB_CONFIG.token && !isDeleting) { // 삭제 중이 아닐 때만 동기화
                    const now = Date.now();
                    if (now - lastFocusSync > 3000) { // 3초 제한
                        lastFocusSync = now;
                        loadFromGitHub().catch(error => {
                        });
                    } else {
                    }
                }
            });

            // 탭 네비게이션 sticky 기능
            const tabNavigation = document.querySelector('.tab-navigation');
            const tabOriginalPosition = tabNavigation ? tabNavigation.offsetTop : 0;

            window.addEventListener('scroll', function() {
                if (tabNavigation) {
                    const scrollY = window.scrollY;
                    if (scrollY >= tabOriginalPosition - 10) { // 10px 여유
                        tabNavigation.classList.add('sticky');
                        // sticky 상태일 때 페이지 내용이 점프하지 않도록 offset 추가
                        document.body.style.paddingTop = tabNavigation.offsetHeight + 20 + 'px';
                    } else {
                        tabNavigation.classList.remove('sticky');
                        document.body.style.paddingTop = '10px';
                    }
                }
            });
        });

        // 데이터 초기화 및 자동 설정
        async function initializeGitHub() {
            try {
                // 1. 기존 연결 정보 확인
                updateLoadingProgress(25, '연결 정보 확인 중...', '저장된 설정 확인');
                let token = localStorage.getItem('githubToken');
                
                // 2. 연결 정보가 없으면 기본 설정 사용
                if (!token) {
                    updateLoadingProgress(30, '연결 설정 중...', '기본 연결 설정');
                    token = decryptToken();
                    if (token) {
                        console.log('[초기화] 기본 설정 사용');
                        localStorage.setItem('githubToken', token);
                    }
                }
                
                // 3. 서버 연결 설정
                if (token) {
                    updateLoadingProgress(40, '서버 연결 설정 중...', '데이터 서버 접속 준비');
                    GITHUB_CONFIG.token = token;
                    
                    // 4. 연결 상태 확인
                    updateLoadingProgress(50, '연결 상태 확인 중...', '서버 접속 확인');
                    const isValid = await validateGitHubToken(token);
                    if (isValid) {
                            updateLoadingProgress(60, '연결 완료', '서버 연결 성공');
                        checkGitHubConnection();
                        
                        // 5. 최신 데이터 불러오기
                        try {
                            updateLoadingProgress(70, '최신 데이터 불러오는 중...', '경기 기록 업데이트');
                            await loadFromGitHub();
                            updateLoadingProgress(85, '데이터 로드 완료', '최신 경기 기록 준비');
                        } catch (error) {
                            console.log('[초기화] 원격 데이터 로드 실패, 저장된 데이터 사용:', error.message);
                            // 원격 로드 실패시 로컬 데이터 사용
                            updateLoadingProgress(70, '저장된 데이터 사용', '기존 경기 기록 로드');
                            loadMatches();
                            updateLoadingProgress(85, '저장된 데이터 로드 완료', '경기 기록 준비 완료');
                        }
                        
                    } else {
                        console.warn('[초기화] 서버 연결 실패 - 저장된 데이터 사용');
                        updateLoadingProgress(60, '연결 실패', '저장된 데이터 사용');
                        localStorage.removeItem('githubToken');
                        GITHUB_CONFIG.token = null;
                        checkGitHubConnection();
                        loadMatches();
                        updateLoadingProgress(85, '저장된 데이터 로드 완료', '오프라인 모드');
                    }
                } else {
                    console.warn('[초기화] 연결 설정 없음 - 저장된 데이터 사용');
                    updateLoadingProgress(50, '오프라인 모드', '저장된 데이터 사용');
                    checkGitHubConnection();
                    loadMatches();
                    updateLoadingProgress(85, '저장된 데이터 로드 완료', '오프라인 모드');
                }
            } catch (error) {
                console.error('[초기화] 오류 - 저장된 데이터 사용:', error);
                updateLoadingProgress(60, '연결 오류', '저장된 데이터 사용');
                checkGitHubConnection();
                loadMatches();
                updateLoadingProgress(85, '저장된 데이터 로드 완료', '오프라인 모드');
            }
        }

        // 자동 GitHub 동기화 함수
        async function autoSyncToGitHub(action = '데이터 변경') {
            try {
                // 토큰이 없으면 자동 설정 시도
                if (!GITHUB_CONFIG.token) {
                    const autoToken = decryptToken();
                    if (autoToken) {
                        GITHUB_CONFIG.token = autoToken;
                        localStorage.setItem('githubToken', autoToken);
                        console.log(`[자동동기화] ${action} - 내장 토큰 사용`);
                    } else {
                        console.log(`[자동동기화] ${action} - 토큰 없음, 로컬에만 저장`);
                        return;
                    }
                }
                
                // 동기화 상태 표시 업데이트
                const statusText = document.getElementById('statusText');
                const statusDot = document.getElementById('githubStatus');
                if (statusText) {
                    statusText.textContent = '🔄 동기화 중...';
                    if (statusDot) {
                        statusDot.style.background = '#ffc107';
                    }
                }
                
                // GitHub에 즉시 업로드
                console.log(`[자동동기화] ${action} - GitHub 업로드 시작`);
                await syncToGitHub();
                console.log(`[자동동기화] ${action} - GitHub 업로드 완료`);
                
                // 동기화 완료 표시
                if (statusText) {
                    statusText.textContent = '✅ 자동 동기화 완료';
                    if (statusDot) {
                        statusDot.style.background = '#28a745';
                        statusDot.classList.add('connected');
                    }
                    
                    // 3초 후 기본 상태로 복원
                    setTimeout(() => {
                        if (statusText) {
                            statusText.textContent = '🔗 자동 동기화 활성화';
                        }
                    }, 3000);
                }
                
            } catch (error) {
                console.error(`[자동동기화] ${action} 실패:`, error);
                
                // 토큰 관련 오류면 토큰 재설정
                if (error.message.includes('401') || error.message.includes('403')) {
                    console.log(`[자동동기화] 토큰 오류 - 재설정 시도`);
                    localStorage.removeItem('githubToken');
                    GITHUB_CONFIG.token = null;
                    
                    // 내장 토큰으로 재시도
                    const autoToken = decryptToken();
                    if (autoToken) {
                        try {
                            GITHUB_CONFIG.token = autoToken;
                            localStorage.setItem('githubToken', autoToken);
                            await syncToGitHub();
                            console.log(`[자동동기화] ${action} - 내장 토큰으로 재시도 성공`);
                        } catch (retryError) {
                            console.error(`[자동동기화] ${action} - 재시도 실패:`, retryError);
                        }
                    }
                }
            }
        }

        // Load matches from localStorage (최근 2년간 데이터만)
        function loadMatches() {
            const saved = localStorage.getItem('rivalMatches');
            const allMatches = saved ? JSON.parse(saved) : [];
            
            // 최근 2년 데이터 필터링 (더 유연한 범위)
            const currentDate = new Date();
            const twoYearsAgo = new Date();
            twoYearsAgo.setFullYear(currentDate.getFullYear() - 2);
            
            // 최근 2년간 데이터 필터링 (timestamp 기준)
            matches = allMatches.filter(match => {
                if (!match.timestamp) return false;
                const matchDate = new Date(match.timestamp);
                if (isNaN(matchDate.getTime())) return false;
                return matchDate >= twoYearsAgo;
            });
            
            
            renderMatches();
        }

        // Save matches to localStorage (전체 데이터 유지)
        function saveMatches() {
            // 기존 전체 데이터 가져오기
            const saved = localStorage.getItem('rivalMatches');
            let allMatches = saved ? JSON.parse(saved) : [];
            
            // 현재 표시중인 matches의 변경사항을 전체 데이터에 반영
            const currentYear = new Date().getFullYear();
            const lastYear = currentYear - 1;
            
            // 올해와 작년이 아닌 데이터는 그대로 유지
            const oldMatches = allMatches.filter(match => {
                const matchDate = new Date(match.date);
                const matchYear = matchDate.getFullYear();
                return matchYear !== currentYear && matchYear !== lastYear;
            });
            
            // 전체 데이터 = 과거 데이터 + 현재 표시중인 데이터
            const updatedAllMatches = [...oldMatches, ...matches];
            
            localStorage.setItem('rivalMatches', JSON.stringify(updatedAllMatches));
        }
        
        // 새로운 경기 추가 (전체 데이터에 직접 추가)
        function addNewMatch(matchData) {
            const saved = localStorage.getItem('rivalMatches');
            let allMatches = saved ? JSON.parse(saved) : [];
            allMatches.unshift(matchData); // 전체 데이터에도 최신 경기를 맨 앞에 추가
            localStorage.setItem('rivalMatches', JSON.stringify(allMatches));
            
            // 현재 표시 데이터도 업데이트
            // date 필드가 없으면 현재 날짜로 설정
            if (!matchData.date) {
                matchData.date = new Date().toISOString();
            }
            
            const matchDate = new Date(matchData.date);
            const matchYear = matchDate.getFullYear();
            const currentYear = new Date().getFullYear();
            const lastYear = currentYear - 1;
            
            // 올해나 작년 경기는 matches 배열에도 추가 (최신 순으로 맨 앞에)
            if (matchYear === currentYear || matchYear === lastYear) {
                matches.unshift(matchData);
            }
        }

        // Render matches with pagination
        function renderMatches() {
            // 검색 필터가 적용되어 있으면 필터링된 렌더링 사용
            if (currentMatchSearchFilter) {
                renderFilteredMatches();
                return;
            }

            const container = document.getElementById('matchesContainer');

            if (matches.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🏆</div>
                        <h3>등록된 경기 기록이 없습니다</h3>
                        <p>새로운 경기 기록을 추가해보세요!</p>
                    </div>
                `;
            } else {
                // 최신 경기가 위로 오도록 정렬 (timestamp 기준 내림차순)
                const sortedMatches = [...matches].sort((a, b) => b.timestamp - a.timestamp);
                
                // 페이지네이션 계산
                const totalPages = Math.ceil(sortedMatches.length / matchesPerPage);
                const startIndex = (currentPage - 1) * matchesPerPage;
                const endIndex = startIndex + matchesPerPage;
                const currentMatches = sortedMatches.slice(startIndex, endIndex);
                
                const matchesHTML = currentMatches.map((match, index) => {
                    // 원래 배열의 인덱스 찾기 (수정/삭제용)
                    const originalIndex = matches.findIndex(m => m.timestamp === match.timestamp);
                    return createMatchCard(match, originalIndex);
                }).join('');
                
                const paginationHTML = totalPages > 1 ? createPaginationHTML(totalPages) : '';

                // 페이지 정보 표시 (1페이지보다 많을 때만)
                const pageInfoHTML = totalPages > 1 ? 
                    `<div class="page-info">page ${currentPage} / ${totalPages}</div>` : '';

                const html = `
                    ${pageInfoHTML}
                    <div class="matches-grid">
                        ${matchesHTML}
                    </div>
                    ${paginationHTML}
                `;
                container.innerHTML = html;
            }
            
            // 경기 기록이 변경될 때마다 랭킹도 업데이트
            updateRankings();
        }

        // Create pagination HTML (스마트 페이지네이션)
        function createPaginationHTML(totalPages) {
            let paginationHTML = '<div class="pagination">';

            // 이전 버튼
            paginationHTML += `<button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">&laquo;</button>`;

            // 스마트 페이지네이션: 앞뒤 각 1개씩 + 첫/끝 페이지 (최대 7개: 1 ... 4 5 6 ... 20)
            const delta = 1; // 현재 페이지 앞뒤로 보여줄 개수
            const pages = [];

            // 항상 첫 페이지 추가
            pages.push(1);

            // 현재 페이지 주변 범위 계산
            let rangeStart = Math.max(2, currentPage - delta);
            let rangeEnd = Math.min(totalPages - 1, currentPage + delta);

            // 첫 페이지 근처면 더 많이 표시 (1 2 3 4 ... 20)
            if (currentPage <= 3) {
                rangeStart = 2;
                rangeEnd = Math.min(4, totalPages - 1);
            }

            // 마지막 페이지 근처면 더 많이 표시 (1 ... 17 18 19 20)
            if (currentPage >= totalPages - 2) {
                rangeStart = Math.max(2, totalPages - 3);
                rangeEnd = totalPages - 1;
            }

            // 첫 페이지와 범위 사이에 간격이 있으면 ... 추가
            if (rangeStart > 2) {
                pages.push('...');
            }

            // 범위 내 페이지들 추가
            for (let i = rangeStart; i <= rangeEnd; i++) {
                if (!pages.includes(i)) {
                    pages.push(i);
                }
            }

            // 범위와 마지막 페이지 사이에 간격이 있으면 ... 추가
            if (rangeEnd < totalPages - 1) {
                pages.push('...');
            }

            // 마지막 페이지 추가 (2페이지 이상일 때만)
            if (totalPages > 1 && !pages.includes(totalPages)) {
                pages.push(totalPages);
            }

            // 페이지 버튼 생성
            pages.forEach(page => {
                if (page === '...') {
                    paginationHTML += '<span class="pagination-ellipsis">…</span>';
                } else if (page === currentPage) {
                    paginationHTML += `<button class="pagination-btn active">${page}</button>`;
                } else {
                    paginationHTML += `<button class="pagination-btn" onclick="changePage(${page})">${page}</button>`;
                }
            });

            // 다음 버튼
            paginationHTML += `<button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">&raquo;</button>`;

            // 페이지 정보
            const startItem = (currentPage - 1) * matchesPerPage + 1;
            const endItem = Math.min(currentPage * matchesPerPage, matches.length);
            paginationHTML += `<div class="pagination-info">${startItem}-${endItem} / ${matches.length}개</div>`;

            paginationHTML += '</div>';
            return paginationHTML;
        }

        // Change page function
        function changePage(page) {
            if (page < 1 || page > Math.ceil(matches.length / matchesPerPage)) return;
            currentPage = page;
            renderMatches();
            // 페이지 변경 시 상단으로 스크롤
            window.scrollTo(0, 0);
        }

        // Create match card HTML
        function createMatchCard(match, index, searchHighlight = null) {
            const scoreA = parseInt(match.scoreA);
            const scoreB = parseInt(match.scoreB);

            // 이름 표시 (하이라이트 적용 여부)
            const displayTeamA = searchHighlight ? highlightName(match.teamA, searchHighlight) : match.teamA;
            const displayTeamB = searchHighlight ? highlightName(match.teamB, searchHighlight) : match.teamB;

            let resultHTML = '';
            if (scoreA > scoreB) {
                const winnerDisplay = searchHighlight ? highlightName(match.teamA, searchHighlight) : match.teamA;
                resultHTML = `🏆 승리: ${winnerDisplay}`;
            } else if (scoreB > scoreA) {
                const winnerDisplay = searchHighlight ? highlightName(match.teamB, searchHighlight) : match.teamB;
                resultHTML = `🏆 승리: ${winnerDisplay}`;
            } else {
                resultHTML = `🤝 무승부`;
            }

            // 날짜 포맷 (년월일만)
            const matchDate = new Date(match.timestamp || Date.now());
            const dateStr = `${matchDate.getFullYear()}.${(matchDate.getMonth() + 1).toString().padStart(2, '0')}.${matchDate.getDate().toString().padStart(2, '0')}`;

            // 경기 유형 배지
            const matchType = match.matchType || '혼복';
            let typeClass = 'mixed-doubles';
            let typeEmoji = '👫';

            if (matchType === '남복') {
                typeClass = 'men-doubles';
                typeEmoji = '👬';
            } else if (matchType === '여복') {
                typeClass = 'women-doubles';
                typeEmoji = '👭';
            } else if (matchType === '단식') {
                typeClass = 'singles';
                typeEmoji = '🎾';
            }

            return `
                <div class="match-card">
                    <div class="match-header">
                        <div style="display: flex; flex-direction: column; align-items: flex-start; flex: 1;">
                            <div class="match-title">
                                <span class="match-type-inline ${typeClass}">${matchType}</span>
                                ${match.title || '경기 기록'}
                            </div>
                            <div class="match-date-mobile" style="color: #6c757d; font-size: 12px; margin-top: 4px; display: none;">
                                ${dateStr}
                            </div>
                        </div>
                        <div class="match-actions mobile-actions">
                            <span onclick="editMatch(${index})" style="cursor: pointer; font-size: 14px; margin-right: 6px; opacity: 0.7;">✏️</span>
                            <span onclick="deleteMatch(${index})" style="cursor: pointer; font-size: 14px; opacity: 0.7;">🗑️</span>
                        </div>
                    </div>
                    <div class="match-body">
                        <div class="team-vs">
                            <span class="team-name">${displayTeamA}</span>
                            <span class="vs-badge">VS</span>
                            <span class="team-name">${displayTeamB}</span>
                        </div>
                        <div class="score-display">
                            <span class="score">${match.scoreA}</span>
                            <span class="score-separator">:</span>
                            <span class="score">${match.scoreB}</span>
                        </div>
                        <div style="text-align: center; color: #6c757d; font-weight: 500;">
                            ${resultHTML}
                        </div>
                        <div class="match-date-desktop" style="text-align: center; color: #6c757d; font-size: 12px; margin-top: 10px;">
                            ${dateStr}
                        </div>
                    </div>
                </div>
            `;
        }

        // Show add modal
        function showAddModal() {
            editingIndex = -1;
            document.getElementById('modalTitle').textContent = '경기 기록 추가';
            document.getElementById('deleteBtn').style.display = 'none';
            document.getElementById('dateTimeGroup').style.display = 'none'; // 날짜/시간 필드 숨김
            document.getElementById('matchForm').reset();
            // 입력 필드 초기화
            document.getElementById('teamA1').value = '';
            document.getElementById('teamA2').value = '';
            document.getElementById('teamB1').value = '';
            document.getElementById('teamB2').value = '';
            
            // 점수 디스플레이 초기화
            clearScore('A');
            clearScore('B');
            
            // 타이틀 기본 선택 (친선 경기)
            document.querySelectorAll('.match-type-label input[name="matchTitle"]').forEach(radio => {
                const label = radio.closest('.match-type-label');
                label.classList.remove('selected');
                radio.checked = false;
            });
            document.getElementById('titleFriendly').checked = true;
            document.getElementById('titleFriendlyLabel').classList.add('selected');
            
            // 월례대회 관련 UI 초기화
            updateMonthlyMatchUI();
            
            // 경기 번호 기본 선택 (1경기)
            document.querySelectorAll('.match-type-label input[name="matchNumber"]').forEach(radio => {
                radio.closest('.match-type-label').classList.remove('selected');
                radio.checked = false;
            });
            document.getElementById('match1').checked = true;
            document.getElementById('match1Label').classList.add('selected');
            
            // 경기 유형 기본 선택 (남복)
            document.getElementById('menDoubles').checked = true;
            document.querySelectorAll('.match-type-label input[name="matchType"]').forEach(radio => {
                radio.closest('.match-type-label').classList.remove('selected');
            });
            document.getElementById('menDoublesLabel').classList.add('selected');
            
            // 바디 스크롤 방지
            document.body.style.overflow = 'hidden';
            
            const modal = document.getElementById('matchModal');
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('show');
                
                // 경기 기록 모달 배경 클릭 이벤트 (개별 추가)
                modal.addEventListener('click', function matchModalBackgroundClick(event) {
                    if (event.target === modal) {
                        console.log('[경기기록] 배경 클릭으로 모달 닫기');
                        hideModal();
                        // 이벤트 리스너 제거
                        modal.removeEventListener('click', matchModalBackgroundClick);
                    }
                });
            }, 10);
            
            // 경기 유형 선택 이벤트 설정
            setTimeout(setupMatchTypeSelection, 100);
        }

        // Show edit modal
        function editMatch(index) {
            editingIndex = index;
            const match = matches[index];
            
            document.getElementById('modalTitle').textContent = '경기 기록 수정';
            document.getElementById('deleteBtn').style.display = 'block';
            document.getElementById('dateTimeGroup').style.display = 'block'; // 날짜/시간 필드 표시
            
            // 기존 타이틀에 맞는 라디오 버튼 선택
            const existingTitle = match.title || '';
            let titleFound = false;
            
            // " 경기"를 제거한 값으로 비교
            let titleWithoutMatch = existingTitle;
            if (existingTitle.endsWith(' 경기')) {
                titleWithoutMatch = existingTitle.replace(' 경기', '');
            }
            
            // 모든 타이틀 라디오 버튼과 레이블 초기화
            document.querySelectorAll('.match-type-label input[name="matchTitle"]').forEach(radio => {
                const label = radio.closest('.match-type-label');
                label.classList.remove('selected');
                radio.checked = false;
                
                // 원본 타이틀 또는 "경기"를 제거한 타이틀과 비교
                if (radio.value === existingTitle || radio.value === titleWithoutMatch) {
                    radio.checked = true;
                    label.classList.add('selected');
                    titleFound = true;
                }
            });
            
            // 기존 타이틀이 옵션에 없으면 친선으로 설정
            if (!titleFound) {
                document.getElementById('titleFriendly').checked = true;
                document.getElementById('titleFriendlyLabel').classList.add('selected');
            }
            
            // 월례대회 관련 UI 업데이트
            updateMonthlyMatchUI();
            
            // 날짜/시간 설정
            const matchDate = new Date(match.timestamp || match.date || Date.now());
            // datetime-local 형식으로 변환 (YYYY-MM-DDTHH:MM)
            const year = matchDate.getFullYear();
            const month = String(matchDate.getMonth() + 1).padStart(2, '0');
            const day = String(matchDate.getDate()).padStart(2, '0');
            const hours = String(matchDate.getHours()).padStart(2, '0');
            const minutes = String(matchDate.getMinutes()).padStart(2, '0');
            document.getElementById('matchDateTime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            // 팀 이름을 선수별로 분리
            const teamAPlayers = (match.teamA || '').split('/').map(p => p.trim());
            const teamBPlayers = (match.teamB || '').split('/').map(p => p.trim());
            
            document.getElementById('teamA1').value = teamAPlayers[0] || '';
            document.getElementById('teamA2').value = teamAPlayers[1] || '';
            document.getElementById('teamB1').value = teamBPlayers[0] || '';
            document.getElementById('teamB2').value = teamBPlayers[1] || '';
            
            document.getElementById('scoreA').value = match.scoreA || 0;
            document.getElementById('scoreB').value = match.scoreB || 0;
            
            // 점수 디스플레이 업데이트
            document.getElementById('scoreADisplay').textContent = match.scoreA || 0;
            document.getElementById('scoreBDisplay').textContent = match.scoreB || 0;
            
            // 점수 버튼 선택 상태 복원
            const scoreA = parseInt(match.scoreA) || 0;
            const scoreB = parseInt(match.scoreB) || 0;
            
            // 팀 A 버튼 선택
            const buttonsA = document.querySelectorAll(`.score-container .score-button[onclick*="'A'"]`);
            buttonsA.forEach(btn => btn.classList.remove('selected'));
            if (scoreA >= 1 && scoreA <= 6) {
                const buttonA = document.querySelector(`.score-button[onclick="setScore('A', ${scoreA})"]`);
                if (buttonA) buttonA.classList.add('selected');
            }
            
            // 팀 B 버튼 선택
            const buttonsB = document.querySelectorAll(`.score-container .score-button[onclick*="'B'"]`);
            buttonsB.forEach(btn => btn.classList.remove('selected'));
            if (scoreB >= 1 && scoreB <= 6) {
                const buttonB = document.querySelector(`.score-button[onclick="setScore('B', ${scoreB})"]`);
                if (buttonB) buttonB.classList.add('selected');
            }
            
            // 경기 유형 선택 복원
            const matchType = match.matchType || '혼복';
            document.querySelectorAll('.match-type-label').forEach(label => label.classList.remove('selected'));
            document.querySelectorAll('input[name="matchType"]').forEach(radio => radio.checked = false);
            
            if (matchType === '남복') {
                document.getElementById('menDoubles').checked = true;
                document.getElementById('menDoublesLabel').classList.add('selected');
            } else if (matchType === '여복') {
                document.getElementById('womenDoubles').checked = true;
                document.getElementById('womenDoublesLabel').classList.add('selected');
            } else if (matchType === '단식') {
                document.getElementById('singles').checked = true;
                document.getElementById('singlesLabel').classList.add('selected');
            } else {
                document.getElementById('menDoubles').checked = true;
                document.getElementById('menDoublesLabel').classList.add('selected');
            }
            
            // 바디 스크롤 방지
            document.body.style.overflow = 'hidden';
            
            const modal = document.getElementById('matchModal');
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('show');
                
                // 경기 기록 모달 배경 클릭 이벤트 (개별 추가)
                modal.addEventListener('click', function matchModalBackgroundClick(event) {
                    if (event.target === modal) {
                        console.log('[경기기록] 배경 클릭으로 모달 닫기');
                        hideModal();
                        // 이벤트 리스너 제거
                        modal.removeEventListener('click', matchModalBackgroundClick);
                    }
                });
            }, 10);
            
            // 경기 유형 선택 이벤트 설정
            setTimeout(setupMatchTypeSelection, 100);
        }

        // Hide modal
        function hideModal() {
            const modal = document.getElementById('matchModal');
            modal.classList.remove('show');
            
            // 바디 스크롤 복원
            document.body.style.overflow = '';
            
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300); // CSS transition 시간과 맞춤
        }

        // 중복 경기 체크 함수 (20분 이내 동일 플레이어 + 동일 점수 체크)
        function checkDuplicateMatch(teamA1, teamA2, teamB1, teamB2, scoreA, scoreB, excludeIndex = -1) {
            const DUPLICATE_TIME_WINDOW = 20 * 60 * 1000; // 20분 (밀리초)
            const now = Date.now();

            // 플레이어 이름 정규화 (소문자, 공백 제거)
            const normalizeNames = (names) => {
                return names
                    .filter(n => n && n.trim())
                    .map(n => n.trim().toLowerCase())
                    .sort();
            };

            // 새 경기의 플레이어들
            const newTeamA = normalizeNames([teamA1, teamA2]);
            const newTeamB = normalizeNames([teamB1, teamB2]);
            const newAllPlayers = [...newTeamA, ...newTeamB].sort().join(',');

            // 점수 정규화 (A:B와 B:A를 같은 것으로 처리)
            const newScores = [scoreA, scoreB].sort((a, b) => a - b).join(':');

            // 기존 경기들과 비교
            for (let i = 0; i < matches.length; i++) {
                // 수정 중인 경기는 제외
                if (i === excludeIndex) continue;

                const match = matches[i];

                // 20분 이내 등록된 경기인지 체크
                const timeDiff = now - match.timestamp;
                if (timeDiff > DUPLICATE_TIME_WINDOW) continue;

                // 기존 경기의 플레이어들 추출
                const existingTeamA = match.teamA.split(' / ').map(n => n.trim().toLowerCase()).sort();
                const existingTeamB = match.teamB.split(' / ').map(n => n.trim().toLowerCase()).sort();
                const existingAllPlayers = [...existingTeamA, ...existingTeamB].sort().join(',');

                // 기존 경기 점수 정규화
                const existingScores = [match.scoreA, match.scoreB].sort((a, b) => a - b).join(':');

                // 동일 플레이어 조합 + 동일 점수일 때만 중복
                if (newAllPlayers === existingAllPlayers && newScores === existingScores) {
                    const minutesAgo = Math.floor(timeDiff / 60000);
                    return {
                        isDuplicate: true,
                        existingMatch: match,
                        index: i,
                        minutesAgo: minutesAgo
                    };
                }
            }

            return { isDuplicate: false };
        }

        // Save match
        function saveMatch() {
            const selectedTitle = document.querySelector('input[name="matchTitle"]:checked');
            let title = selectedTitle ? selectedTitle.value : '친선';
            
            // 월례대회인 경우 경기 번호 추가, 아닌 경우 " 경기" 추가
            if (title === '월례대회') {
                const selectedMatchNumber = document.querySelector('input[name="matchNumber"]:checked');
                const matchNumber = selectedMatchNumber ? selectedMatchNumber.value : '1경기';
                title = `월례대회 ${matchNumber}`;
            } else {
                title += ' 경기';
            }
            const teamA1 = document.getElementById('teamA1').value.trim();
            const teamA2 = document.getElementById('teamA2').value.trim();
            const teamB1 = document.getElementById('teamB1').value.trim();
            const teamB2 = document.getElementById('teamB2').value.trim();
            const scoreA = parseInt(document.getElementById('scoreA').value);
            const scoreB = parseInt(document.getElementById('scoreB').value);
            
            // 경기 유형 가져오기
            const selectedMatchType = document.querySelector('input[name="matchType"]:checked');
            if (!selectedMatchType) {
                alert('경기 유형을 선택해주세요.');
                return;
            }
            const matchType = selectedMatchType.value;

            // 팀 이름 조합 (복식일 경우 / 로 구분)
            const teamA = teamA2 ? `${teamA1} / ${teamA2}` : teamA1;
            const teamB = teamB2 ? `${teamB1} / ${teamB2}` : teamB1;

            if (!teamA1 || !teamB1) {
                alert('각 팀의 첫 번째 선수는 필수입니다.');
                return;
            }

            if (isNaN(scoreA) || isNaN(scoreB) || scoreA < 0 || scoreB < 0) {
                alert('올바른 점수를 입력해주세요.');
                return;
            }

            // 날짜/시간 처리
            let timestamp, dateValue;
            if (editingIndex >= 0) {
                // 수정 모드일 때
                const dateTimeInput = document.getElementById('matchDateTime').value;
                if (dateTimeInput) {
                    const selectedDate = new Date(dateTimeInput);
                    timestamp = selectedDate.getTime();
                    dateValue = selectedDate.toISOString();
                } else {
                    // 기존 날짜 유지
                    timestamp = matches[editingIndex].timestamp;
                    dateValue = matches[editingIndex].date || new Date(timestamp).toISOString();
                }
            } else {
                // 추가 모드일 때 (현재 시간 사용)
                timestamp = Date.now();
                dateValue = new Date().toISOString();
            }

            // 중복 경기 체크 (새 경기 추가시에만, 20분 이내 동일 조합 + 동일 점수)
            if (editingIndex === -1) {
                const duplicateCheck = checkDuplicateMatch(teamA1, teamA2, teamB1, teamB2, scoreA, scoreB);
                if (duplicateCheck.isDuplicate) {
                    const existingMatch = duplicateCheck.existingMatch;
                    const existingScore = `${existingMatch.scoreA}:${existingMatch.scoreB}`;
                    const minutesAgo = duplicateCheck.minutesAgo < 1 ? 1 : duplicateCheck.minutesAgo;
                    const timeAgoText = `${minutesAgo}분 전`;
                    // 등록시간 포맷팅
                    const regDate = new Date(existingMatch.timestamp);
                    const regTimeStr = `${String(regDate.getMonth() + 1).padStart(2, '0')}월 ${String(regDate.getDate()).padStart(2, '0')}일 ${String(regDate.getHours()).padStart(2, '0')}시 ${String(regDate.getMinutes()).padStart(2, '0')}분`;
                    const confirmMsg = `🚨 ${timeAgoText} 이미 등록된 경기입니다.\n\n` +
                        `● 등록시간: ${regTimeStr}\n` +
                        `● A팀: ${existingMatch.teamA}\n` +
                        `● B팀: ${existingMatch.teamB}\n` +
                        `● 점수: ${existingScore}\n\n` +
                        `그래도 저장하시겠습니까?`;

                    if (!confirm(confirmMsg)) {
                        return; // 사용자가 취소하면 저장하지 않음
                    }
                }
            }

            const matchData = {
                title: title,
                teamA: teamA,
                teamB: teamB,
                scoreA: scoreA,
                scoreB: scoreB,
                matchType: matchType, // 경기 유형 추가
                timestamp: timestamp,
                date: dateValue // 날짜 필드
            };

            if (editingIndex >= 0) {
                matches[editingIndex] = matchData;
                saveMatches(); // 기존 경기 수정은 saveMatches 사용
            } else {
                addNewMatch(matchData); // 새 경기는 addNewMatch 사용
                currentPage = 1; // 새 경기 추가시 첫 페이지로
            }
            renderMatches();
            hideModal();
            
            // 새 경기 추가 후 페이지 최상단으로 즉시 이동
            if (editingIndex === -1) {  // 새 경기 추가인 경우만
                window.scrollTo(0, 0);
            }
            
            // 자동 GitHub 동기화 (즉시 업로드)
            autoSyncToGitHub('경기기록 저장');
        }

        // Delete match
        function deleteMatch(index = null) {
            const targetIndex = index !== null ? index : editingIndex;
            
            if (targetIndex < 0 || targetIndex >= matches.length) return;
            
            if (!confirm('정말로 이 경기 기록을 삭제하시겠습니까?')) {
                return;
            }

            // 삭제 중 플래그 설정 (자동 동기화 방지)
            isDeleting = true;

            matches.splice(targetIndex, 1);
            
            // 삭제 후 페이지 조정
            const totalPages = Math.ceil(matches.length / matchesPerPage);
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }
            
            saveMatches();
            renderMatches();
            
            updateClubStats(); // 클럽 통계도 갱신
            updateRankings(); // 랭킹도 갱신
            hideModal();
            
            // 경기기록 탭이 아닌 곳에서 삭제한 경우 경기기록 탭으로 이동
            const currentActiveTab = document.querySelector('.tab-content.active');
            if (currentActiveTab && currentActiveTab.id !== 'matchesContent') {
                switchTab('matches');
            }
            
            // 삭제 완료 후 플래그 해제 (약간의 지연)
            setTimeout(() => {
                isDeleting = false;
            }, 1000);
            
            // 자동 GitHub 동기화 (백그라운드)
            autoSyncToGitHub('경기기록 삭제');
        }

        // Export to Excel
        function exportToExcel() {
            if (matches.length === 0) {
                alert('내보낼 경기 기록이 없습니다.');
                return;
            }

            const excelData = matches.map((match, index) => ({
                '번호': index + 1,
                '타이틀': match.title || '',
                '팀A': match.teamA || '',
                '팀B': match.teamB || '',
                '점수A': match.scoreA || 0,
                '점수B': match.scoreB || 0,
                '경기유형': match.matchType || '혼복',
                '승리팀': match.scoreA > match.scoreB ? match.teamA : match.scoreB > match.scoreA ? match.teamB : '무승부',
                '등록일시': new Date(match.timestamp || Date.now()).toLocaleString('ko-KR')
            }));

            try {
                const workbook = XLSX.utils.book_new();
                const worksheet = XLSX.utils.json_to_sheet(excelData);
                
                const colWidths = [
                    { wch: 8 },   // 번호
                    { wch: 20 },  // 타이틀
                    { wch: 15 },  // 팀A
                    { wch: 15 },  // 팀B
                    { wch: 8 },   // 점수A
                    { wch: 8 },   // 점수B
                    { wch: 15 },  // 승리팀
                    { wch: 20 }   // 등록일시
                ];
                worksheet['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(workbook, worksheet, '경기기록');
                
                const today = new Date();
                const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');
                const fileName = `현클럽_경기기록_${dateStr}.xlsx`;
                
                XLSX.writeFile(workbook, fileName);
                alert(`${matches.length}개 경기기록을 엑셀 파일로 내보냈습니다.`);
                
            } catch (error) {
                console.error('[엑셀내보내기] 오류:', error);
                alert('엑셀 파일 생성 중 오류가 발생했습니다.');
            }
        }

        // 토큰 복호화 함수 (토큰 조각 조합 후 Base64 디코딩)
        function decryptToken() {
            try {
                if (!GITHUB_CONFIG.tokenParts || !Array.isArray(GITHUB_CONFIG.tokenParts)) {
                    console.warn('[토큰복호화] 토큰 조각이 없습니다');
                    return null;
                }
                
                // 토큰 조각들을 조합
                const combinedToken = GITHUB_CONFIG.tokenParts.join('');
                const decrypted = atob(combinedToken);
                
                // 토큰 형식 검증 (GitHub Personal Access Token 형식 - ghp_ 또는 github_pat_)
                if (!decrypted || (!decrypted.startsWith('ghp_') && !decrypted.startsWith('github_pat_')) || decrypted.length < 20) {
                    console.error('[토큰복호화] 유효하지 않은 토큰 형식:', decrypted ? decrypted.substring(0, 20) + '...' : 'empty');
                    return null;
                }
                
                console.log('[토큰복호화] 성공:', decrypted.substring(0, 20) + '...');
                return decrypted;
            } catch (e) {
                console.error('[토큰복호화] Base64 디코딩 실패:', e);
                return null;
            }
        }

        // 안전한 헤더 생성 함수
        function createSafeHeaders(token, additionalHeaders = {}) {
            if (!token || typeof token !== 'string' || token.trim() === '') {
                throw new Error('유효하지 않은 토큰: 토큰이 비어있거나 잘못된 형식입니다');
            }
            
            const cleanToken = token.trim();
            if (!cleanToken.startsWith('ghp_') && !cleanToken.startsWith('github_pat_')) {
                throw new Error('유효하지 않은 토큰: GitHub Personal Access Token 형식이 아닙니다');
            }
            
            return {
                'Authorization': `token ${cleanToken}`,
                'Accept': 'application/vnd.github.v3+json',
                'User-Agent': 'HyunClub-RivalMatches/1.0',
                ...additionalHeaders
            };
        }

        // GitHub Integration
        function checkGitHubConnection() {
            let token = localStorage.getItem('githubToken');
            
            // localStorage에 토큰이 없으면 암호화된 토큰 사용
            if (!token) {
                token = decryptToken();
                if (token) {
                    localStorage.setItem('githubToken', token);
                    console.log('[GitHub상태] 내장된 토큰으로 자동 설정됨');
                }
            }
            
            const statusDot = document.getElementById('githubStatus');
            const statusText = document.getElementById('statusText');
            
            if (!statusDot || !statusText) {
                if (token) {
                    GITHUB_CONFIG.token = token;
                }
                return;
            }
            
            if (token) {
                GITHUB_CONFIG.token = token;
                statusDot.classList.add('connected');
                statusText.textContent = '🔗 자동 동기화 활성화';
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = '⚠️ 동기화 설정 중...';
            }
        }

        // GitHub 토큰 유효성 검증 함수
        async function validateGitHubToken(token) {
            try {
                
                // 토큰 형식 사전 검증
                if (!token || typeof token !== 'string' || !token.trim()) {
                    console.error('[GitHub검증] 토큰이 비어있습니다');
                    return false;
                }
                
                const cleanToken = token.trim();
                if (!cleanToken.startsWith('ghp_') && !cleanToken.startsWith('github_pat_')) {
                    console.error('[GitHub검증] GitHub PAT 형식이 아닙니다:', cleanToken.substring(0, 20));
                    return false;
                }
                
                // 안전한 헤더 생성
                const headers = createSafeHeaders(cleanToken);
                
                const response = await fetch('https://api.github.com/user', {
                    headers: headers
                });
                
                if (response.ok) {
                    const userInfo = await response.json();
                    return true;
                } else if (response.status === 401) {
                    console.error('[GitHub검증] 토큰이 만료되었거나 잘못됨 (401)');
                    return false;
                } else if (response.status === 403) {
                    console.error('[GitHub검증] 토큰 권한 부족 (403)');
                    return false;
                } else {
                    console.error('[GitHub검증] 예상치 못한 응답:', response.status, response.statusText);
                    return false;
                }
            } catch (error) {
                console.error('[GitHub검증] 네트워크 또는 헤더 오류:', error);
                if (error.message.includes('Invalid value')) {
                    console.error('[GitHub검증] fetch API 헤더 오류 - 토큰에 특수문자가 포함되었을 수 있음');
                }
                return false;
            }
        }

        async function syncWithGitHub() {
            // 로딩 시작
            showLoading('데이터 동기화 중...', '최신 경기 기록 동기화');
            updateLoadingProgress(5, '데이터 동기화 중...', '초기화');
            
            try {
                console.log('[수동동기화] GitHub 동기화 시작');
                
                updateLoadingProgress(10, '연결 확인 중...', '서버 연결 상태 확인');
                
                // 1. 토큰 확인 및 설정
                if (!GITHUB_CONFIG.token) {
                    updateLoadingProgress(15, '연결 설정 중...', '기본 연결 설정 로드');
                    const autoToken = decryptToken();
                    if (autoToken) {
                        GITHUB_CONFIG.token = autoToken;
                        localStorage.setItem('githubToken', autoToken);
                        console.log('[수동동기화] 내장 토큰 사용');
                    } else {
                        hideLoading();
                        alert('❌ 동기화 설정이 없습니다.\n\n🔧 관리자에게 문의하세요.');
                        return;
                    }
                }

                // 2. 토큰 유효성 검증
                updateLoadingProgress(25, '연결 상태 확인 중...', '서버 접속 확인');
                console.log('[수동동기화] 토큰 유효성 검증 중...');
                const isValid = await validateGitHubToken(GITHUB_CONFIG.token);
                if (!isValid) {
                    console.log('[수동동기화] 토큰 무효 - 내장 토큰으로 재시도');
                    localStorage.removeItem('githubToken');
                    GITHUB_CONFIG.token = null;
                    
                    updateLoadingProgress(30, '재연결 시도 중...', '기본 설정으로 재시도');
                    // 내장 토큰으로 재시도
                    const autoToken = decryptToken();
                    if (autoToken) {
                        const isAutoValid = await validateGitHubToken(autoToken);
                        if (isAutoValid) {
                            GITHUB_CONFIG.token = autoToken;
                            localStorage.setItem('githubToken', autoToken);
                            console.log('[수동동기화] 내장 토큰으로 재설정 성공');
                        } else {
                            hideLoading();
                            alert('❌ 서버 연결에 실패했습니다.\n\n🔧 잠시 후 다시 시도하거나 관리자에게 문의하세요.');
                            checkGitHubConnection();
                            return;
                        }
                    } else {
                        hideLoading();
                        alert('❌ 동기화 기능을 사용할 수 없습니다.\n관리자에게 문의하세요.');
                        checkGitHubConnection();
                        return;
                    }
                }
                
                // 3. 실제 동기화 수행 (순서대로)
                updateLoadingProgress(40, '최신 데이터 다운로드 중...', '서버에서 최신 경기 기록 받아오는 중');
                console.log('[수동동기화] 서버에서 데이터 다운로드 중...');
                await loadFromGitHub();
                
                updateLoadingProgress(70, '데이터 업로드 중...', '새로운 경기 기록을 서버에 저장');
                console.log('[수동동기화] 서버에 데이터 업로드 중...');
                await syncToGitHub();
                
                updateLoadingProgress(95, '동기화 완료!', '모든 데이터가 성공적으로 동기화됨');
                
                // 4. 성공 알림
                console.log('[수동동기화] 동기화 완료');
                
                // 로딩 숨기기
                hideLoading();
                
                alert('✅ 데이터 동기화가 완료되었습니다!\n\n🌐 실시간 멀티유저 동기화 활성화:\n• 다른 사람들도 이 링크로 접속 가능\n• 모든 경기기록이 자동으로 공유됩니다\n\nhttps://i0500.github.io/hyun/rival-matches.html');
                
                // 5. 상태 업데이트
                checkGitHubConnection();
                
            } catch (error) {
                console.error('[수동동기화] 오류:', error);
                
                // 로딩 숨기기
                hideLoading();
                
                // 상세한 오류 처리
                if (error.message.includes('401')) {
                    alert('❌ 인증 오류 (401)\n\n🔧 해결방법:\n• 연결 설정이 만료되었을 수 있습니다\n• 관리자에게 문의하세요');
                } else if (error.message.includes('403')) {
                    alert('❌ 접근 권한 오류 (403)\n\n🔧 해결방법:\n• 서버 접근 권한이 없습니다\n• 관리자에게 문의하세요');
                } else if (error.message.includes('404')) {
                    alert('❌ 서버를 찾을 수 없습니다 (404)\n\n🔧 해결방법:\n• 서버 주소를 확인해주세요\n• 관리자에게 문의하세요');
                } else if (error.message.includes('NetworkError') || error.message.includes('fetch')) {
                    alert('❌ 네트워크 연결 오류\n\n🔧 해결방법:\n• 인터넷 연결을 확인해주세요\n• 잠시 후 다시 시도해주세요');
                } else {
                    alert(`❌ 데이터 동기화 중 오류가 발생했습니다:\n\n${error.message}\n\n🔧 문제가 계속되면 페이지를 새로고침 해주세요.`);
                }
                
                // 토큰 관련 오류면 토큰 재설정
                if (error.message.includes('401') || error.message.includes('403')) {
                    localStorage.removeItem('githubToken');
                    GITHUB_CONFIG.token = null;
                    checkGitHubConnection();
                }
            }
        }

        async function syncToGitHub() {
            if (!GITHUB_CONFIG.token) {
                throw new Error('GitHub 토큰이 설정되지 않았습니다');
            }
            
            try {
                console.log('[GitHub업로드] 데이터 준비 중...');
                const rivalData = {
                    matches: matches,
                    lastUpdated: new Date().toISOString(),
                    version: '1.0',
                    totalMatches: matches.length
                };

                // Get current file SHA (if exists)
                let sha = null;
                try {
                    console.log('[GitHub업로드] 기존 파일 SHA 확인 중...');
                    
                    // 안전한 헤더 생성
                    const headers = createSafeHeaders(GITHUB_CONFIG.token);
                    
                    const getResponse = await fetch(
                        `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.fileName}`,
                        { headers: headers }
                    );
                    if (getResponse.ok) {
                        const data = await getResponse.json();
                        sha = data.sha;
                        console.log('[GitHub업로드] 기존 파일 발견, SHA:', sha.substring(0, 7));
                    } else if (getResponse.status === 404) {
                        console.log('[GitHub업로드] 새 파일 생성');
                    } else {
                        console.warn('[GitHub업로드] SHA 확인 실패:', getResponse.status);
                    }
                } catch (e) {
                    console.log('[GitHub업로드] SHA 확인 실패, 새 파일로 처리:', e.message);
                }

                // Update or create file
                console.log('[GitHub업로드] 파일 콘텐츠 인코딩 중...');
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(rivalData, null, 2))));
                const updateData = {
                    message: `🎾 현클럽 경기기록 업데이트 (총 ${matches.length}개 경기): ${new Date().toLocaleString('ko-KR')}`,
                    content: content,
                    branch: GITHUB_CONFIG.branch
                };

                if (sha) {
                    updateData.sha = sha;
                }

                console.log('[GitHub업로드] GitHub API 호출 중...');
                
                // 안전한 헤더 생성 (PUT용)
                const putHeaders = createSafeHeaders(GITHUB_CONFIG.token, {
                    'Content-Type': 'application/json'
                });
                
                const response = await fetch(
                    `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.fileName}`,
                    {
                        method: 'PUT',
                        headers: putHeaders,
                        body: JSON.stringify(updateData)
                    }
                );

                if (response.ok) {
                    const result = await response.json();
                    console.log('[GitHub업로드] 성공! 새 SHA:', result.content.sha.substring(0, 7));
                    return true;
                } else {
                    const errorText = await response.text();
                    console.error('[GitHub업로드] API 응답 오류:', response.status, errorText);
                    throw new Error(`GitHub API 오류 (${response.status}): ${response.statusText}`);
                }
            } catch (error) {
                console.error('[GitHub업로드] 전체 오류:', error);
                
                // 더 구체적인 오류 메시지
                if (error.message.includes('Invalid value')) {
                    throw new Error('GitHub API 헤더 오류: 토큰에 잘못된 문자가 포함되었습니다');
                } else if (error.message.includes('유효하지 않은 토큰')) {
                    throw new Error('토큰 형식 오류: ' + error.message);
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    throw new Error('네트워크 연결 오류: 인터넷 연결을 확인해주세요');
                } else if (error.message.includes('401')) {
                    throw new Error('토큰 권한 오류: 토큰이 만료되었거나 잘못되었습니다');
                } else if (error.message.includes('403')) {
                    throw new Error('접근 권한 오류: repo 권한이 있는 토큰이 필요합니다');
                } else if (error.message.includes('404')) {
                    throw new Error('저장소 오류: 저장소를 찾을 수 없거나 접근할 수 없습니다');
                }
                
                throw error;
            }
        }

        async function loadFromGitHub() {
            if (!GITHUB_CONFIG.token) {
                return false;
            }
            
            // 삭제 중일 때는 GitHub 데이터 로드 차단
            if (isDeleting) {
                return false;
            }
            
            try {
                
                // 안전한 헤더 생성
                const headers = createSafeHeaders(GITHUB_CONFIG.token);
                
                const response = await fetch(
                    `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.fileName}`,
                    { headers: headers }
                );

                if (response.ok) {
                    const data = await response.json();
                    const content = decodeURIComponent(escape(atob(data.content)));
                    const githubData = JSON.parse(content);
                    
                    if (githubData.matches && Array.isArray(githubData.matches)) {
                        // Merge with local data
                        const localMatches = matches;
                        const remoteMatches = githubData.matches;
                        
                        // Simple merge: combine and deduplicate by timestamp
                        const allMatches = [...localMatches, ...remoteMatches];
                        const uniqueMatches = allMatches.reduce((acc, match) => {
                            const existing = acc.find(m => m.timestamp === match.timestamp);
                            if (!existing) {
                                acc.push(match);
                            }
                            return acc;
                        }, []);
                        
                        // GitHub에서 로드된 데이터를 전체 localStorage에 저장
                        const sortedMatches = uniqueMatches.sort((a, b) => b.timestamp - a.timestamp);
                        localStorage.setItem('rivalMatches', JSON.stringify(sortedMatches));
                        
                        // 필터링 적용해서 matches에 설정
                        loadMatches();
                        
                        return true;
                    }
                } else if (response.status === 404) {
                    // File doesn't exist yet
                    return true;
                } else {
                    throw new Error(`GitHub API 오류: ${response.status}`);
                }
            } catch (error) {
                console.error('[GitHub] 로드 오류:', error);
                throw error;
            }
        }

        // Escape key handler only
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const playerStatsModal = document.getElementById('playerStatsModal');
                const matchModal = document.getElementById('matchModal');
                
                if (playerStatsModal) {
                    closePlayerStatsModal();
                } else if (matchModal && matchModal.classList.contains('show')) {
                    hideModal();
                }
            }
        });
        
        // 선수 통계 모달 표시
        function viewPlayerStats(playerName) {
            // 다른 모달이 열려있으면 무시
            const matchModal = document.getElementById('matchModal');
            if (matchModal && matchModal.classList.contains('show')) {
                return;
            }
            
            // 히스토리를 초기화하고 첫 번째 플레이어로 설정
            playerStatsHistory = [playerName];
            currentPlayerIndex = 0;
            showPlayerStatsModal(playerName);
        }
        
        // 플레이어 통계 모달 생성 함수
        function showPlayerStatsModal(playerName) {
            const existingModal = document.getElementById('playerStatsModal');
            
            // 바디 스크롤 방지
            document.body.style.overflow = 'hidden';
            
            const playerStats = calculateAdvancedPlayerStats(playerName);
            
            const modalHtml = `
                <div id="playerStatsModal" class="modal" style="
                    display: block;
                    position: fixed;
                    z-index: 10000;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.65);
                    backdrop-filter: blur(3px);
                    animation: fadeIn 0.35s ease;
                ">
                    <div class="modal-content" style="
                        max-width: 95%;
                        width: 95%;
                        height: 98dvh;
                        max-height: 98dvh;
                        margin: 1dvh auto;
                        background: white;
                        border-radius: 16px;
                        overflow: hidden;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
                        animation: slideUp 0.35s cubic-bezier(0.4, 0, 0.2, 1);
                        transform-origin: center;
                    ">
                        <!-- 헤더 -->
                        <div style="
                            background: linear-gradient(135deg, #2c5f2d 0%, #1a3a1b 100%);
                            color: white;
                            padding: 12px 16px;
                            position: relative;
                        ">
                            <button onclick="closePlayerStatsModal()" style="
                                position: absolute;
                                top: 12px;
                                right: 12px;
                                background: rgba(255,255,255,0.2);
                                border: none;
                                color: white;
                                width: 28px;
                                height: 28px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 16px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: bold;
                            " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                               onmouseout="this.style.background='rgba(255,255,255,0.2)'">×</button>
                            
                            <div style="
                                display: flex;
                                align-items: center;
                                justify-content: space-between;
                                width: 100%;
                            ">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 20px;">🎾</span>
                                    <h2 style="margin: 0; font-size: 18px; font-weight: 600; letter-spacing: -0.3px; color: white;">${playerName} 플레이어 통계</h2>
                                </div>
                                
                                <!-- 플레이어 내비게이션 버튼 -->
                                <div style="display: flex; align-items: center; gap: 8px; margin-right: 40px;">
                                    <button id="playerNavPrev" onclick="navigateToPreviousPlayer()" style="
                                        background: rgba(255,255,255,0.2);
                                        border: none;
                                        color: white;
                                        width: 32px;
                                        height: 28px;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        font-weight: bold;
                                    " onmouseover="if(!this.disabled) this.style.background='rgba(255,255,255,0.3)'" 
                                       onmouseout="this.style.background='rgba(255,255,255,0.2)'">‹</button>
                                    
                                    <button id="playerNavNext" onclick="navigateToNextPlayer()" style="
                                        background: rgba(255,255,255,0.2);
                                        border: none;
                                        color: white;
                                        width: 32px;
                                        height: 28px;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        font-weight: bold;
                                    " onmouseover="if(!this.disabled) this.style.background='rgba(255,255,255,0.3)'" 
                                       onmouseout="this.style.background='rgba(255,255,255,0.2)'">›</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 컨텐츠 -->
                        <div style="
                            padding: 16px;
                            height: calc(98vh - 60px);
                            max-height: calc(98vh - 60px);
                            overflow-y: auto;
                            background: #f8f9fa;
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                            grid-auto-rows: max-content;
                            align-items: start;
                            gap: 4px;
                        ">
                            <!-- 1. 전체 경기 성적 -->
                            <div class="stat-card" style="
                                background: white; 
                                padding: 16px; 
                                border-radius: 12px; 
                                box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                                margin-bottom: 4px;
                                border: 1px solid #e5e7eb;
                            ">
                                <div style="font-size: 15px; font-weight: 600; color: #1f2937; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                    🏆 전체 경기 성적
                                </div>
                                <div style="font-size: 13px; color: #374151; line-height: 1.6;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px 16px; margin-bottom: 8px;">
                                        <div>• 총 경기: <strong>${playerStats.totalMatches}경기</strong></div>
                                        <div>• 전적: <strong style="color: #059669;">${playerStats.totalWins || playerStats.wins || 0}승</strong> <strong style="color: #6b7280;">${playerStats.totalDraws || playerStats.draws || 0}무</strong> <strong style="color: #dc2626;">${playerStats.totalLosses || playerStats.losses || 0}패</strong></div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px 16px;">
                                        <div>• 승률: <strong style="color: #059669;">${playerStats.winRate}%</strong></div>
                                        <div>• 클럽 순위: <strong style="color: #1f2937;">${playerStats.rank || '-'}위</strong></div>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. 이번달 경기 성적 -->
                            <div class="stat-card" style="
                                background: white; 
                                padding: 16px; 
                                border-radius: 12px; 
                                box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                                margin-bottom: 4px;
                                border: 1px solid #e5e7eb;
                            ">
                                <div style="font-size: 15px; font-weight: 600; color: #1f2937; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                    🗓️ 이번달 경기 성적
                                </div>
                                <div style="font-size: 13px; color: #374151; line-height: 1.6;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px 16px; margin-bottom: 8px;">
                                        <div>• 총 경기: <strong>${playerStats.thisMonthMatches || 0}경기</strong></div>
                                        <div>• 전적: <strong style="color: #059669;">${playerStats.thisMonthWins || 0}승</strong> <strong style="color: #6b7280;">${playerStats.thisMonthDraws || 0}무</strong> <strong style="color: #dc2626;">${playerStats.thisMonthLosses || 0}패</strong></div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px 16px;">
                                        <div>• 승률: <strong style="color: #059669;">${playerStats.thisMonthWinRate || 0}%</strong></div>
                                        <div>• 활동 상태: <strong style="color: #1f2937;">${playerStats.recentActivity || '정보없음'}</strong></div>
                                    </div>
                                </div>
                            </div>

                            <!-- 3. 연속 기록 -->
                            ${playerStats.currentStreakText ? `
                            <div class="stat-card" style="
                                background: white; 
                                padding: 16px; 
                                border-radius: 12px; 
                                box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                                margin-bottom: 4px;
                                border: 1px solid #e5e7eb;
                            ">
                                <div style="font-size: 15px; font-weight: 600; color: #1f2937; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                    🔥 연속 기록
                                </div>
                                <div style="font-size: 13px; color: #374151; line-height: 1.6;">
                                    <div style="margin-bottom: 8px;">• 현재: <strong style="color: #ea580c;">${playerStats.currentStreakText}</strong></div>
                                    <div>• 기록: 최대 연승 <strong style="color: #059669;">${playerStats.maxWinStreak || 0}경기</strong> | 최대 연패 <strong style="color: #dc2626;">${playerStats.maxLoseStreak || 0}경기</strong></div>
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- 4. 성장 지표 -->
                            ${playerStats.advancedStats ? `
                            <div class="stat-card" style="
                                background: white; 
                                padding: 16px; 
                                border-radius: 12px; 
                                box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                                margin-bottom: 4px;
                                border: 1px solid #e5e7eb;
                            ">
                                <div style="font-size: 15px; font-weight: 600; color: #1f2937; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                    📈 성장 지표
                                </div>
                                <div style="font-size: 13px; color: #374151; line-height: 1.6;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px 16px; margin-bottom: 8px;">
                                        <div>• 최근 10경기 승률: <strong style="color: #059669;">${playerStats.advancedStats.recentWinRate}%</strong></div>
                                        <div>• 이전 경기들 승률: <strong style="color: #6b7280;">${playerStats.advancedStats.olderWinRate}%</strong></div>
                                        <div>• 성장률: <strong style="color: ${parseFloat(playerStats.advancedStats.improvement) > 0 ? '#059669' : parseFloat(playerStats.advancedStats.improvement) < 0 ? '#dc2626' : '#6b7280'};">${parseFloat(playerStats.advancedStats.improvement) > 0 ? '+' : ''}${playerStats.advancedStats.improvement}%</strong></div>
                                        <div>• 연속 참가 기간: <strong style="color: #2563eb;">${playerStats.advancedStats.continuousMonths}개월</strong></div>
                                    </div>
                                    <div>• 성장 추세: <strong>${parseFloat(playerStats.advancedStats.improvement) > 5 ? '🚀 급상승' : parseFloat(playerStats.advancedStats.improvement) > 0 ? '📈 상승' : parseFloat(playerStats.advancedStats.improvement) < -5 ? '📉 급하락' : parseFloat(playerStats.advancedStats.improvement) < 0 ? '🔽 하락' : '➖ 유지'}</strong></div>
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- 6. 파트너십 분석 -->
                            ${playerStats.advancedStats ? `
                            <div class="stat-card" style="
                                background: white; 
                                padding: 16px; 
                                border-radius: 12px; 
                                box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                                margin-bottom: 4px;
                                border: 1px solid #e5e7eb;
                            ">
                                <div style="font-size: 15px; font-weight: 600; color: #1f2937; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                    🤝 파트너십 분석
                                </div>
                                <div style="font-size: 13px; color: #374151; line-height: 1.6;">
                                    ${playerStats.advancedStats.bestWinRatePartner ? 
                                        `<div style="margin-bottom: 6px;">• 🏆 최고 승률 파트너: <strong>${playerStats.advancedStats.bestWinRatePartner.name}</strong> (${playerStats.advancedStats.bestWinRatePartner.games}경기, 승률 ${playerStats.advancedStats.bestWinRatePartner.winRate}%)</div>` : ''
                                    }
                                    ${playerStats.advancedStats.mostGamesPartner ? 
                                        `<div style="margin-bottom: 6px;">• 👥 최다 동반 파트너: <strong>${playerStats.advancedStats.mostGamesPartner.name}</strong> (${playerStats.advancedStats.mostGamesPartner.games}경기, 승률 ${playerStats.advancedStats.mostGamesPartner.winRate}%)</div>` : ''
                                    }
                                    ${playerStats.advancedStats.chemistryNeededPartner ? 
                                        `<div style="margin-bottom: 6px;">• 💪 케미가 필요한 파트너: <strong>${playerStats.advancedStats.chemistryNeededPartner.name}</strong> (${playerStats.advancedStats.chemistryNeededPartner.games}경기, 승률 ${playerStats.advancedStats.chemistryNeededPartner.winRate}%)</div>` : ''
                                    }
                                    ${!playerStats.advancedStats.bestWinRatePartner && !playerStats.advancedStats.mostGamesPartner ? '<div style="color: #6b7280; font-style: italic;">• 파트너 데이터 부족 (복식 경기 더 필요)</div>' : ''}
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- 7. 경기 유형별 성과 -->
                            ${playerStats.advancedStats ? `
                            <div class="stat-card" style="
                                background: white; 
                                padding: 16px; 
                                border-radius: 12px; 
                                box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                                margin-bottom: 4px;
                                border: 1px solid #e5e7eb;
                            ">
                                <div style="font-size: 15px; font-weight: 600; color: #1f2937; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                    🎾 경기 유형별 성과
                                </div>
                                <div style="font-size: 13px; color: #374151; line-height: 1.6;">
                                    ${playerStats.advancedStats.menDoublesGames > 0 ? `<div style="margin-bottom: 6px;">• 남자복식: <strong>${playerStats.menDoublesRecord}</strong> (승률 <strong style="color: #059669;">${playerStats.advancedStats.menDoublesWinRate}%</strong>)</div>` : ''}
                                    ${playerStats.advancedStats.womenDoublesGames > 0 ? `<div style="margin-bottom: 6px;">• 여자복식: <strong>${playerStats.womenDoublesRecord}</strong> (승률 <strong style="color: #059669;">${playerStats.advancedStats.womenDoublesWinRate}%</strong>)</div>` : ''}
                                    ${playerStats.advancedStats.mixedDoublesGames > 0 ? `<div style="margin-bottom: 6px;">• 혼합복식: <strong>${playerStats.mixedDoublesRecord}</strong> (승률 <strong style="color: #059669;">${playerStats.advancedStats.mixedDoublesWinRate}%</strong>)</div>` : ''}
                                    ${playerStats.advancedStats.singlesGames > 0 ? `<div>• 단식: <strong>${playerStats.singlesWins || 0}승 ${playerStats.singlesDraws || 0}무 ${playerStats.singlesLosses || 0}패</strong> (승률 <strong style="color: #059669;">${playerStats.advancedStats.singlesWinRate}%</strong>)</div>` : ''}
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- 8. 점수차 분석 -->
                            ${playerStats.advancedStats ? `
                            <div class="stat-card" style="
                                background: white; 
                                padding: 16px; 
                                border-radius: 12px; 
                                box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                                margin-bottom: 4px;
                                border: 1px solid #e5e7eb;
                            ">
                                <div style="font-size: 15px; font-weight: 600; color: #1f2937; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                    ⚖️ 점수차 분석
                                </div>
                                <div style="font-size: 13px; color: #374151; line-height: 1.6;">
                                    <div style="margin-bottom: 8px;">• 대승 (3점차+): <strong style="color: #059669;">${playerStats.advancedStats.bigWins}경기</strong> (${playerStats.advancedStats.bigWinRate}%)</div>
                                    <div style="margin-bottom: 8px;">• 접전 (1-2점차): <strong style="color: #2563eb;">${playerStats.advancedStats.closeGames}경기</strong> (${playerStats.advancedStats.closeGameRate}%)</div>
                                    <div>• 대패 (3점차+): <strong style="color: #dc2626;">${playerStats.advancedStats.bigLosses}경기</strong></div>
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- 9. 시간대별 성과 -->
                            ${playerStats.advancedStats ? `
                            <div class="stat-card" style="
                                background: white; 
                                padding: 16px; 
                                border-radius: 12px; 
                                box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                                margin-bottom: 4px;
                                border: 1px solid #e5e7eb;
                            ">
                                <div style="font-size: 15px; font-weight: 600; color: #1f2937; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                    ⏰ 시간대별 성과
                                </div>
                                <div style="font-size: 13px; color: #374151; line-height: 1.6;">
                                    <div style="margin-bottom: 8px;">• 주중 경기: <strong>${playerStats.advancedStats.weekdayGames}경기</strong> (승률 <strong style="color: #059669;">${playerStats.advancedStats.weekdayWinRate}%</strong>)</div>
                                    <div>• 주말 경기: <strong>${playerStats.advancedStats.weekendGames}경기</strong> (승률 <strong style="color: #059669;">${playerStats.advancedStats.weekendWinRate}%</strong>)</div>
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- 10. 기본 지표 -->
                            <div class="stat-card" style="
                                background: white; 
                                padding: 16px; 
                                border-radius: 12px; 
                                box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                                margin-bottom: 4px;
                                border: 1px solid #e5e7eb;
                            ">
                                <div style="font-size: 15px; font-weight: 600; color: #1f2937; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                    📋 기본 지표
                                </div>
                                <div style="font-size: 13px; color: #374151; line-height: 1.6; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <div>• 월간 최다승: <strong style="color: #2563eb;">${playerStats.monthlyBest || 0}경기</strong></div>
                                    <div>• 월평균 경기: <strong style="color: #6b7280;">${playerStats.avgMatchesPerMonth || 0}경기</strong></div>
                                </div>
                            </div>
                            
                            <!-- 11. 월별 승률 추이 -->
                            ${playerStats.monthlyWinRates && Object.keys(playerStats.monthlyWinRates).length > 0 ? `
                            <div class="stat-card" style="
                                background: white; 
                                padding: 16px; 
                                border-radius: 12px; 
                                box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                                margin-bottom: 4px;
                                border: 1px solid #e5e7eb;
                            ">
                                <div style="
                                    font-size: 14px; 
                                    font-weight: 700; 
                                    color: #1f2937; 
                                    margin-bottom: 12px;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    📅 월별 승률 추이 (최근 6개월)
                                </div>
                                <div style="font-size: 13px; color: #374151; line-height: 1.5;">
                                    ${Object.entries(playerStats.monthlyWinRates)
                                        .sort((a, b) => b[0].localeCompare(a[0]))  // 최신월이 맨 위로 (내림차순)
                                        .slice(0, 6)  // 최근 6개월만 표시
                                        .map(([key, data]) => {
                                            const winRate = parseFloat(data.winRate);
                                            const trendColor = winRate >= 50 ? '#16a34a' : '#dc2626';
                                            return `<div style="
                                                padding: 8px 0; 
                                                border-bottom: 1px solid #f1f5f9; 
                                                display: flex; 
                                                justify-content: space-between; 
                                                align-items: center;
                                            ">
                                                <span style="color: #374151;">
                                                    <strong>${key.split('-')[0]}년 ${data.label}</strong>: 
                                                    <span style="color: #16a34a;">${data.wins}승</span> 
                                                    <span style="color: #94a3b8;">${data.draws}무</span> 
                                                    <span style="color: #dc2626;">${data.losses}패</span>
                                                </span>
                                                <span style="color: ${trendColor}; font-weight: 600;">
                                                    ${data.winRate}%
                                                </span>
                                            </div>`;
                                        }).join('')}
                                </div>
                            </div>
                            ` : ''}

                            <!-- 12. 최근 경기 -->
                            ${playerStats.recentMatches && playerStats.recentMatches.length > 0 ? `
                            <div class="stat-card" style="
                                background: white; 
                                padding: 16px; 
                                border-radius: 12px; 
                                box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                                margin-bottom: 4px;
                                border: 1px solid #e5e7eb;
                            ">
                                <div style="
                                    font-size: 14px; 
                                    font-weight: 700; 
                                    color: #1f2937; 
                                    margin-bottom: 12px;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    📝 최근 경기 (최대 5경기)
                                </div>
                                <div style="font-size: 13px; color: #374151; line-height: 1.5;">
                                    ${playerStats.recentMatches.slice(0, 5).map(match => {
                                        const date = new Date(match.date).toLocaleDateString('ko-KR', {month: 'numeric', day: 'numeric'});
                                        const result = match.result === 'W' ? '승' : match.result === 'L' ? '패' : '무';
                                        const resultColor = match.result === 'W' ? '#16a34a' : match.result === 'L' ? '#dc2626' : '#d97706';
                                        const playerTeam = match.myTeam || playerName;
                                        const isPlayerTeam = playerTeam.includes(playerName);
                                        return `<div style="
                                            padding: 12px 16px; 
                                            margin-bottom: 4px; 
                                            background: #ffffff; 
                                            border-radius: 10px; 
                                            border-left: 4px solid ${resultColor};
                                            display: flex; 
                                            justify-content: space-between; 
                                            align-items: center;
                                            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
                                        ">
                                            <span style="color: #374151;">
                                                <strong style="color: #1f2937; font-size: 10px;">${date}</strong> | 
                                                <span style="${isPlayerTeam ? 'background: #fef3c7; padding: 2px 4px; border-radius: 4px; font-weight: 600; font-size: 12px;' : 'font-size: 12px;'}">${playerTeam}</span> vs <span style="font-size: 12px;">${match.opponent}</span>
                                            </span>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <span style="
                                                    background: ${resultColor}; 
                                                    color: white; 
                                                    padding: 4px 8px; 
                                                    border-radius: 6px; 
                                                    font-size: 9px; 
                                                    font-weight: 600;
                                                    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
                                                ">${result}</span>
                                                ${match.score ? `<span style="color: #64748b; font-size: 11px; font-weight: 500;">${match.score}</span>` : ''}
                                            </div>
                                        </div>`;
                                    }).join('')}
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- 파트너 승률 통계 -->
                            <div class="stat-card" style="
                                background: white; 
                                padding: 20px; 
                                border-radius: 12px; 
                                box-shadow: 0 2px 12px rgba(0,0,0,0.08);
                                border: 1px solid #e5e7eb;
                                margin-bottom: 16px;
                            ">
                                <div style="
                                    margin-bottom: 16px;
                                    padding-bottom: 12px;
                                    border-bottom: 2px solid #f1f5f9;
                                ">
                                    <h3 style="margin: 0; font-size: 15px; color: #1f2937; font-weight: 600; display: flex; align-items: center; justify-content: space-between;">
                                        <span style="display: flex; align-items: center; gap: 8px;">🤝 파트너별 전적</span>
                                        <span style="font-size: 11px; color: #9ca3af; font-weight: 400;">승률 상위 5명 파트너</span>
                                    </h3>
                                </div>
                                <div style="font-size: 13px; color: #374151; line-height: 1.6;">
                                    ${playerStats.partnerWinRates && playerStats.partnerWinRates.length > 0 ? 
                                        playerStats.partnerWinRates.map(partner => `
                                            <div style="
                                                padding: 8px 12px; 
                                                margin-bottom: 6px; 
                                                background: #f8fafc; 
                                                border-radius: 8px; 
                                                border-left: 3px solid #10b981;
                                                display: flex;
                                                justify-content: space-between;
                                                align-items: center;
                                                cursor: pointer;
                                                transition: background-color 0.2s ease;
                                            " 
                                            onclick="navigateToPlayerStats('${partner.name}')"
                                            onmouseover="this.style.background='#f1f5f9'"
                                            onmouseout="this.style.background='#f8fafc'"
                                            >
                                                <span style="font-weight: 600; color: #1f2937; pointer-events: none;">${partner.name}</span>
                                                <div style="display: flex; flex-direction: column; align-items: flex-end; pointer-events: none;">
                                                    <span style="font-size: 12px; color: #1f2937; font-weight: 600;">${partner.totalWins}승 ${partner.totalDraws}무 ${partner.totalLosses}패 (승률 ${partner.totalWinRate}% | ${partner.totalGames}경기)</span>
                                                    <span style="font-size: 12px; color: #6b7280;">이번달 ${partner.thisMonthWins}승 ${partner.thisMonthDraws}무 ${partner.thisMonthLosses}패 (승률 ${partner.thisMonthWinRate}% | ${partner.thisMonthGames}경기)</span>
                                                </div>
                                            </div>
                                        `).join('') 
                                        : '<div style="color: #6b7280; font-style: italic; text-align: center; padding: 20px;">파트너 데이터가 없습니다.</div>'
                                    }
                                </div>
                            </div>
                            
                            <!-- 월례대회 성적 -->
                            <div style="
                                background: #ffffff; 
                                border-radius: 12px; 
                                padding: 16px; 
                                margin-bottom: 16px; 
                                border: 1px solid #e5e7eb;
                                box-shadow: 0 1px 3px rgba(0,0,0,0.05);
                            ">
                                <div style="
                                    margin-bottom: 16px;
                                    padding-bottom: 12px;
                                    border-bottom: 2px solid #f1f5f9;
                                ">
                                    <h3 style="margin: 0; font-size: 15px; color: #1f2937; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                        🏆 월례대회 성적
                                    </h3>
                                </div>
                                <div style="font-size: 13px; color: #374151; line-height: 1.6;">
                                    ${(() => {
                                        if (!playerStats.monthlyTournamentStats) {
                                            return `<div style="text-align: center; color: #9ca3af; padding: 16px;">월례대회 참가 기록이 없습니다</div>`;
                                        }
                                        
                                        let hasData = false;
                                        let resultHTML = '';
                                        
                                        Object.entries(playerStats.monthlyTournamentStats).forEach(([year, yearData]) => {
                                            Object.entries(yearData).forEach(([quarter, quarterData]) => {
                                                if (quarterData.matches.length > 0) {
                                                    hasData = true;
                                                    const totalMatches = quarterData.wins + quarterData.losses + quarterData.draws;
                                                    const winRate = totalMatches > 0 ? Math.round((quarterData.wins / totalMatches) * 100) : 0;
                                                    resultHTML += `
                                                        <div style="
                                                            padding: 12px; 
                                                            margin-bottom: 12px; 
                                                            background: #f8fafc; 
                                                            border-radius: 8px; 
                                                            border-left: 3px solid #f59e0b;
                                                        ">
                                                            <div style="font-weight: 600; color: #1f2937; margin-bottom: 8px;">
                                                                ${year}년 ${quarter === 'Q1' ? '1분기' : quarter === 'Q2' ? '2분기' : quarter === 'Q3' ? '3분기' : '4분기'} 
                                                                (${quarterData.wins}승 ${quarterData.draws}무 ${quarterData.losses}패 | 승률 ${winRate}%)
                                                            </div>
                                                            <div style="margin-left: 12px;">
                                                                ${Object.entries(quarterData.details).map(([matchNum, detail]) => {
                                                                    const matchTotal = detail.wins + detail.losses + detail.draws;
                                                                    const matchWinRate = matchTotal > 0 ? Math.round((detail.wins / matchTotal) * 100) : 0;
                                                                    return `<div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">
                                                                        • ${matchNum}: ${detail.wins}승 ${detail.draws}무 ${detail.losses}패 (승률 ${matchWinRate}%)
                                                                    </div>`;
                                                                }).join('')}
                                                            </div>
                                                        </div>
                                                    `;
                                                }
                                            });
                                        });
                                        
                                        return hasData ? resultHTML : `<div style="text-align: center; color: #9ca3af; padding: 16px;">월례대회 참가 기록이 없습니다</div>`;
                                    })()}
                                </div>
                            </div>
                            
                            <!-- 파트너하지 않은 플레이어 -->
                            <div class="stat-card" style="
                                background: white; 
                                padding: 20px; 
                                border-radius: 12px; 
                                box-shadow: 0 2px 12px rgba(0,0,0,0.08);
                                border: 1px solid #e5e7eb;
                                margin-bottom: 16px;
                            ">
                                <div style="
                                    margin-bottom: 16px;
                                    padding-bottom: 12px;
                                    border-bottom: 2px solid #f1f5f9;
                                ">
                                    <h3 style="margin: 0; font-size: 15px; color: #1f2937; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                        🔍 경기 이력이 없는 파트너
                                    </h3>
                                </div>
                                <div style="font-size: 13px; color: #374151; line-height: 1.6;">
                                    ${playerStats.unpartneredPlayers && playerStats.unpartneredPlayers.length > 0 ? 
                                        `<div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                            ${playerStats.unpartneredPlayers.map(player => `
                                                <span style="
                                                    background: #fef3c7; 
                                                    color: #d97706; 
                                                    padding: 4px 8px; 
                                                    border-radius: 6px; 
                                                    font-size: 12px; 
                                                    font-weight: 500;
                                                    cursor: pointer;
                                                    transition: background-color 0.2s ease;
                                                " 
                                                onclick="navigateToPlayerStats('${player}')"
                                                onmouseover="this.style.background='#fed7aa'"
                                                onmouseout="this.style.background='#fef3c7'"
                                                >${player}</span>
                                            `).join('')}
                                        </div>`
                                        : '<div style="color: #6b7280; font-style: italic; text-align: center; padding: 20px;">모든 플레이어와 파트너 경험이 있습니다.</div>'
                                    }
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
            `;
            
            if (existingModal) {
                // 기존 모달이 있으면 내용만 업데이트
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = modalHtml;
                const newModalContent = tempDiv.querySelector('.modal-content');
                
                const existingModalContent = existingModal.querySelector('.modal-content');
                if (existingModalContent && newModalContent) {
                    existingModalContent.innerHTML = newModalContent.innerHTML;
                }
                
                // 모달 업데이트 직후 네비게이션 버튼 업데이트
                setTimeout(() => {
                    updatePlayerNavigationButtons();
                }, 50);
            } else {
                // 새 모달 생성
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
            
            // 모달이 생성/업데이트된 직후 이벤트 설정을 위한 지연
            setTimeout(() => {
                const modalElement = document.getElementById('playerStatsModal');
                const modalContent = modalElement?.querySelector('.modal-content');
                
                if (!modalElement) {
                    document.body.style.overflow = '';
                    return;
                }
                
                // 새 모달인 경우에만 이벤트 리스너 추가
                if (!existingModal) {
                    // 모달 배경 클릭시에만 닫기 - 애니메이션 완료 후 이벤트 리스너 추가
                    setTimeout(() => {
                        modalElement.addEventListener('click', function playerStatsBackgroundClick(event) {
                            if (event.target === modalElement) {
                                closePlayerStatsModal();
                            }
                        });
                    }, 350); // 애니메이션 완료 후
                }
                
                // 모달 콘텐츠 클릭시 이벤트 전파 방지
                if (modalContent) {
                    modalContent.addEventListener('click', function playerStatsContentClick(event) {
                        event.stopPropagation();
                    });
                }
                
                // 모달 표시 애니메이션 시작
                setTimeout(() => {
                    const modalForAnimation = document.getElementById('playerStatsModal');
                    if (modalForAnimation) {
                        modalForAnimation.classList.add('show');
                        // 내비게이션 버튼 상태 업데이트
                        updatePlayerNavigationButtons();
                    }
                }, 10);
                
            }, 100); // DOM 완전 안정화를 위해 100ms로 증가
        }
        
        function showPlayerStatsModal_Old(playerName) {
            const existingModal = document.getElementById('playerStatsModal');
            if (existingModal) {
                existingModal.remove();
            }
            showPlayerStatsModal(playerName);  // 새 함수 호출
        }
        
        // 정리된 플레이어 통계 모달 함수
        function showPlayerStatsModal_Working(playerName) {
            // 새로운 고급 모달을 사용
            return showPlayerStatsModal(playerName);
        }
        
        // 실제 작동하는 모달 함수 (백업용) - DISABLED
        function showPlayerStatsModal_Backup_DISABLED(playerName) {
            console.log('[DISABLED] Backup function called - should not happen');
            return;
            // 기존 모달 제거 후 새로 생성
            const existingModal = document.getElementById('playerStatsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 간단하고 모바일 최적화된 새 모달 생성
            const newModalHtml = `
                <div id="playerStatsModal" class="modal" style="
                    display: block;
                    position: fixed;
                    z-index: 10000;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    animation: fadeIn 0.3s ease;
                ">
                    <div class="modal-content" style="
                        max-width: 480px;
                        width: 95%;
                        max-height: 95dvh;
                        overflow-y: auto;
                        margin: 2.5dvh auto;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border-radius: 16px;
                        box-shadow: 0 15px 30px rgba(0,0,0,0.2);
                        position: relative;
                    ">
                        <!-- 헤더 -->
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 16px 20px;
                            border-bottom: 1px solid rgba(255,255,255,0.2);
                        ">
                            <div style="color: white;">
                                <div style="font-size: 18px; font-weight: 700;">${playerName}</div>
                                <div style="font-size: 11px; opacity: 0.9;">개인 경기 통계</div>
                            </div>
                            <button onclick="closePlayerStatsModal()" style="
                                background: rgba(255,255,255,0.2);
                                border: none;
                                color: white;
                                width: 30px;
                                height: 30px;
                                border-radius: 50%;
                                cursor: pointer;
                                font-size: 16px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                transition: all 0.3s;
                                font-weight: bold;
                            ">×</button>
                        </div>
                        
                        <div style="
                            padding: 16px 20px 20px;
                            background: #f8fafc;
                            border-radius: 0 0 16px 16px;
                        ">
                            <!-- 메인 스코어 카드 -->
                            <div style="
                                background: white;
                                border-radius: 12px;
                                padding: 16px;
                                margin-bottom: 16px;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                            ">
                                <div style="
                                    display: grid;
                                    grid-template-columns: 1fr 1fr;
                                    gap: 12px;
                                    margin-bottom: 16px;
                                ">
                                    <div style="
                                        text-align: center; 
                                        background: linear-gradient(135deg, #667eea, #764ba2); 
                                        color: white;
                                        border-radius: 10px; 
                                        padding: 14px 8px;
                                    ">
                                        <div style="font-size: 22px; font-weight: 800; margin-bottom: 2px;">${playerStats.totalPoints}</div>
                                        <div style="font-size: 10px; opacity: 0.9;">총 점수</div>
                                    </div>
                                    <div style="
                                        text-align: center; 
                                        background: linear-gradient(135deg, #48bb78, #38a169); 
                                        color: white;
                                        border-radius: 10px; 
                                        padding: 14px 8px;
                                    ">
                                        <div style="font-size: 22px; font-weight: 800; margin-bottom: 2px;">${playerStats.winRate}%</div>
                                        <div style="font-size: 10px; opacity: 0.9;">승률</div>
                                    </div>
                                </div>
                                
                                <div style="
                                    display: grid;
                                    grid-template-columns: repeat(4, 1fr);
                                    gap: 8px;
                                ">
                                    <div style="text-align: center; background: #f7fafc; border-radius: 8px; padding: 10px 4px;">
                                        <div style="font-size: 16px; font-weight: 700; color: #4a5568; margin-bottom: 2px;">${playerStats.totalMatches}</div>
                                        <div style="font-size: 9px; color: #718096;">총 경기</div>
                                    </div>
                                    <div style="text-align: center; background: #f0fff4; border-radius: 8px; padding: 10px 4px;">
                                        <div style="font-size: 16px; font-weight: 700; color: #38a169; margin-bottom: 2px;">${playerStats.wins}</div>
                                        <div style="font-size: 9px; color: #68d391;">승</div>
                                    </div>
                                    <div style="text-align: center; background: #fffbf0; border-radius: 8px; padding: 10px 4px;">
                                        <div style="font-size: 16px; font-weight: 700; color: #d69e2e; margin-bottom: 2px;">${playerStats.draws}</div>
                                        <div style="font-size: 9px; color: #f6ad55;">무</div>
                                    </div>
                                    <div style="text-align: center; background: #fff5f5; border-radius: 8px; padding: 10px 4px;">
                                        <div style="font-size: 16px; font-weight: 700; color: #e53e3e; margin-bottom: 2px;">${playerStats.losses}</div>
                                        <div style="font-size: 9px; color: #fc8181;">패</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 경기 유형별 현황 -->
                            <div style="
                                background: white;
                                border-radius: 12px;
                                padding: 16px;
                                margin-bottom: 16px;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                            ">
                                <div style="
                                    font-size: 14px;
                                    font-weight: 700;
                                    color: #1a202c;
                                    margin-bottom: 12px;
                                    display: flex;
                                    align-items: center;
                                    gap: 6px;
                                ">
                                    🏸 경기 유형별 현황
                                </div>
                                <div style="display: grid; gap: 8px;">
                                    ${playerStats.singles > 0 ? `
                                        <div style="
                                            display: flex;
                                            justify-content: space-between;
                                            align-items: center;
                                            padding: 8px 12px;
                                            background: #f7fafc;
                                            border-radius: 8px;
                                            border-left: 3px solid #4299e1;
                                        ">
                                            <span style="font-size: 12px; font-weight: 600; color: #2d3748;">👤 단식</span>
                                            <span style="font-weight: 700; color: #4a5568; font-size: 12px;">${playerStats.singles}경기</span>
                                        </div>
                                    ` : ''}
                                    ${playerStats.menDoubles > 0 ? `
                                        <div style="
                                            display: flex;
                                            justify-content: space-between;
                                            align-items: center;
                                            padding: 8px 12px;
                                            background: #f0fff4;
                                            border-radius: 8px;
                                            border-left: 3px solid #48bb78;
                                        ">
                                            <span style="font-size: 12px; font-weight: 600; color: #2d3748;">👥 남복</span>
                                            <span style="font-weight: 700; color: #4a5568; font-size: 12px;">${playerStats.menDoubles}경기</span>
                                        </div>
                                    ` : ''}
                                    ${playerStats.womenDoubles > 0 ? `
                                        <div style="
                                            display: flex;
                                            justify-content: space-between;
                                            align-items: center;
                                            padding: 8px 12px;
                                            background: #fef5e7;
                                            border-radius: 8px;
                                            border-left: 3px solid #ed8936;
                                        ">
                                            <span style="font-size: 12px; font-weight: 600; color: #2d3748;">👭 여복</span>
                                            <span style="font-weight: 700; color: #4a5568; font-size: 12px;">${playerStats.womenDoubles}경기</span>
                                        </div>
                                    ` : ''}
                                    ${playerStats.mixedDoubles > 0 ? `
                                        <div style="
                                            display: flex;
                                            justify-content: space-between;
                                            align-items: center;
                                            padding: 8px 12px;
                                            background: #f0f4ff;
                                            border-radius: 8px;
                                            border-left: 3px solid #9f7aea;
                                        ">
                                            <span style="font-size: 12px; font-weight: 600; color: #2d3748;">👫 혼복</span>
                                            <span style="font-weight: 700; color: #4a5568; font-size: 12px;">${playerStats.mixedDoubles}경기</span>
                                        </div>
                                    ` : ''}
                                    ${playerStats.singles === 0 && playerStats.menDoubles === 0 && playerStats.womenDoubles === 0 && playerStats.mixedDoubles === 0 ? 
                                        '<div style="text-align: center; padding: 20px; color: #9ca3af; font-size: 12px;">경기 기록이 없습니다</div>' : ''
                                    }
                                </div>
                            </div>
                            
                            <!-- 최근 경기 기록 -->
                            <div style="
                                background: white;
                                border-radius: 12px;
                                padding: 16px;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                            ">
                                <div style="
                                    font-size: 14px;
                                    font-weight: 700;
                                    color: #1a202c;
                                    margin-bottom: 12px;
                                    display: flex;
                                    align-items: center;
                                    gap: 6px;
                                ">
                                    📋 최근 경기 기록
                                </div>
                                <div style="display: grid; gap: 8px; max-height: 200px; overflow-y: auto;">
                                    ${playerStats.recentMatches && playerStats.recentMatches.length > 0 
                                        ? playerStats.recentMatches.slice(0, 5).map(match => `
                                            <div style="
                                                padding: 10px 12px;
                                                background: ${match.result === 'W' ? '#f0fff4' : match.result === 'D' ? '#fffbf0' : '#fff5f5'};
                                                border-radius: 8px;
                                                border-left: 3px solid ${match.result === 'W' ? '#48bb78' : match.result === 'D' ? '#ed8936' : '#f56565'};
                                                display: flex;
                                                justify-content: space-between;
                                                align-items: center;
                                            ">
                                                <div style="flex: 1; min-width: 0;">
                                                    <div style="font-weight: 600; color: #2d3748; font-size: 11px; margin-bottom: 2px;">
                                                        ${match.type} vs ${match.opponent.length > 12 ? match.opponent.substring(0, 12) + '...' : match.opponent}
                                                    </div>
                                                    <div style="font-size: 9px; color: #718096;">
                                                        ${new Date(match.date).toLocaleDateString('ko-KR', { 
                                                            month: 'numeric', 
                                                            day: 'numeric' 
                                                        })}
                                                        ${match.partner && match.partner.length > 0 ? ` • <span style="color: #1f2937; cursor: pointer; text-decoration: underline;" onclick="navigateToPlayerStats('${match.partner}')">${match.partner.length > 6 ? match.partner.substring(0, 6) + '..' : match.partner}</span>` : ''}
                                                    </div>
                                                </div>
                                                <div style="text-align: right; margin-left: 8px;">
                                                    <div style="
                                                        font-size: 11px; 
                                                        font-weight: 700; 
                                                        color: ${match.result === 'W' ? '#38a169' : match.result === 'D' ? '#d69e2e' : '#e53e3e'};
                                                        margin-bottom: 1px;
                                                    ">
                                                        ${match.result === 'W' ? '승' : match.result === 'D' ? '무' : '패'}
                                                    </div>
                                                    <div style="font-size: 9px; color: #718096;">
                                                        ${match.score}
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')
                                        : '<div style="text-align: center; padding: 30px; color: #9ca3af; font-size: 12px;">등록된 경기가 없습니다</div>'
                                    }
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', newModalHtml);
            
            // 모달 외부 클릭시 닫기 - DISABLED: 메인 함수와 충돌 방지
            // document.getElementById('playerStatsModal').addEventListener('click', function(e) {
            //     if (e.target === this) {
            //         this.remove();
            //     }
            // });
        }
        
        // 고급 플레이어 통계 계산 함수 (완전한 구현)
        // 클럽 평균 통계 계산 함수
        function calculateClubAverages() {
            const saved = localStorage.getItem('rivalMatches');
            const allMatches = saved ? JSON.parse(saved) : [];
            
            
            const allPlayers = new Set();
            const playerStats = {};
            
            allMatches.forEach(match => {
                const scoreA = parseInt(match.scoreA) || 0;
                const scoreB = parseInt(match.scoreB) || 0;
                
                // 팀 데이터 추출 - 슬래시로 분리된 이름 처리
                const teamAString = match.teamA1 || match.teamA || '';
                const teamBString = match.teamB1 || match.teamB || '';
                
                const playersA = [];
                const playersB = [];
                
                // teamA 처리
                if (teamAString.includes('/')) {
                    teamAString.split('/').forEach(name => {
                        const trimmed = name.trim();
                        if (trimmed) {
                            playersA.push(trimmed);
                            // 게스트가 아닌 경우에만 전체 플레이어 목록에 추가
                            if (!trimmed.includes('게스트')) {
                                allPlayers.add(trimmed);
                            }
                        }
                    });
                } else if (teamAString.trim()) {
                    const trimmed = teamAString.trim();
                    playersA.push(trimmed);
                    // 게스트가 아닌 경우에만 전체 플레이어 목록에 추가
                    if (!trimmed.includes('게스트')) {
                        allPlayers.add(trimmed);
                    }
                }
                
                // teamB 처리
                if (teamBString.includes('/')) {
                    teamBString.split('/').forEach(name => {
                        const trimmed = name.trim();
                        if (trimmed) {
                            playersB.push(trimmed);
                            // 게스트가 아닌 경우에만 전체 플레이어 목록에 추가
                            if (!trimmed.includes('게스트')) {
                                allPlayers.add(trimmed);
                            }
                        }
                    });
                } else if (teamBString.trim()) {
                    const trimmed = teamBString.trim();
                    playersB.push(trimmed);
                    // 게스트가 아닌 경우에만 전체 플레이어 목록에 추가
                    if (!trimmed.includes('게스트')) {
                        allPlayers.add(trimmed);
                    }
                }
                
                // teamA2, teamB2도 추가 (구버전 호환)
                if (match.teamA2 && match.teamA2.trim()) {
                    playersA.push(match.teamA2.trim());
                    allPlayers.add(match.teamA2.trim());
                }
                if (match.teamB2 && match.teamB2.trim()) {
                    playersB.push(match.teamB2.trim());
                    allPlayers.add(match.teamB2.trim());
                }
                
                // 각 플레이어의 경기 결과 기록
                const isAWin = scoreA > scoreB;
                const isDraw = scoreA === scoreB;
                
                playersA.forEach(player => {
                    // 게스트는 통계에서 제외
                    if (isGuestPlayer(player)) {
                        return;
                    }
                    if (!playerStats[player]) {
                        playerStats[player] = { wins: 0, losses: 0, draws: 0, totalMatches: 0 };
                    }
                    playerStats[player].totalMatches++;
                    if (isAWin) playerStats[player].wins++;
                    else if (isDraw) playerStats[player].draws++;
                    else playerStats[player].losses++;
                });
                
                playersB.forEach(player => {
                    // 게스트는 통계에서 제외
                    if (isGuestPlayer(player)) {
                        return;
                    }
                    if (!playerStats[player]) {
                        playerStats[player] = { wins: 0, losses: 0, draws: 0, totalMatches: 0 };
                    }
                    playerStats[player].totalMatches++;
                    if (!isAWin && !isDraw) playerStats[player].wins++;
                    else if (isDraw) playerStats[player].draws++;
                    else playerStats[player].losses++;
                });
            });
            
            // 활성 플레이어 필터링 (3경기 이상)
            const activePlayers = [];
            Object.entries(playerStats).forEach(([name, stats]) => {
                if (stats.totalMatches >= 3) {
                    const winRate = stats.totalMatches > 0 ? (stats.wins / stats.totalMatches * 100) : 0;
                    activePlayers.push({
                        ...stats,
                        winRate,
                        name
                    });
                }
            });
            
            const avgWinRate = activePlayers.length > 0 ? 
                activePlayers.reduce((sum, player) => sum + player.winRate, 0) / activePlayers.length : 0;
            const avgMatches = activePlayers.length > 0 ? 
                activePlayers.reduce((sum, player) => sum + player.totalMatches, 0) / activePlayers.length : 0;
            
            
            return {
                avgWinRate: avgWinRate,
                avgMatchesPerPlayer: avgMatches,
                totalPlayers: allPlayers.size,
                activePlayers: activePlayers.length,
                totalMatches: allMatches.length
            };
        }

        function calculateAdvancedPlayerStats(playerName) {
            // 개인 통계는 전체 경기 데이터로 계산
            const saved = localStorage.getItem('rivalMatches');
            const allMatches = saved ? JSON.parse(saved) : [];
            
            // 클럽 평균 통계 가져오기
            const clubAverages = calculateClubAverages();
            
            
            const stats = {
                name: playerName,
                wins: 0,
                losses: 0,
                draws: 0,
                totalMatches: 0,
                winRate: '0.0',
                currentStreakText: '연속 기록 없음',
                recentMatches: [],
                topPartners: [],
                maxWinStreak: 0,
                monthlyBest: 0,
                avgMatchesPerMonth: 0,
                recentActivity: '정보없음',
                partners: {},
                totalWins: 0,
                totalLosses: 0,
                totalDraws: 0,
                totalPoints: 0,
                thisMonthWins: 0,
                thisMonthLosses: 0,
                thisMonthDraws: 0,
                thisMonthMatches: 0,
                // 클럽 비교 데이터
                clubAverages: clubAverages,
                clubComparison: {
                    winRateVsClub: 0,
                    matchesVsClub: 0,
                    winRatePercentile: 0,
                    matchesPercentile: 0
                }
            };
            
            // 각 경기별 유형 카운트 저장
            const typeStats = {
                '남복': { wins: 0, losses: 0, draws: 0 },
                '여복': { wins: 0, losses: 0, draws: 0 },
                '혼복': { wins: 0, losses: 0, draws: 0 },
                '단식': { wins: 0, losses: 0, draws: 0 }
            };
            
            // 모든 경기 분석
            const playerMatches = [];
            allMatches.forEach((match, index) => {
                // 팀 데이터 추출 - teamA와 teamB 필드도 확인
                const teamA1 = match.teamA1 || match.teamA || '';
                const teamA2 = match.teamA2 || '';
                const teamB1 = match.teamB1 || match.teamB || '';
                const teamB2 = match.teamB2 || '';
                const scoreA = parseInt(match.scoreA) || 0;
                const scoreB = parseInt(match.scoreB) || 0;
                const matchType = match.matchType || '혼복';
                
                
                // 플레이어 추출 - 슬래시로 구분된 이름 처리
                const playersA = [];
                const playersB = [];
                
                // teamA1 또는 teamA 필드 처리
                const teamAString = teamA1 || match.teamA || '';
                const teamBString = teamB1 || match.teamB || '';
                
                // teamA 처리 - "조영식 / 이재호" 형식
                if (teamAString.includes('/')) {
                    teamAString.split('/').forEach(name => {
                        const trimmed = name.trim();
                        if (trimmed) playersA.push(trimmed);
                    });
                } else if (teamAString.trim()) {
                    // 단식이거나 이름에 슬래시가 없는 경우
                    playersA.push(teamAString.trim());
                }
                
                // teamB 처리 - "송민곤 / 채영수" 형식
                if (teamBString.includes('/')) {
                    teamBString.split('/').forEach(name => {
                        const trimmed = name.trim();
                        if (trimmed) playersB.push(trimmed);
                    });
                } else if (teamBString.trim()) {
                    // 단식이거나 이름에 슬래시가 없는 경우
                    playersB.push(teamBString.trim());
                }
                
                // teamA2, teamB2가 있으면 추가 (구버전 호환)
                if (teamA2 && teamA2.trim()) playersA.push(teamA2.trim());
                if (teamB2 && teamB2.trim()) playersB.push(teamB2.trim());
                
                // 해당 선수가 참여한 경기인지 확인 (정확한 매칭)
                let playerTeam = null;
                let isPlayerInMatch = false;
                let partner = null;
                let opponents = [];
                
                // 정확한 이름 매칭 (공백 제거후 비교)
                const cleanPlayerName = playerName.trim();
                const cleanPlayersA = playersA.map(p => p.trim());
                const cleanPlayersB = playersB.map(p => p.trim());
                
                if (cleanPlayersA.includes(cleanPlayerName)) {
                    playerTeam = 'A';
                    isPlayerInMatch = true;
                    partner = cleanPlayersA.find(p => p !== cleanPlayerName);
                    opponents = cleanPlayersB;
                } else if (cleanPlayersB.includes(cleanPlayerName)) {
                    playerTeam = 'B';
                    isPlayerInMatch = true;
                    partner = cleanPlayersB.find(p => p !== cleanPlayerName);
                    opponents = cleanPlayersA;
                }
                
                if (!isPlayerInMatch) {
                    // 디버깅용 - 매칭 안된 경기 확인
                    if (match.teamA1 && (match.teamA1.includes(cleanPlayerName) || match.teamB1 && match.teamB1.includes(cleanPlayerName))) {
                        console.log('매칭 실패 경기:', match);
                        console.log('playersA:', cleanPlayersA);
                        console.log('playersB:', cleanPlayersB);
                        console.log('cleanPlayerName:', cleanPlayerName);
                    }
                    return;
                }
                
                stats.totalMatches++;
                
                // 경기 날짜 확인 (이번달 전적 계산용)
                const matchDate = new Date(match.timestamp || match.date || Date.now());
                const currentDate = new Date();
                const isThisMonth = matchDate.getFullYear() === currentDate.getFullYear() && 
                                  matchDate.getMonth() === currentDate.getMonth();
                
                // 경기 결과 판정
                const isWin = (playerTeam === 'A' && scoreA > scoreB) || (playerTeam === 'B' && scoreB > scoreA);
                const isDraw = scoreA === scoreB;
                const isLoss = !isWin && !isDraw;
                
                // 전적 업데이트
                if (isWin) {
                    stats.totalWins++;
                    stats.totalPoints += 3;
                    typeStats[matchType].wins++;
                    if (isThisMonth) stats.thisMonthWins++;
                } else if (isDraw) {
                    stats.totalDraws++;
                    stats.totalPoints += 1;
                    typeStats[matchType].draws++;
                    if (isThisMonth) stats.thisMonthDraws++;
                } else {
                    stats.totalLosses++;
                    stats.totalPoints = Math.max(0, stats.totalPoints - 1);
                    typeStats[matchType].losses++;
                    if (isThisMonth) stats.thisMonthLosses++;
                }
                
                // 이번달 경기수 카운트
                if (isThisMonth) {
                    stats.thisMonthMatches++;
                }
                
                // 경기 유형별 카운트
                if (matchType === '단식') {
                    stats.singles++;
                    stats.singlesWins = typeStats['단식'].wins;
                    stats.singlesLosses = typeStats['단식'].losses;
                } else if (matchType === '남복') {
                    stats.menDoubles++;
                } else if (matchType === '여복') {
                    stats.womenDoubles++;
                } else {
                    stats.mixedDoubles++;
                }
                
                // 파트너 통계 (복식만)
                if (partner && matchType !== '단식') {
                    if (!stats.partners[partner]) {
                        stats.partners[partner] = { wins: 0, losses: 0, draws: 0 };
                    }
                    if (isWin) stats.partners[partner].wins++;
                    else if (isDraw) stats.partners[partner].draws++;
                    else stats.partners[partner].losses++;
                }
                
                // 최근 경기 기록 추가
                playerMatches.push({
                    date: match.timestamp || match.date || Date.now(),
                    type: matchType,
                    opponent: opponents.join(' / '),
                    partner: partner,
                    score: playerTeam === 'A' ? `${scoreA}-${scoreB}` : `${scoreB}-${scoreA}`,
                    result: isWin ? 'W' : (isDraw ? 'D' : 'L')
                });
            });
            
            // 경기 유형별 전적 문자열 생성 (승-무-패 순서)
            stats.menDoublesRecord = `${typeStats['남복'].wins}승 ${typeStats['남복'].draws}무 ${typeStats['남복'].losses}패`;
            stats.womenDoublesRecord = `${typeStats['여복'].wins}승 ${typeStats['여복'].draws}무 ${typeStats['여복'].losses}패`;
            stats.mixedDoublesRecord = `${typeStats['혼복'].wins}승 ${typeStats['혼복'].draws}무 ${typeStats['혼복'].losses}패`;
            stats.singlesDraws = typeStats['단식'].draws;
            
            // 승률 계산
            if (stats.totalMatches > 0) {
                stats.winRate = Math.round((stats.totalWins / stats.totalMatches) * 100);
                
                // 클럽 평균과 비교 계산
                const playerWinRate = parseFloat(stats.winRate);
                stats.clubComparison.winRateVsClub = (playerWinRate - clubAverages.avgWinRate).toFixed(1);
                stats.clubComparison.matchesVsClub = (stats.totalMatches - clubAverages.avgMatchesPerPlayer).toFixed(1);
                
                // 클럽 내 순위 계산 (간단한 퍼센타일)
                const winRatePercentile = playerWinRate > clubAverages.avgWinRate ? 
                    Math.min(100, 50 + ((playerWinRate - clubAverages.avgWinRate) / clubAverages.avgWinRate * 50)) : 
                    Math.max(0, 50 - ((clubAverages.avgWinRate - playerWinRate) / clubAverages.avgWinRate * 50));
                stats.clubComparison.winRatePercentile = Math.round(winRatePercentile);
                
                const matchesPercentile = stats.totalMatches > clubAverages.avgMatchesPerPlayer ? 
                    Math.min(100, 50 + ((stats.totalMatches - clubAverages.avgMatchesPerPlayer) / clubAverages.avgMatchesPerPlayer * 50)) : 
                    Math.max(0, 50 - ((clubAverages.avgMatchesPerPlayer - stats.totalMatches) / clubAverages.avgMatchesPerPlayer * 50));
                stats.clubComparison.matchesPercentile = Math.round(matchesPercentile);
            }
            
            // 이번달 승률 계산
            if (stats.thisMonthMatches > 0) {
                stats.thisMonthWinRate = Math.round((stats.thisMonthWins / stats.thisMonthMatches) * 100);
            }
            
            // 최근 활동 패턴 분석
            if (playerMatches.length > 0) {
                const lastMatch = new Date(playerMatches[0].date);
                const now = new Date();
                const daysSinceLastMatch = Math.floor((now - lastMatch) / (1000 * 60 * 60 * 24));
                
                if (daysSinceLastMatch <= 7) {
                    stats.recentActivity = '매우 활발 🔥';
                } else if (daysSinceLastMatch <= 30) {
                    stats.recentActivity = '활발';
                } else if (daysSinceLastMatch <= 90) {
                    stats.recentActivity = '보통';
                } else {
                    stats.recentActivity = '비활성';
                }
                
                // 최근 한달간 경기 빈도 추가 분석
                const oneMonthAgo = new Date();
                oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                const recentMonthMatches = playerMatches.filter(match => 
                    new Date(match.date) >= oneMonthAgo
                ).length;
                
                if (recentMonthMatches >= 8) {
                    stats.recentActivity = '초고빈도 🚀';
                } else if (recentMonthMatches >= 5) {
                    stats.recentActivity = '고빈도 ⚡';
                } else if (recentMonthMatches >= 2) {
                    stats.recentActivity = '정상 빈도';
                } else if (recentMonthMatches >= 1) {
                    stats.recentActivity = '저빈도';
                } else {
                    stats.recentActivity = '휴면 상태 😴';
                }
            }
            
            // 월별 통계 계산
            const monthlyData = {};
            
            playerMatches.forEach(match => {
                const date = new Date(match.date);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const monthKey = `${year}-${month.toString().padStart(2, '0')}`;
                const monthLabel = `${month}월`;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { label: monthLabel, wins: 0, losses: 0, draws: 0 };
                }
                
                if (match.result === 'W') monthlyData[monthKey].wins++;
                else if (match.result === 'L') monthlyData[monthKey].losses++;
                else monthlyData[monthKey].draws++;
            });
            
            // 월례대회 분기별 성적 계산
            const monthlyTournamentStats = calculateMonthlyTournamentStats(allMatches, playerName);
            stats.monthlyTournamentStats = monthlyTournamentStats;
            
            // 월간 최다승 계산
            stats.monthlyBest = Math.max(...Object.values(monthlyData).map(d => d.wins), 0);
            
            // 월평균 경기 계산
            const monthCount = Object.keys(monthlyData).length || 1;
            stats.avgMatchesPerMonth = monthCount > 0 ? (stats.totalMatches / monthCount).toFixed(1) : '0.0';
            
            // 월별 데이터를 stats에 추가
            stats.monthlyData = monthlyData;
            
            // 월별 승률 계산
            stats.monthlyWinRates = {};
            Object.entries(monthlyData).forEach(([key, data]) => {
                const total = data.wins + data.losses + data.draws;
                stats.monthlyWinRates[key] = {
                    label: data.label,
                    winRate: total > 0 ? ((data.wins / total) * 100).toFixed(1) : '0.0',
                    total: total,
                    wins: data.wins,
                    losses: data.losses,
                    draws: data.draws
                };
            });
            
            // 최대 연승/연패 계산
            let currentWinStreak = 0, currentLoseStreak = 0;
            let maxWinStreak = 0, maxLoseStreak = 0;
            
            // 날짜순으로 정렬후 연승/연패 계산
            const sortedMatches = [...playerMatches].sort((a, b) => new Date(a.date) - new Date(b.date));
            sortedMatches.forEach(match => {
                if (match.result === 'W') {
                    currentWinStreak++;
                    currentLoseStreak = 0;
                    maxWinStreak = Math.max(maxWinStreak, currentWinStreak);
                } else if (match.result === 'L') {
                    currentLoseStreak++;
                    currentWinStreak = 0;
                    maxLoseStreak = Math.max(maxLoseStreak, currentLoseStreak);
                } else {
                    currentWinStreak = 0;
                    currentLoseStreak = 0;
                }
            });
            
            stats.maxWinStreak = maxWinStreak;
            stats.maxLoseStreak = maxLoseStreak;
            
            // 최근 경기 정렬 (최신순) 및 상위 5개만 + 팀 정보 추가
            playerMatches.sort((a, b) => new Date(b.date) - new Date(a.date));
            stats.recentMatches = playerMatches.slice(0, 5).map(match => ({
                ...match,
                myTeam: match.partner ? `${playerName} / ${match.partner}` : playerName
            }));
            
            // 현재 연승/연패 계산
            if (stats.recentMatches.length > 0) {
                let streak = 0;
                const firstResult = stats.recentMatches[0].result;
                for (let match of stats.recentMatches) {
                    if (match.result === firstResult && firstResult !== 'D') {
                        streak++;
                    } else {
                        break;
                    }
                }
                if (firstResult === 'W') {
                    stats.currentStreak = streak;
                    stats.currentStreakText = `${streak}연승 중 🔥`;
                } else if (firstResult === 'L') {
                    stats.currentStreak = -streak;
                    stats.currentStreakText = `${streak}연패 중 😢`;
                } else {
                    stats.currentStreakText = '연속 기록 없음';
                }
            }
            
            // 파트너 리스트 생성 (승률순 정렬)
            stats.partnersList = Object.entries(stats.partners)
                .map(([name, record]) => ({
                    name,
                    wins: record.wins,
                    losses: record.losses,
                    draws: record.draws,
                    total: record.wins + record.losses + record.draws,
                    winRate: ((record.wins / (record.wins + record.losses + record.draws)) * 100).toFixed(1)
                }))
                .sort((a, b) => parseFloat(b.winRate) - parseFloat(a.winRate));
            
            // 현재 순위 계산 - 전체 플레이어의 승점 기준으로 계산
            const allPlayerStats = {};
            
            // 모든 경기를 분석하여 각 플레이어의 승점 계산
            allMatches.forEach(match => {
                const teamA1 = match.teamA1 || match.teamA || '';
                const teamA2 = match.teamA2 || '';
                const teamB1 = match.teamB1 || match.teamB || '';
                const teamB2 = match.teamB2 || '';
                const scoreA = parseInt(match.scoreA) || 0;
                const scoreB = parseInt(match.scoreB) || 0;
                
                // 플레이어 추출
                const playersA = [];
                const playersB = [];
                
                // teamA 처리
                const teamAString = teamA1 || match.teamA || '';
                if (teamAString.includes('/')) {
                    teamAString.split('/').forEach(name => {
                        const trimmed = name.trim();
                        if (trimmed) playersA.push(trimmed);
                    });
                } else if (teamAString.trim()) {
                    playersA.push(teamAString.trim());
                }
                
                // teamB 처리
                const teamBString = teamB1 || match.teamB || '';
                if (teamBString.includes('/')) {
                    teamBString.split('/').forEach(name => {
                        const trimmed = name.trim();
                        if (trimmed) playersB.push(trimmed);
                    });
                } else if (teamBString.trim()) {
                    playersB.push(teamBString.trim());
                }
                
                // teamA2, teamB2 추가
                if (teamA2 && teamA2.trim()) playersA.push(teamA2.trim());
                if (teamB2 && teamB2.trim()) playersB.push(teamB2.trim());
                
                // 플레이어별 승점 계산
                [...playersA, ...playersB].forEach(player => {
                    if (!allPlayerStats[player]) {
                        allPlayerStats[player] = { points: 0 };
                    }
                });
                
                // 승점 부여
                playersA.forEach(player => {
                    if (scoreA > scoreB) {
                        allPlayerStats[player].points += 3; // 승리
                    } else if (scoreA === scoreB) {
                        allPlayerStats[player].points += 1; // 무승부
                    } else {
                        allPlayerStats[player].points = Math.max(0, allPlayerStats[player].points - 1); // 패배
                    }
                });
                
                playersB.forEach(player => {
                    if (scoreB > scoreA) {
                        allPlayerStats[player].points += 3; // 승리
                    } else if (scoreB === scoreA) {
                        allPlayerStats[player].points += 1; // 무승부
                    } else {
                        allPlayerStats[player].points = Math.max(0, allPlayerStats[player].points - 1); // 패배
                    }
                });
            });
            
            // 순위 계산
            const sortedPlayers = Object.entries(allPlayerStats)
                .map(([name, data]) => ({ name, points: data.points }))
                .sort((a, b) => b.points - a.points);
            
            // 현재 플레이어의 순위 찾기
            const playerRankIndex = sortedPlayers.findIndex(player => player.name === playerName);
            stats.rank = playerRankIndex >= 0 ? playerRankIndex + 1 : 0;
            
            // 호환성을 위해 totalWins/totalLosses/totalDraws를 wins/losses/draws로도 복사
            stats.wins = stats.totalWins;
            stats.losses = stats.totalLosses;
            stats.draws = stats.totalDraws;
            
            // ========== 추가 통계 계산 ==========
            
            // 1. 점수차 분석
            let bigWins = 0, closeGames = 0, bigLosses = 0;
            let totalScoreFor = 0, totalScoreAgainst = 0, scoreGames = 0;
            
            playerMatches.forEach(match => {
                if (match.score && match.score.includes('-')) {
                    const [myScore, oppScore] = match.score.split('-').map(s => parseInt(s.trim()));
                    if (!isNaN(myScore) && !isNaN(oppScore)) {
                        totalScoreFor += myScore;
                        totalScoreAgainst += oppScore;
                        scoreGames++;
                        
                        const diff = Math.abs(myScore - oppScore);
                        if (diff >= 3) {
                            if (match.result === 'W') bigWins++;
                            else if (match.result === 'L') bigLosses++;
                        } else {
                            closeGames++;
                        }
                    }
                }
            });
            
            // 2. 파트너십 분석 (게스트 제외, 정확한 경기 데이터 기반)
            const partnerAnalysis = {};
            let bestWinRatePartner = null;
            let mostGamesPartner = null;
            let chemistryNeededPartner = null;
            
            // allMatches에서 직접 파트너 정보 추출 (정확한 데이터)
            allMatches.forEach(match => {
                const playersA = extractPlayers(match.teamA);
                const playersB = extractPlayers(match.teamB);
                
                let playerPartner = null;
                let playerTeam = null;
                let isWin = false;
                let isDraw = false;
                
                // 선택된 플레이어가 어느 팀에 속하는지 확인하고 파트너 찾기 (복식경기만)
                if (playersA.includes(playerName) && playersA.length === 2) {
                    // 플레이어가 팀A에 속하고 복식경기인 경우
                    playerPartner = playersA.find(p => p !== playerName);
                    playerTeam = 'A';
                } else if (playersB.includes(playerName) && playersB.length === 2) {
                    // 플레이어가 팀B에 속하고 복식경기인 경우
                    playerPartner = playersB.find(p => p !== playerName);
                    playerTeam = 'B';
                }
                
                // 파트너가 있고 게스트가 아닌 경우만 분석에 포함
                if (playerPartner && !isGuestPlayer(playerPartner)) {
                    if (!partnerAnalysis[playerPartner]) {
                        partnerAnalysis[playerPartner] = { 
                            games: 0, 
                            wins: 0, 
                            losses: 0, 
                            draws: 0,
                            bigWins: 0, // 3점차 이상 승리
                            closeGames: 0 // 접전 (1-2점차)
                        };
                    }
                    
                    const partner = partnerAnalysis[playerPartner];
                    partner.games++;
                    
                    // 승부 결과 계산
                    const scoreA = parseInt(match.scoreA || 0);
                    const scoreB = parseInt(match.scoreB || 0);
                    
                    if (scoreA === scoreB) {
                        // 무승부
                        partner.draws++;
                        isDraw = true;
                    } else {
                        // 승부 결정
                        if ((playerTeam === 'A' && scoreA > scoreB) || (playerTeam === 'B' && scoreB > scoreA)) {
                            // 승리
                            partner.wins++;
                            isWin = true;
                            
                            // 점수차 분석 (승리 시)
                            const diff = Math.abs(scoreA - scoreB);
                            if (diff >= 3) {
                                partner.bigWins++;
                            } else if (diff <= 2) {
                                partner.closeGames++;
                            }
                        } else {
                            // 패배
                            partner.losses++;
                            
                            // 패배한 접전도 카운트
                            const diff = Math.abs(scoreA - scoreB);
                            if (diff <= 2) {
                                partner.closeGames++;
                            }
                        }
                    }
                }
            });
            
            // 파트너 분석 결과 (게스트 제외된 파트너들만)
            const partnerList = Object.entries(partnerAnalysis)
                .filter(([name, stats]) => stats.games >= 2) // 2경기 이상만
                .map(([name, stats]) => ({
                    name,
                    ...stats,
                    winRate: stats.games > 0 ? Math.round((stats.wins / stats.games) * 100) : 0
                }));
            
            // 베스트 파트너 찾기 (모두 게스트 제외된 파트너들 중에서)
            if (partnerList.length > 0) {
                // 🏆 최고 승률 파트너 (2경기 이상, 게스트 제외, 승률 동일시 승수 우선)
                bestWinRatePartner = partnerList
                    .filter(p => p.games >= 2)
                    .sort((a, b) => {
                        if (b.winRate !== a.winRate) {
                            return b.winRate - a.winRate; // 승률 우선
                        }
                        return b.wins - a.wins; // 승률 같으면 승수 우선
                    })[0];
                
                // 👥 최다 동반 파트너 (게스트 제외)
                mostGamesPartner = partnerList
                    .sort((a, b) => b.games - a.games)[0];
                
                
                // 💪 케미가 필요한 파트너 (승률이 낮은, 2경기 이상, 게스트 제외)
                chemistryNeededPartner = partnerList
                    .filter(p => p.games >= 2)
                    .sort((a, b) => {
                        if (a.winRate !== b.winRate) {
                            return a.winRate - b.winRate; // 승률 낮은 순
                        }
                        return a.wins - b.wins; // 승률 같으면 승수 적은 순
                    })[0];
            }
            
            // 3. 시간/요일 패턴 분석
            let weekdayGames = 0, weekendGames = 0;
            let weekdayWins = 0, weekendWins = 0;
            
            playerMatches.forEach(match => {
                const date = new Date(match.date);
                const dayOfWeek = date.getDay(); // 0=일요일, 6=토요일
                
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    weekendGames++;
                    if (match.result === 'W') weekendWins++;
                } else {
                    weekdayGames++;
                    if (match.result === 'W') weekdayWins++;
                }
            });
            
            // 4. 최근 성과 vs 이전 성과 (최근 10경기 고정)
            const recentMatches = playerMatches.slice(0, Math.min(10, playerMatches.length));
            const olderMatches = playerMatches.slice(10);
            
            const recentWins = recentMatches.filter(m => m.result === 'W').length;
            const olderWins = olderMatches.filter(m => m.result === 'W').length;
            
            const recentWinRate = recentMatches.length > 0 ? (recentWins / recentMatches.length * 100) : 0;
            const olderWinRate = olderMatches.length > 0 ? (olderWins / olderMatches.length * 100) : 0;
            
            // 5. 연속 참가 기간
            const sortedDates = playerMatches.map(m => new Date(m.date)).sort((a, b) => a - b);
            let continuousMonths = 0;
            if (sortedDates.length > 0) {
                const firstMatch = sortedDates[0];
                const lastMatch = sortedDates[sortedDates.length - 1];
                const diffTime = Math.abs(lastMatch - firstMatch);
                continuousMonths = Math.max(1, Math.round(diffTime / (1000 * 60 * 60 * 24 * 30.44))); // 30.44일 = 평균 월
            }
            
            // 통계 객체에 추가
            stats.advancedStats = {
                // 점수 분석
                bigWins: bigWins,
                closeGames: closeGames,
                bigLosses: bigLosses,
                avgScoreFor: scoreGames > 0 ? (totalScoreFor / scoreGames).toFixed(1) : '0.0',
                avgScoreAgainst: scoreGames > 0 ? (totalScoreAgainst / scoreGames).toFixed(1) : '0.0',
                bigWinRate: playerMatches.length > 0 ? ((bigWins / playerMatches.length) * 100).toFixed(1) : '0.0',
                closeGameRate: playerMatches.length > 0 ? ((closeGames / playerMatches.length) * 100).toFixed(1) : '0.0',
                
                // 파트너십 (새로운 흥미로운 지표들)
                bestWinRatePartner: bestWinRatePartner ? {
                    name: bestWinRatePartner.name,
                    winRate: bestWinRatePartner.winRate.toFixed(1),
                    games: bestWinRatePartner.games
                } : null,
                mostGamesPartner: mostGamesPartner ? {
                    name: mostGamesPartner.name,
                    games: mostGamesPartner.games,
                    winRate: mostGamesPartner.winRate.toFixed(1)
                } : null,
                chemistryNeededPartner: chemistryNeededPartner ? {
                    name: chemistryNeededPartner.name,
                    winRate: chemistryNeededPartner.winRate.toFixed(1),
                    games: chemistryNeededPartner.games,
                    losses: chemistryNeededPartner.losses
                } : null,
                
                // 시간 패턴
                weekdayWinRate: weekdayGames > 0 ? ((weekdayWins / weekdayGames) * 100).toFixed(1) : '0.0',
                weekendWinRate: weekendGames > 0 ? ((weekendWins / weekendGames) * 100).toFixed(1) : '0.0',
                weekdayGames: weekdayGames,
                weekendGames: weekendGames,
                
                // 성장 지표
                recentWinRate: recentWinRate.toFixed(1),
                olderWinRate: olderWinRate.toFixed(1),
                improvement: (recentWinRate - olderWinRate).toFixed(1),
                recentGames: recentMatches.length,
                continuousMonths: continuousMonths,
                
                // 경기 유형별 (이미 있지만 정리)
                menDoublesGames: typeStats['남복'] ? (typeStats['남복'].wins + typeStats['남복'].losses + typeStats['남복'].draws) : 0,
                womenDoublesGames: typeStats['여복'] ? (typeStats['여복'].wins + typeStats['여복'].losses + typeStats['여복'].draws) : 0,
                mixedDoublesGames: typeStats['혼복'] ? (typeStats['혼복'].wins + typeStats['혼복'].losses + typeStats['혼복'].draws) : 0,
                singlesGames: typeStats['단식'] ? (typeStats['단식'].wins + typeStats['단식'].losses + typeStats['단식'].draws) : 0,
                menDoublesWinRate: typeStats['남복'] && (typeStats['남복'].wins + typeStats['남복'].losses + typeStats['남복'].draws) > 0 ? 
                    ((typeStats['남복'].wins / (typeStats['남복'].wins + typeStats['남복'].losses + typeStats['남복'].draws)) * 100).toFixed(1) : '0.0',
                womenDoublesWinRate: typeStats['여복'] && (typeStats['여복'].wins + typeStats['여복'].losses + typeStats['여복'].draws) > 0 ? 
                    ((typeStats['여복'].wins / (typeStats['여복'].wins + typeStats['여복'].losses + typeStats['여복'].draws)) * 100).toFixed(1) : '0.0',
                mixedDoublesWinRate: typeStats['혼복'] && (typeStats['혼복'].wins + typeStats['혼복'].losses + typeStats['혼복'].draws) > 0 ? 
                    ((typeStats['혼복'].wins / (typeStats['혼복'].wins + typeStats['혼복'].losses + typeStats['혼복'].draws)) * 100).toFixed(1) : '0.0',
                singlesWinRate: typeStats['단식'] && (typeStats['단식'].wins + typeStats['단식'].losses + typeStats['단식'].draws) > 0 ? 
                    ((typeStats['단식'].wins / (typeStats['단식'].wins + typeStats['단식'].losses + typeStats['단식'].draws)) * 100).toFixed(1) : '0.0'
            };
            
            // 개인 통계: 파트너별 승률 계산 (게스트 제외, 상위 5개만 표시)
            const partnerStats = {};
            const thisMonth = new Date();
            const thisMonthKey = `${thisMonth.getFullYear()}-${String(thisMonth.getMonth() + 1).padStart(2, '0')}`;
            
            // 모든 경기를 순회하면서 파트너별 통계 수집
            allMatches.forEach(match => {
                const playersA = extractPlayers(match.teamA);
                const playersB = extractPlayers(match.teamB);
                const matchDate = new Date(match.date || match.timestamp);
                const matchMonthKey = `${matchDate.getFullYear()}-${String(matchDate.getMonth() + 1).padStart(2, '0')}`;
                const isThisMonth = matchMonthKey === thisMonthKey; // 이번 달 경기인지 확인
                
                let playerPartner = null;
                let playerTeam = null;
                let opponentTeam = null;
                
                // 선택된 플레이어가 어느 팀에 속하는지 확인하고 파트너 찾기 (복식경기만)
                if (playersA.includes(playerName) && playersA.length === 2) {
                    // 플레이어가 팀A에 속하고 복식경기인 경우
                    playerPartner = playersA.find(p => p !== playerName); // 파트너 찾기
                    playerTeam = playersA;
                    opponentTeam = playersB;
                } else if (playersB.includes(playerName) && playersB.length === 2) {
                    // 플레이어가 팀B에 속하고 복식경기인 경우
                    playerPartner = playersB.find(p => p !== playerName); // 파트너 찾기
                    playerTeam = playersB;
                    opponentTeam = playersA;
                }
                
                // 파트너가 있고 게스트가 아닌 경우에만 통계에 포함
                if (playerPartner && !isGuestPlayer(playerPartner)) {
                    // 파트너 통계 객체 초기화 (처음 등장하는 파트너인 경우)
                    if (!partnerStats[playerPartner]) {
                        partnerStats[playerPartner] = {
                            totalWins: 0,      // 전체 승리
                            totalDraws: 0,     // 전체 무승부
                            totalLosses: 0,    // 전체 패배
                            totalGames: 0,     // 전체 경기수
                            thisMonthWins: 0,  // 이번달 승리
                            thisMonthDraws: 0, // 이번달 무승부
                            thisMonthLosses: 0,// 이번달 패배
                            thisMonthGames: 0  // 이번달 경기수
                        };
                    }
                    
                    // 경기수 증가
                    partnerStats[playerPartner].totalGames++;
                    if (isThisMonth) {
                        partnerStats[playerPartner].thisMonthGames++;
                    }
                    
                    // 승부 결과 분석 및 통계 업데이트
                    const scoreA = parseInt(match.scoreA || 0);
                    const scoreB = parseInt(match.scoreB || 0);
                    
                    if (scoreA === scoreB) {
                        // 무승부인 경우
                        partnerStats[playerPartner].totalDraws++;
                        if (isThisMonth) {
                            partnerStats[playerPartner].thisMonthDraws++;
                        }
                    } else {
                        // 승부가 결정된 경우 승리/패배 판정
                        let isWin = false;
                        if (playerTeam === playersA && scoreA > scoreB) {
                            isWin = true; // 팀A로 참여하여 승리
                        } else if (playerTeam === playersB && scoreB > scoreA) {
                            isWin = true; // 팀B로 참여하여 승리
                        }
                        
                        if (isWin) {
                            // 승리한 경우
                            partnerStats[playerPartner].totalWins++;
                            if (isThisMonth) {
                                partnerStats[playerPartner].thisMonthWins++;
                            }
                        } else {
                            // 패배한 경우
                            partnerStats[playerPartner].totalLosses++;
                            if (isThisMonth) {
                                partnerStats[playerPartner].thisMonthLosses++;
                            }
                        }
                    }
                }
            });
            
            // 파트너별 승률 정렬 (상위 5개만 표시, 승률 동일시 승수 우선)
            stats.partnerWinRates = Object.entries(partnerStats)
                .map(([partnerName, data]) => ({
                    name: partnerName,
                    totalWins: data.totalWins,
                    totalDraws: data.totalDraws,
                    totalLosses: data.totalLosses,
                    totalGames: data.totalGames,
                    totalWinRate: data.totalGames > 0 ? Math.round((data.totalWins / data.totalGames) * 100) : 0,
                    thisMonthWins: data.thisMonthWins,
                    thisMonthDraws: data.thisMonthDraws,
                    thisMonthLosses: data.thisMonthLosses,
                    thisMonthGames: data.thisMonthGames,
                    thisMonthWinRate: data.thisMonthGames > 0 ? Math.round((data.thisMonthWins / data.thisMonthGames) * 100) : 0
                }))
                .sort((a, b) => {
                    // 1순위: 승률 높은 순
                    if (b.totalWinRate !== a.totalWinRate) {
                        return b.totalWinRate - a.totalWinRate;
                    }
                    // 2순위: 승률이 같을 때 승수 많은 순
                    if (b.totalWins !== a.totalWins) {
                        return b.totalWins - a.totalWins;
                    }
                    // 3순위: 경기수 많은 순
                    return b.totalGames - a.totalGames;
                })
                .slice(0, 5); // 상위 5개만 선택
            
            // 파트너하지 않은 플레이어 찾기
            const allPlayers = new Set();
            const partneredPlayers = new Set(Object.keys(partnerStats));
            
            allMatches.forEach(match => {
                const playersA = extractPlayers(match.teamA);
                const playersB = extractPlayers(match.teamB);
                [...playersA, ...playersB].forEach(player => {
                    // 본인과 게스트를 제외한 플레이어만 추가
                    if (player !== playerName && !isGuestPlayer(player)) {
                        allPlayers.add(player);
                    }
                });
            });
            
            stats.unpartneredPlayers = Array.from(allPlayers).filter(player => !partneredPlayers.has(player));
            
            return stats;
        }

        // 클럽 통계 필터 상태
        let clubStatsPeriod = 'month';

        // 클럽 통계 기간 필터 설정
        function setClubStatsPeriod(period) {
            clubStatsPeriod = period;
            
            // 버튼 활성화 상태 업데이트
            document.querySelectorAll('.period-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`clubStatsPeriod${period === 'all' ? 'All' : 'Month'}`).classList.add('active');
            
            // 클럽 통계 업데이트
            updateClubStats();
        }

        // 클럽 통계 업데이트 함수
        function updateClubStats() {
            // 필터에 따라 경기 데이터 선택
            let filteredMatches = matches;
            if (clubStatsPeriod === 'month') {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                filteredMatches = matches.filter(match => {
                    const matchDate = new Date(match.date || match.timestamp);
                    return matchDate.getMonth() === currentMonth && matchDate.getFullYear() === currentYear;
                });
            }
            
            if (filteredMatches.length === 0) {
                const emptyText = clubStatsPeriod === 'month' ? 
                    '이번달 경기 기록이 없습니다' : 
                    '경기 기록이 쌓이면 클럽 전체 통계를 확인할 수 있습니다';
                    
                document.getElementById('clubStatsContainer').innerHTML = `
                    <div class="empty-stats" style="text-align: center; padding: 60px 20px; color: #6b7280;">
                        <div style="font-size: 64px; margin-bottom: 20px;">📈</div>
                        <h3>클럽 통계를 준비하고 있습니다</h3>
                        <p>${emptyText}</p>
                    </div>
                `;
                return;
            }

            const clubStats = calculateClubStats(filteredMatches);
            const monthlyTournamentStats = calculateClubMonthlyTournamentStats(filteredMatches);
            
            const clubStatsHtml = `
                <div class="club-stats-grid" style="
                    display: grid; 
                    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); 
                    gap: 16px; 
                    margin-bottom: 30px;
                    padding: 0 8px;
                ">
                    
                    <!-- 전체 경기 현황 -->
                    <div class="stat-card" style="
                        background: white; 
                        padding: 20px; 
                        border-radius: 12px; 
                        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
                        border: 1px solid #e5e7eb;
                        transition: transform 0.2s ease, box-shadow 0.2s ease;
                    ">
                        <div style="
                            margin-bottom: 16px;
                            padding-bottom: 12px;
                            border-bottom: 2px solid #f1f5f9;
                        ">
                            <h3 style="margin: 0; font-size: 15px; color: #1f2937; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                🏆 전체 경기 현황
                            </h3>
                        </div>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f8fafc;">
                                <span style="color: #374151; font-size: 14px;"> • 총 경기수</span>
                                <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${clubStats.totalMatches}경기</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f8fafc;">
                                <span style="color: #374151; font-size: 14px;"> • 월평균 경기</span>
                                <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${clubStats.monthlyAvgMatches}경기</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f8fafc;">
                                <span style="color: #374151; font-size: 14px;"> • 활성 플레이어</span>
                                <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${clubStats.activePlayers}명 <span style="font-size: 12px; color: #94a3b8;">(3경기 이상)</span></span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                <span style="color: #374151; font-size: 14px;"> • 누적 경기 등록자</span>
                                <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${clubStats.totalPlayersWithMatches}명</span>
                            </div>
                        </div>
                    </div>

                    <!-- 성장 트렌드 -->
                    <div class="stat-card" style="
                        background: white; 
                        padding: 20px; 
                        border-radius: 12px; 
                        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
                        border: 1px solid #e5e7eb;
                        transition: transform 0.2s ease, box-shadow 0.2s ease;
                    ">
                        <div style="
                            margin-bottom: 16px;
                            padding-bottom: 12px;
                            border-bottom: 2px solid #f1f5f9;
                        ">
                            <h3 style="margin: 0; font-size: 15px; color: #1f2937; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                📈 성장 트렌드
                            </h3>
                        </div>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f8fafc;">
                                <span style="color: #374151; font-size: 14px;"> • 월간 경기수 증가율</span>
                                <span style="color: #1f2937; font-weight: 600; font-size: 16px;">${clubStats.monthlyGrowthRate >= 0 ? '+' + clubStats.monthlyGrowthRate + '%' : clubStats.monthlyGrowthRate + '%'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f8fafc;">
                                <span style="color: #374151; font-size: 14px;"> • 신규 활성 플레이어</span>
                                <span style="color: #1f2937; font-weight: 600; font-size: 16px;">${clubStats.newActivePlayers}명</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                <span style="color: #374151; font-size: 14px;"> • 평균 경기 참여도</span>
                                <span style="color: #1f2937; font-weight: 600; font-size: 16px;">${clubStats.avgParticipation}%</span>
                            </div>
                        </div>
                    </div>

                    <!-- 경기 유형별 분포 -->
                    <div class="stat-card" style="
                        background: white; 
                        padding: 20px; 
                        border-radius: 12px; 
                        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
                        border: 1px solid #e5e7eb;
                        transition: transform 0.2s ease, box-shadow 0.2s ease;
                    ">
                        <div style="
                            margin-bottom: 16px;
                            padding-bottom: 12px;
                            border-bottom: 2px solid #f1f5f9;
                        ">
                            <h3 style="margin: 0; font-size: 15px; color: #1f2937; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                🎾 경기 유형별 분포
                            </h3>
                        </div>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; padding: 8px 0; border-bottom: 1px solid #f8fafc;">
                                <span style="color: #374151; font-size: 14px;"> • 남자복식</span>
                                <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                    <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${clubStats.matchTypes['남복'] || 0}경기 <span style="font-size: 12px; color: #94a3b8;">(${Math.round((clubStats.matchTypes['남복'] || 0) / clubStats.totalMatches * 100)}%)</span></span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; padding: 8px 0; border-bottom: 1px solid #f8fafc;">
                                <span style="color: #374151; font-size: 14px;"> • 여자복식</span>
                                <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                    <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${clubStats.matchTypes['여복'] || 0}경기 <span style="font-size: 12px; color: #94a3b8;">(${Math.round((clubStats.matchTypes['여복'] || 0) / clubStats.totalMatches * 100)}%)</span></span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; padding: 8px 0; border-bottom: 1px solid #f8fafc;">
                                <span style="color: #374151; font-size: 14px;"> • 혼합복식</span>
                                <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                    <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${clubStats.matchTypes['혼복'] || 0}경기 <span style="font-size: 12px; color: #94a3b8;">(${Math.round((clubStats.matchTypes['혼복'] || 0) / clubStats.totalMatches * 100)}%)</span></span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; padding: 8px 0;">
                                <span style="color: #374151; font-size: 14px;"> • 단식</span>
                                <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                    <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${clubStats.matchTypes['단식'] || 0}경기 <span style="font-size: 12px; color: #94a3b8;">(${Math.round((clubStats.matchTypes['단식'] || 0) / clubStats.totalMatches * 100)}%)</span></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 클럽 기록 -->
                    <div class="stat-card" style="
                        background: white; 
                        padding: 20px; 
                        border-radius: 12px; 
                        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
                        border: 1px solid #e5e7eb;
                        transition: transform 0.2s ease, box-shadow 0.2s ease;
                    ">
                        <div style="
                            margin-bottom: 16px;
                            padding-bottom: 12px;
                            border-bottom: 2px solid #f1f5f9;
                        ">
                            <h3 style="margin: 0; font-size: 15px; color: #1f2937; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                🏅 클럽 기록
                            </h3>
                        </div>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f8fafc;">
                                <span style="color: #374151; font-size: 14px;"> • 최다 연승자</span>
                                <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${clubStats.topWinStreakPlayer}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f8fafc;">
                                <span style="color: #374151; font-size: 14px;"> • 최고 승점자</span>
                                <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${clubStats.topPointsPlayer}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; padding: 8px 0; border-bottom: 1px solid #f8fafc;">
                                <span style="color: #374151; font-size: 14px;"> • 최다 경기 참가자</span>
                                <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                    <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${clubStats.mostActivePlayer}</span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f8fafc;">
                                <span style="color: #374151; font-size: 14px;"> • 최대 대승자</span>
                                <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${clubStats.topBigWinPlayer}</span>
                            </div>
                        </div>
                    </div>

                    <!-- 활동 패턴 -->
                    <div class="stat-card" style="
                        background: white; 
                        padding: 20px; 
                        border-radius: 12px; 
                        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
                        border: 1px solid #e5e7eb;
                        transition: transform 0.2s ease, box-shadow 0.2s ease;
                    ">
                        <div style="
                            margin-bottom: 16px;
                            padding-bottom: 12px;
                            border-bottom: 2px solid #f1f5f9;
                        ">
                            <h3 style="margin: 0; font-size: 15px; color: #1f2937; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                ⏰ 활동 패턴
                            </h3>
                        </div>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; padding: 8px 0; border-bottom: 1px solid #f8fafc;">
                                <span style="color: #374151; font-size: 14px;"> • 주중 경기</span>
                                <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                    <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${clubStats.weekdayMatches}경기 <span style="font-size: 12px; color: #94a3b8;">(${clubStats.weekdayPercent}%)</span></span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; padding: 8px 0; border-bottom: 1px solid #f8fafc;">
                                <span style="color: #374151; font-size: 14px;"> • 주말 경기</span>
                                <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                    <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${clubStats.weekendMatches}경기 <span style="font-size: 12px; color: #94a3b8;">(${clubStats.weekendPercent}%)</span></span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f8fafc;">
                                <span style="color: #374151; font-size: 14px;"> • 가장 활발한 월</span>
                                <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${clubStats.busiestMonth}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                <span style="color: #374151; font-size: 14px;"> • 최근 활동</span>
                                <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${clubStats.recentActivity}</span>
                            </div>
                        </div>
                    </div>

                    <!-- 파트너십 현황 -->
                    <div class="stat-card" style="
                        background: white; 
                        padding: 20px; 
                        border-radius: 12px; 
                        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
                        border: 1px solid #e5e7eb;
                        transition: transform 0.2s ease, box-shadow 0.2s ease;
                    ">
                        <div style="
                            margin-bottom: 16px;
                            padding-bottom: 12px;
                            border-bottom: 2px solid #f1f5f9;
                        ">
                            <h3 style="margin: 0; font-size: 15px; color: #1f2937; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                🤝 파트너십 현황
                            </h3>
                        </div>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f8fafc;">
                                <span style="color: #374151; font-size: 14px;"> • 총 파트너십</span>
                                <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${clubStats.totalPartnerships}개</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; padding: 8px 0; border-bottom: 1px solid #f8fafc;">
                                <span style="color: #374151; font-size: 14px;"> • 고정 파트너십</span>
                                <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                    <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${clubStats.fixedPartnerships}개 <span style="font-size: 12px; color: #94a3b8;">(3경기 이상)</span></span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f8fafc;">
                                <span style="color: #374151; font-size: 14px;"> • 평균 파트너 수</span>
                                <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${clubStats.avgPartnersPerPlayer}명</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f8fafc;">
                                <span style="color: #374151; font-size: 14px;"> • 최다 동반팀</span>
                                <span style="color: #1f2937; font-weight: 600; font-size: 13px;">${clubStats.mostPartnership}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; padding: 8px 0; border-bottom: 1px solid #f8fafc;">
                                <span style="color: #374151; font-size: 14px;"> • 최고 승률 파트너</span>
                                <span style="color: #1f2937; font-weight: 600; font-size: 13px; text-align: right; line-height: 1.4;">${clubStats.bestWinRatePartnership}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                <span style="color: #374151; font-size: 14px;"> • 복식 참가률</span>
                                <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${clubStats.doublesParticipation}%</span>
                            </div>
                        </div>
                    </div>

                    <!-- 월례대회 현황 -->
                    <div class="stat-card" style="
                        background: white; 
                        padding: 20px; 
                        border-radius: 12px; 
                        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
                        border: 1px solid #e5e7eb;
                        transition: transform 0.2s ease, box-shadow 0.2s ease;
                        grid-column: 1 / -1;
                    ">
                        <div style="
                            margin-bottom: 16px;
                            padding-bottom: 12px;
                            border-bottom: 2px solid #f1f5f9;
                        ">
                            <h3 style="margin: 0; font-size: 15px; color: #1f2937; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                🏆 월례대회 현황
                            </h3>
                        </div>
                        <div style="display: grid; gap: 16px;">
                            ${Object.entries(monthlyTournamentStats).map(([year, yearData]) => 
                                Object.entries(yearData).map(([quarter, quarterData]) => {
                                    if (quarterData.total === 0) return '';
                                    const presidentTotal = quarterData.presidentTeam.wins + quarterData.presidentTeam.losses + quarterData.presidentTeam.draws;
                                    const vicePresidentTotal = quarterData.vicePresidentTeam.wins + quarterData.vicePresidentTeam.losses + quarterData.vicePresidentTeam.draws;
                                    const presidentWinRate = presidentTotal > 0 ? Math.round((quarterData.presidentTeam.wins / presidentTotal) * 100) : 0;
                                    const vicePresidentWinRate = vicePresidentTotal > 0 ? Math.round((quarterData.vicePresidentTeam.wins / vicePresidentTotal) * 100) : 0;
                                    
                                    return `
                                        <div style="
                                            padding: 16px;
                                            background: #f8fafc;
                                            border-radius: 8px;
                                            border-left: 4px solid #f59e0b;
                                        ">
                                            <div style="margin-bottom: 16px;">
                                                <h4 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 600; color: #1f2937;">
                                                    ${year}년 ${quarter === 'Q1' ? '1분기' : quarter === 'Q2' ? '2분기' : quarter === 'Q3' ? '3분기' : '4분기'}
                                                    <span style="font-size: 12px; color: #6b7280; font-weight: normal;">(총 ${quarterData.total}경기)</span>
                                                </h4>
                                            </div>
                                            
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                                <!-- 회장팀 -->
                                                <div style="
                                                    background: white;
                                                    padding: 12px;
                                                    border-radius: 6px;
                                                    border: 1px solid #e5e7eb;
                                                ">
                                                    <div style="font-weight: 600; color: #059669; margin-bottom: 8px; font-size: 13px;">
                                                        👑 회장팀
                                                    </div>
                                                    <div style="font-size: 12px; color: #374151; margin-bottom: 6px;">
                                                        ${quarterData.presidentTeam.wins}승 ${quarterData.presidentTeam.draws}무 ${quarterData.presidentTeam.losses}패 
                                                        <span style="color: #059669; font-weight: 600;">(승률 ${presidentWinRate}%)</span>
                                                    </div>
                                                    <div style="font-size: 11px; color: #6b7280;">
                                                        ${Object.entries(quarterData.presidentTeam.details).map(([matchNum, detail]) => 
                                                            `• ${matchNum}: ${detail.wins}승 ${detail.draws}무 ${detail.losses}패`
                                                        ).join('<br>')}
                                                    </div>
                                                </div>
                                                
                                                <!-- 부회장팀 -->
                                                <div style="
                                                    background: white;
                                                    padding: 12px;
                                                    border-radius: 6px;
                                                    border: 1px solid #e5e7eb;
                                                ">
                                                    <div style="font-weight: 600; color: #dc2626; margin-bottom: 8px; font-size: 13px;">
                                                        🏅 부회장팀
                                                    </div>
                                                    <div style="font-size: 12px; color: #374151; margin-bottom: 6px;">
                                                        ${quarterData.vicePresidentTeam.wins}승 ${quarterData.vicePresidentTeam.draws}무 ${quarterData.vicePresidentTeam.losses}패 
                                                        <span style="color: #dc2626; font-weight: 600;">(승률 ${vicePresidentWinRate}%)</span>
                                                    </div>
                                                    <div style="font-size: 11px; color: #6b7280;">
                                                        ${Object.entries(quarterData.vicePresidentTeam.details).map(([matchNum, detail]) => 
                                                            `• ${matchNum}: ${detail.wins}승 ${detail.draws}무 ${detail.losses}패`
                                                        ).join('<br>')}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')
                            ).join('') || '<div style="text-align: center; color: #9ca3af; padding: 20px;">월례대회 기록이 없습니다</div>'}
                        </div>
                    </div>

                </div>
            `;
            
            document.getElementById('clubStatsContainer').innerHTML = clubStatsHtml;
        }

        // 클럽 통계 계산 함수
        function calculateClubStats(filteredMatches = matches) {
            const stats = {
                totalMatches: filteredMatches.length,
                totalPlayers: 0,
                activePlayers: 0,
                matchTypes: {},
                avgTotalScore: 0,
                avgScoreDiff: 0,
                maxScore: 0,
                closeGameRate: 0,
                bigWinRate: 0,
                weekdayMatches: 0,
                weekendMatches: 0,
                weekdayPercent: 0,
                weekendPercent: 0,
                totalPartnerships: 0,
                fixedPartnerships: 0,
                topPlayers: []
            };

            if (filteredMatches.length === 0) return stats;

            // 플레이어 통계 수집
            const playerStats = {};
            const partnerships = {};
            const monthlyData = {};
            let totalScore = 0;
            let totalScoreDiff = 0;
            let closeGames = 0;
            let bigWins = 0;

            filteredMatches.forEach(match => {
                // 경기 유형별 집계
                const type = match.matchType || '남복';
                stats.matchTypes[type] = (stats.matchTypes[type] || 0) + 1;

                // 점수 분석
                const scoreA = parseInt(match.scoreA || 0);
                const scoreB = parseInt(match.scoreB || 0);
                const total = scoreA + scoreB;
                const diff = Math.abs(scoreA - scoreB);
                
                totalScore += total;
                totalScoreDiff += diff;
                stats.maxScore = Math.max(stats.maxScore, Math.max(scoreA, scoreB));
                
                if (diff <= 2) closeGames++;
                if (diff >= 3) bigWins++;

                // 요일별 분석
                const date = new Date(match.date || match.timestamp);
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    stats.weekendMatches++;
                } else {
                    stats.weekdayMatches++;
                }

                // 월별 데이터
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[monthKey] = (monthlyData[monthKey] || 0) + 1;

                // 플레이어 통계
                const playersA = extractPlayers(match.teamA);
                const playersB = extractPlayers(match.teamB);
                
                [...playersA, ...playersB].forEach(player => {
                    // 게스트는 통계에서 제외
                    if (isGuestPlayer(player)) {
                        return;
                    }
                    
                    if (!playerStats[player]) {
                        playerStats[player] = { matches: 0, wins: 0, losses: 0, draws: 0, points: 0 };
                    }
                    playerStats[player].matches++;
                    
                    // 승패 계산
                    const isTeamA = playersA.includes(player);
                    if (scoreA > scoreB) {
                        if (isTeamA) {
                            playerStats[player].wins++;
                            playerStats[player].points += 3;
                        } else {
                            playerStats[player].losses++;
                            playerStats[player].points = Math.max(0, playerStats[player].points - 1);
                        }
                    } else if (scoreA < scoreB) {
                        if (!isTeamA) {
                            playerStats[player].wins++;
                            playerStats[player].points += 3;
                        } else {
                            playerStats[player].losses++;
                            playerStats[player].points = Math.max(0, playerStats[player].points - 1);
                        }
                    } else {
                        playerStats[player].draws++;
                        playerStats[player].points += 1;
                    }
                });

                // 파트너십 분석 (게스트 플레이어 제외)
                if (playersA.length > 1) {
                    // 게스트가 아닌 플레이어들로만 파트너십 구성
                    const nonGuestPlayersA = playersA.filter(player => !isGuestPlayer(player));
                    if (nonGuestPlayersA.length > 1) {
                        const partnership = nonGuestPlayersA.sort().join(' / ');
                        partnerships[partnership] = (partnerships[partnership] || 0) + 1;
                    }
                }
                if (playersB.length > 1) {
                    // 게스트가 아닌 플레이어들로만 파트너십 구성
                    const nonGuestPlayersB = playersB.filter(player => !isGuestPlayer(player));
                    if (nonGuestPlayersB.length > 1) {
                        const partnership = nonGuestPlayersB.sort().join(' / ');
                        partnerships[partnership] = (partnerships[partnership] || 0) + 1;
                    }
                }
            });

            // 계산된 통계
            stats.totalPlayers = Object.keys(playerStats).length;
            stats.totalPlayersWithMatches = Object.keys(playerStats).length; // 경기 등록한 플레이어만
            stats.activePlayers = Object.values(playerStats).filter(p => p.matches >= 3).length;
            
            // 이번달 활성 플레이어 계산
            const thisMonth = new Date();
            const thisMonthKey = `${thisMonth.getFullYear()}-${String(thisMonth.getMonth() + 1).padStart(2, '0')}`;
            const thisMonthPlayerStats = {};
            
            filteredMatches.forEach(match => {
                const matchDate = new Date(match.date || match.timestamp);
                const matchMonthKey = `${matchDate.getFullYear()}-${String(matchDate.getMonth() + 1).padStart(2, '0')}`;
                
                if (matchMonthKey === thisMonthKey) {
                    const playersA = extractPlayers(match.teamA);
                    const playersB = extractPlayers(match.teamB);
                    
                    [...playersA, ...playersB].forEach(player => {
                        if (!thisMonthPlayerStats[player]) {
                            thisMonthPlayerStats[player] = 0;
                        }
                        thisMonthPlayerStats[player]++;
                    });
                }
            });
            
            stats.thisMonthActivePlayers = Object.values(thisMonthPlayerStats).filter(matches => matches >= 3).length;
            stats.closeGameRate = ((closeGames / matches.length) * 100).toFixed(1);
            stats.bigWinRate = ((bigWins / matches.length) * 100).toFixed(1);
            
            stats.weekdayPercent = Math.round((stats.weekdayMatches / matches.length) * 100);
            stats.weekendPercent = Math.round((stats.weekendMatches / matches.length) * 100);

            // 이번달 경기 유형별 분포 계산
            const thisMonthMatchTypes = {};
            let thisMonthWeekdayMatches = 0;
            let thisMonthWeekendMatches = 0;
            
            filteredMatches.forEach(match => {
                const matchDate = new Date(match.date || match.timestamp);
                const matchMonthKey = `${matchDate.getFullYear()}-${String(matchDate.getMonth() + 1).padStart(2, '0')}`;
                
                if (matchMonthKey === thisMonthKey) {
                    // 경기 유형별 집계
                    const type = match.matchType || '남복';
                    thisMonthMatchTypes[type] = (thisMonthMatchTypes[type] || 0) + 1;
                    
                    // 요일별 분석
                    const dayOfWeek = matchDate.getDay();
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        thisMonthWeekendMatches++;
                    } else {
                        thisMonthWeekdayMatches++;
                    }
                }
            });
            
            stats.thisMonthMatchTypes = thisMonthMatchTypes;
            stats.thisMonthWeekdayMatches = thisMonthWeekdayMatches;
            stats.thisMonthWeekendMatches = thisMonthWeekendMatches;
            stats.thisMonthTotalMatches = thisMonthWeekdayMatches + thisMonthWeekendMatches;

            // 이번달 파트너십 계산
            const thisMonthPartnerships = {};
            
            filteredMatches.forEach(match => {
                const matchDate = new Date(match.date || match.timestamp);
                const matchMonthKey = `${matchDate.getFullYear()}-${String(matchDate.getMonth() + 1).padStart(2, '0')}`;
                
                if (matchMonthKey === thisMonthKey) {
                    const playersA = extractPlayers(match.teamA);
                    const playersB = extractPlayers(match.teamB);
                    
                    if (playersA.length === 2) {
                        const partnership = playersA.sort().join(' & ');
                        thisMonthPartnerships[partnership] = (thisMonthPartnerships[partnership] || 0) + 1;
                    }
                    if (playersB.length === 2) {
                        const partnership = playersB.sort().join(' & ');
                        thisMonthPartnerships[partnership] = (thisMonthPartnerships[partnership] || 0) + 1;
                    }
                }
            });
            
            stats.thisMonthFixedPartnerships = Object.values(thisMonthPartnerships).filter(count => count >= 3).length;

            // 파트너십 통계
            stats.totalPartnerships = Object.keys(partnerships).length;
            stats.fixedPartnerships = Object.values(partnerships).filter(count => count >= 3).length;
            stats.avgPartnersPerPlayer = stats.totalPlayers > 0 ? (stats.totalPartnerships * 2 / stats.totalPlayers).toFixed(1) : '0';
            
            const mostPartnershipEntry = Object.entries(partnerships).sort((a, b) => b[1] - a[1])[0];
            stats.mostPartnership = mostPartnershipEntry ? `${mostPartnershipEntry[0]} (${mostPartnershipEntry[1]}경기)` : '없음';
            
            const doublesMatches = (stats.matchTypes['남복'] || 0) + (stats.matchTypes['여복'] || 0) + (stats.matchTypes['혼복'] || 0);
            stats.doublesParticipation = Math.round((doublesMatches / filteredMatches.length) * 100);

            // 클럽 기록 계산
            let maxWinStreak = 0;
            let topWinStreakPlayer = '없음';
            let topPointsPlayer = '없음';
            let mostActivePlayer = '없음';
            let topBigWinPlayer = '없음';
            let topCloseGamePlayer = '없음';
            let maxPoints = 0;
            let maxMatches = 0;
            let maxBigWins = 0;
            let maxCloseGames = 0;

            // 각 플레이어별 연승 기록 및 기타 기록 계산
            Object.entries(playerStats).forEach(([playerName, data]) => {
                // 최고 승점자
                if (data.points > maxPoints) {
                    maxPoints = data.points;
                    topPointsPlayer = `${playerName} (${data.points}점)`;
                }

                // 최다 경기 참가자
                if (data.matches > maxMatches) {
                    maxMatches = data.matches;
                    mostActivePlayer = `${playerName} (${data.matches}경기)`;
                }

                // 플레이어별 최대 연승, 대승, 접전 기록 계산
                const playerMatches = matches.filter(match => {
                    const playersA = extractPlayers(match.teamA);
                    const playersB = extractPlayers(match.teamB);
                    return playersA.includes(playerName) || playersB.includes(playerName);
                }).sort((a, b) => new Date(a.date || a.timestamp) - new Date(b.date || b.timestamp));

                let currentStreak = 0;
                let maxPlayerStreak = 0;
                let playerBigWins = 0;
                let playerCloseGames = 0;

                playerMatches.forEach(match => {
                    const playersA = extractPlayers(match.teamA);
                    const playersB = extractPlayers(match.teamB);
                    const scoreA = parseInt(match.scoreA || 0);
                    const scoreB = parseInt(match.scoreB || 0);
                    const isTeamA = playersA.includes(playerName);
                    const scoreDiff = Math.abs(scoreA - scoreB);
                    
                    const isWin = (isTeamA && scoreA > scoreB) || (!isTeamA && scoreB > scoreA);
                    
                    // 연승 계산
                    if (isWin) {
                        currentStreak++;
                        maxPlayerStreak = Math.max(maxPlayerStreak, currentStreak);
                        
                        // 대승 계산 (승리 + 3점차 이상)
                        if (scoreDiff >= 3) {
                            playerBigWins++;
                        }
                    } else {
                        currentStreak = 0;
                    }
                    
                    // 접전 계산 (1-2점차)
                    if (scoreDiff <= 2) {
                        playerCloseGames++;
                    }
                });

                // 최대 연승자
                if (maxPlayerStreak > maxWinStreak) {
                    maxWinStreak = maxPlayerStreak;
                    topWinStreakPlayer = `${playerName} (${maxPlayerStreak}연승)`;
                }
                
                // 최대 대승자 
                if (playerBigWins > maxBigWins) {
                    maxBigWins = playerBigWins;
                    topBigWinPlayer = `${playerName} (${playerBigWins}회)`;
                }
                
                // 최대 접전자
                if (playerCloseGames > maxCloseGames) {
                    maxCloseGames = playerCloseGames;
                    topCloseGamePlayer = `${playerName} (${playerCloseGames}경기)`;
                }
            });

            stats.topWinStreakPlayer = topWinStreakPlayer;
            stats.topPointsPlayer = topPointsPlayer;
            stats.mostActivePlayer = mostActivePlayer;
            stats.topBigWinPlayer = topBigWinPlayer;
            
            // 이번달 최다 경기 참가자 계산
            let thisMonthMaxMatches = 0;
            let thisMonthMostActivePlayer = '없음';
            
            Object.entries(thisMonthPlayerStats).forEach(([playerName, matchCount]) => {
                if (matchCount > thisMonthMaxMatches) {
                    thisMonthMaxMatches = matchCount;
                    thisMonthMostActivePlayer = `${playerName} (${matchCount}경기)`;
                }
            });
            
            stats.thisMonthMostActivePlayer = thisMonthMostActivePlayer;
            stats.topCloseGamePlayer = topCloseGamePlayer;

            // 최고 승률 파트너십 계산 (상위 5위까지 표시)
            let partnershipRankings = [];

            // 각 파트너십별 승률 분석
            Object.entries(partnerships).forEach(([partnershipName, games]) => {
                if (games >= 3) { // 3경기 이상 플레이한 파트너십만 고려 (신뢰성 있는 데이터)
                    
                    // 해당 파트너십이 참여한 모든 경기 필터링 (게스트 제외)
                    const partnershipMatches = filteredMatches.filter(match => {
                        const playersA = extractPlayers(match.teamA);
                        const playersB = extractPlayers(match.teamB);
                        
                        // 게스트가 아닌 플레이어들로만 파트너십 이름 생성 (복식경기인 경우만)
                        const nonGuestPlayersA = playersA.filter(player => !isGuestPlayer(player));
                        const nonGuestPlayersB = playersB.filter(player => !isGuestPlayer(player));
                        
                        const teamAPartnership = nonGuestPlayersA.length > 1 ? nonGuestPlayersA.sort().join(' / ') : '';
                        const teamBPartnership = nonGuestPlayersB.length > 1 ? nonGuestPlayersB.sort().join(' / ') : '';
                        
                        // 해당 파트너십이 팀A 또는 팀B에 있는 경기만 선택
                        return teamAPartnership === partnershipName || teamBPartnership === partnershipName;
                    });

                    // 파트너십의 승리 횟수 계산 (게스트 제외)
                    let partnershipWins = 0;
                    partnershipMatches.forEach(match => {
                        const playersA = extractPlayers(match.teamA);
                        const playersB = extractPlayers(match.teamB);
                        const scoreA = parseInt(match.scoreA || 0);
                        const scoreB = parseInt(match.scoreB || 0);
                        
                        // 게스트가 아닌 플레이어들로만 파트너십 이름 생성
                        const nonGuestPlayersA = playersA.filter(player => !isGuestPlayer(player));
                        const nonGuestPlayersB = playersB.filter(player => !isGuestPlayer(player));
                        
                        const teamAPartnership = nonGuestPlayersA.length > 1 ? nonGuestPlayersA.sort().join(' / ') : '';
                        const teamBPartnership = nonGuestPlayersB.length > 1 ? nonGuestPlayersB.sort().join(' / ') : '';

                        // 해당 파트너십이 승리한 경기인지 확인
                        if (teamAPartnership === partnershipName && scoreA > scoreB) {
                            partnershipWins++; // 팀A로 참여하여 승리
                        } else if (teamBPartnership === partnershipName && scoreB > scoreA) {
                            partnershipWins++; // 팀B로 참여하여 승리
                        }
                    });

                    // 승률 계산 (승리 경기 수 / 전체 경기 수 * 100)
                    const winRate = (partnershipWins / partnershipMatches.length) * 100;
                    const winRateNumber = Math.round(winRate);
                    
                    // 승률 50% 이상인 파트너십만 랭킹에 포함 (우수한 성과를 보인 파트너십만)
                    if (winRateNumber >= 50) {
                        partnershipRankings.push({
                            name: partnershipName,
                            winRate: winRateNumber,
                            games: games
                        });
                    }
                }
            });

            // 승률 순으로 정렬하고 상위 5개만 선택
            partnershipRankings.sort((a, b) => b.winRate - a.winRate);
            const topPartnerships = partnershipRankings.slice(0, 5);
            
            let bestWinRatePartnership = '없음';
            if (topPartnerships.length > 0) {
                bestWinRatePartnership = topPartnerships.map((partnership, index) => {
                    return `${index + 1}위: ${partnership.name} (승률 ${partnership.winRate}%)`;
                }).join('<br>'); // 줄바꿈으로 변경
            }

            stats.bestWinRatePartnership = bestWinRatePartnership;

            // 기간 및 성장 분석
            const dates = filteredMatches.map(m => new Date(m.date || m.timestamp)).sort((a, b) => a - b);
            const firstDate = dates[0];
            const lastDate = dates[dates.length - 1];
            const diffMonths = Math.ceil((lastDate - firstDate) / (1000 * 60 * 60 * 24 * 30.44));
            
            stats.activityPeriod = diffMonths > 0 ? `${diffMonths}개월` : '1개월 미만';
            stats.monthlyAvgMatches = diffMonths > 0 ? (filteredMatches.length / diffMonths).toFixed(1) : filteredMatches.length.toString();

            // 성장 트렌드 계산을 위한 전체 데이터 기반 월별 데이터 생성
            const allTimeMonthlyData = {};
            matches.forEach(match => {
                const date = new Date(match.date || match.timestamp);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                allTimeMonthlyData[monthKey] = (allTimeMonthlyData[monthKey] || 0) + 1;
            });

            // 이번 달 경기
            stats.thisMonthMatches = allTimeMonthlyData[thisMonthKey] || 0;

            // 가장 바쁜 달
            const busiestMonthEntry = Object.entries(allTimeMonthlyData).sort((a, b) => b[1] - a[1])[0];
            stats.busiestMonth = busiestMonthEntry ? `${busiestMonthEntry[0]} (${busiestMonthEntry[1]}경기)` : '없음';

            // 클럽 평균 승률
            const totalWins = Object.values(playerStats).reduce((sum, p) => sum + p.wins, 0);
            const totalMatches = Object.values(playerStats).reduce((sum, p) => sum + p.matches, 0);
            stats.clubAvgWinRate = totalMatches > 0 ? Math.round((totalWins / totalMatches) * 100) : 0;
            
            const lastMonth = new Date(thisMonth.getFullYear(), thisMonth.getMonth() - 1);
            const lastMonthKey = `${lastMonth.getFullYear()}-${String(lastMonth.getMonth() + 1).padStart(2, '0')}`;
            
            const thisMonthMatches = allTimeMonthlyData[thisMonthKey] || 0;
            const lastMonthMatches = allTimeMonthlyData[lastMonthKey] || 0;
            
            // 월간 경기수 증가율
            if (lastMonthMatches > 0) {
                stats.monthlyGrowthRate = Math.round(((thisMonthMatches - lastMonthMatches) / lastMonthMatches) * 100);
            } else if (thisMonthMatches > 0) {
                stats.monthlyGrowthRate = 100; // 지난달 0경기에서 이번달 경기가 있으면 100% 증가
            } else {
                stats.monthlyGrowthRate = 0;
            }
            
            // 신규 활성 플레이어 (이번달 첫 경기를 한 플레이어)
            const allTimePlayerStats = {};
            const thisMonthNewPlayers = {};
            
            // 전체 경기 데이터를 사용하여 신규 플레이어 계산
            matches.forEach(match => {
                const matchDate = new Date(match.date || match.timestamp);
                const matchMonthKey = `${matchDate.getFullYear()}-${String(matchDate.getMonth() + 1).padStart(2, '0')}`;
                
                const playersA = extractPlayers(match.teamA);
                const playersB = extractPlayers(match.teamB);
                
                [...playersA, ...playersB].forEach(player => {
                    if (!allTimePlayerStats[player]) {
                        allTimePlayerStats[player] = [];
                    }
                    allTimePlayerStats[player].push(matchMonthKey);
                });
            });
            
            // 이번달이 첫 경기인 플레이어 찾기
            stats.newActivePlayers = 0;
            Object.entries(allTimePlayerStats).forEach(([player, months]) => {
                const uniqueMonths = [...new Set(months)].sort();
                if (uniqueMonths.length > 0 && uniqueMonths[0] === thisMonthKey) {
                    stats.newActivePlayers++;
                }
            });
            
            // 평균 경기 참여도 (활성 플레이어 / 전체 플레이어 * 100)
            stats.avgParticipation = stats.totalPlayers > 0 ? Math.round((stats.activePlayers / stats.totalPlayers) * 100) : 0;

            // 최근 활동 및 성장
            const recentMatches = filteredMatches.filter(m => {
                const matchDate = new Date(m.date || m.timestamp);
                const monthAgo = new Date();
                monthAgo.setMonth(monthAgo.getMonth() - 1);
                return matchDate >= monthAgo;
            });
            
            stats.recentActivity = recentMatches.length >= 10 ? '매우 활발' : recentMatches.length >= 5 ? '활발' : recentMatches.length >= 2 ? '보통' : '저조';
            
            // 신규 플레이어 (최근 3개월)
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
            const recentPlayerMatches = {};
            
            filteredMatches.filter(m => new Date(m.date || m.timestamp) >= threeMonthsAgo).forEach(match => {
                [...extractPlayers(match.teamA), ...extractPlayers(match.teamB)].forEach(player => {
                    recentPlayerMatches[player] = true;
                });
            });
            
            stats.newPlayersRecent = Object.keys(recentPlayerMatches).length;
            stats.regularPlayers = Object.values(playerStats).filter(p => p.matches >= 2).length;
            stats.retentionRate = stats.totalPlayers > 0 ? Math.round((stats.activePlayers / stats.totalPlayers) * 100) : 0;
            
            // 성장률
            const firstHalf = filteredMatches.slice(0, Math.floor(filteredMatches.length / 2));
            const secondHalf = filteredMatches.slice(Math.floor(filteredMatches.length / 2));
            const growthRate = firstHalf.length > 0 ? ((secondHalf.length - firstHalf.length) / firstHalf.length * 100) : 0;
            stats.growthTrend = growthRate > 10 ? '🚀 급성장' : growthRate > 0 ? '📈 성장' : growthRate < -10 ? '📉 감소' : '➖ 안정';

            // 평균 점수 계산
            stats.avgTotalScore = filteredMatches.length > 0 ? (totalScore / filteredMatches.length).toFixed(1) : 0;
            stats.avgScoreDiff = filteredMatches.length > 0 ? (totalScoreDiff / filteredMatches.length).toFixed(1) : 0;
            stats.closeGameRate = filteredMatches.length > 0 ? Math.round((closeGames / filteredMatches.length) * 100) : 0;
            stats.bigWinRate = filteredMatches.length > 0 ? Math.round((bigWins / filteredMatches.length) * 100) : 0;

            return stats;
        }

        // 데이터 표시 범위 토글 함수
        function toggleDataRange() {
            const checkbox = document.getElementById('showAllRecords');
            const label = document.getElementById('rangeLabel');
            
            console.log('토글 상태:', checkbox.checked ? '체크됨(최근 2년)' : '체크 해제됨(전체)');
            
            if (checkbox.checked) {
                // 체크됨 = 최근 2년 표시 (기본값)
                const saved = localStorage.getItem('rivalMatches');
                const allMatches = saved ? JSON.parse(saved) : [];
                const currentDate = new Date();
                const twoYearsAgo = new Date();
                twoYearsAgo.setFullYear(currentDate.getFullYear() - 2);
                
                matches = allMatches.filter(match => {
                    if (!match.timestamp) return false;
                    const matchDate = new Date(match.timestamp);
                    if (isNaN(matchDate.getTime())) return false;
                    return matchDate >= twoYearsAgo;
                });
                label.textContent = '최근 2년';
                console.log(`✅ 최근 2년 필터링: 전체 ${allMatches.length}개 → 표시 ${matches.length}개`);
            } else {
                // 체크 해제 = 전체 데이터 표시
                const saved = localStorage.getItem('rivalMatches');
                matches = saved ? JSON.parse(saved) : [];
                label.textContent = '전체 기록';
                console.log(`📋 전체 기록 표시: ${matches.length}개`);
            }
            
            // 페이지 초기화하고 다시 렌더링
            currentPage = 1;
            renderMatches();
            updateRankings();
        }

        // 개인 통계 모달 닫기 애니메이션 함수
        function closePlayerStatsModal() {
            const modal = document.getElementById('playerStatsModal');
            if (modal) {
                // 닫기 애니메이션 적용
                modal.style.animation = 'fadeOut 0.3s ease';
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.animation = 'slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                }
                
                // 바디 스크롤 복원
                document.body.style.overflow = '';
                
                // 애니메이션 완료 후 모달 제거
                setTimeout(() => {
                    modal.remove();
                }, 300);
            } else {
                // 모달이 없어도 스크롤 상태 복원
                document.body.style.overflow = '';
            }
        }

        // 자동완성 시스템 
        let playerNames = [];
        let currentDropdown = null;
        let selectedIndex = -1;

        // 플레이어 통계 내비게이션
        let playerStatsHistory = [];
        let currentPlayerIndex = -1;

        // 플레이어 통계로 이동
        function navigateToPlayerStats(playerName) {
            // 현재 플레이어와 같으면 무시
            if (playerStatsHistory[currentPlayerIndex] === playerName) {
                return;
            }
            
            // 새 플레이어를 히스토리에 추가
            if (currentPlayerIndex >= 0 && currentPlayerIndex < playerStatsHistory.length - 1) {
                // 현재 위치 이후의 히스토리 제거
                playerStatsHistory = playerStatsHistory.slice(0, currentPlayerIndex + 1);
            }
            
            playerStatsHistory.push(playerName);
            currentPlayerIndex = playerStatsHistory.length - 1;
            
            // 플레이어 통계 모달 표시
            showPlayerStatsModal(playerName);
        }

        // 이전 플레이어로 이동
        function navigateToPreviousPlayer() {
            if (currentPlayerIndex > 0) {
                currentPlayerIndex--;
                showPlayerStatsModal(playerStatsHistory[currentPlayerIndex]);
            }
        }

        // 다음 플레이어로 이동
        function navigateToNextPlayer() {
            if (currentPlayerIndex < playerStatsHistory.length - 1) {
                currentPlayerIndex++;
                showPlayerStatsModal(playerStatsHistory[currentPlayerIndex]);
            }
        }

        // 내비게이션 버튼 업데이트
        function updatePlayerNavigationButtons() {
            const prevBtn = document.getElementById('playerNavPrev');
            const nextBtn = document.getElementById('playerNavNext');
            const navContainer = prevBtn?.parentElement;
            
            if (prevBtn && nextBtn && navContainer) {
                // 네비게이션 히스토리가 있는지 확인 (2개 이상의 플레이어가 있어야 네비게이션 의미가 있음)
                const hasNavigation = playerStatsHistory.length > 1;
                
                if (hasNavigation) {
                    // 네비게이션 버튼 표시
                    navContainer.style.display = 'flex';
                    
                    prevBtn.disabled = currentPlayerIndex <= 0;
                    nextBtn.disabled = currentPlayerIndex >= playerStatsHistory.length - 1;
                    
                    // 버튼 스타일 업데이트
                    prevBtn.style.opacity = prevBtn.disabled ? '0.4' : '1';
                    nextBtn.style.opacity = nextBtn.disabled ? '0.4' : '1';
                    prevBtn.style.cursor = prevBtn.disabled ? 'not-allowed' : 'pointer';
                    nextBtn.style.cursor = nextBtn.disabled ? 'not-allowed' : 'pointer';
                } else {
                    // 네비게이션 버튼 숨기기
                    navContainer.style.display = 'none';
                }
            }
        }

        // 로컬 저장소에서 선수 이름 목록 로드
        function loadPlayerNames() {
            const saved = localStorage.getItem('tennisPlayerNames');
            if (saved) {
                playerNames = JSON.parse(saved);
            }
        }

        // 선수 이름 저장
        function savePlayerNames() {
            localStorage.setItem('tennisPlayerNames', JSON.stringify(playerNames));
        }

        // 선수 이름 추가
        function addPlayerName(name) {
            name = name.trim();
            if (name && !playerNames.includes(name)) {
                playerNames.unshift(name); // 맨 앞에 추가
                if (playerNames.length > 50) { // 최대 50개만 유지
                    playerNames = playerNames.slice(0, 50);
                }
                savePlayerNames();
            }
        }

        // 자동완성 드롭다운 표시
        function showAutocomplete(inputId, query) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById('autocomplete' + inputId.slice(-2)); // A1, A2, B1, B2
            
            if (!input || !dropdown) return;

            // 기존 드롭다운 숨기기
            hideAllAutocomplete();
            
            currentDropdown = dropdown;
            selectedIndex = -1;

            if (!query.trim()) {
                // 쿼리가 없으면 최근 10개만 표시
                const recentNames = playerNames.slice(0, 10);
                displayAutocompleteItems(dropdown, recentNames, inputId);
                return;
            }

            // 필터링된 이름 찾기 (대소문자 구분 없이)
            const filteredNames = playerNames.filter(name => 
                name.toLowerCase().includes(query.toLowerCase())
            );

            if (filteredNames.length > 0) {
                displayAutocompleteItems(dropdown, filteredNames, inputId);
            } else {
                dropdown.style.display = 'none';
            }
        }

        // 자동완성 아이템 표시
        function displayAutocompleteItems(dropdown, names, inputId) {
            dropdown.innerHTML = '';
            
            names.forEach((name, index) => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = name;
                item.onclick = () => selectAutocompleteItem(inputId, name);
                dropdown.appendChild(item);
            });

            dropdown.style.display = 'block';
        }

        // 자동완성 아이템 선택
        function selectAutocompleteItem(inputId, name) {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = name;
                hideAllAutocomplete();
                // 선택된 이름을 목록 맨 앞으로 이동
                const index = playerNames.indexOf(name);
                if (index > 0) {
                    playerNames.splice(index, 1);
                    playerNames.unshift(name);
                    savePlayerNames();
                }
            }
        }

        // 모든 자동완성 드롭다운 숨기기
        function hideAllAutocomplete() {
            document.querySelectorAll('.autocomplete-dropdown').forEach(dropdown => {
                dropdown.style.display = 'none';
            });
            currentDropdown = null;
            selectedIndex = -1;
        }

        // 키보드 네비게이션
        function handleAutocompleteKeyboard(event, inputId) {
            if (!currentDropdown || currentDropdown.style.display === 'none') return;

            const items = currentDropdown.querySelectorAll('.autocomplete-item');
            
            switch (event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateSelection(items);
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateSelection(items);
                    break;
                case 'Enter':
                    event.preventDefault();
                    if (selectedIndex >= 0 && items[selectedIndex]) {
                        items[selectedIndex].click();
                    }
                    break;
                case 'Escape':
                    hideAllAutocomplete();
                    break;
            }
        }

        // 선택 상태 업데이트
        function updateSelection(items) {
            items.forEach((item, index) => {
                item.classList.toggle('selected', index === selectedIndex);
            });
        }

        // 점수 선택 기능
        function setScore(team, score) {
            const scoreInput = document.getElementById('score' + team);
            const scoreDisplay = document.getElementById('score' + team + 'Display');
            const buttons = document.querySelectorAll(`.score-container .score-button[onclick*="'${team}'"]`);
            
            // 모든 버튼의 선택 상태 제거
            buttons.forEach(btn => btn.classList.remove('selected'));
            
            // 클릭된 버튼 선택 표시
            event.target.classList.add('selected');
            
            // 점수 설정
            scoreInput.value = score;
            scoreDisplay.textContent = score;
        }

        function clearScore(team) {
            const scoreInput = document.getElementById('score' + team);
            const scoreDisplay = document.getElementById('score' + team + 'Display');
            const buttons = document.querySelectorAll(`.score-container .score-button[onclick*="'${team}'"]`);
            
            // 모든 버튼의 선택 상태 제거
            buttons.forEach(btn => btn.classList.remove('selected'));
            
            scoreInput.value = 0;
            scoreDisplay.textContent = 0;
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadPlayerNames();
            
            // 모든 선수 이름 입력 필드에 이벤트 리스너 추가
            ['teamA1', 'teamA2', 'teamB1', 'teamB2'].forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', function() {
                        showAutocomplete(inputId, this.value);
                    });

                    input.addEventListener('focus', function() {
                        showAutocomplete(inputId, this.value);
                        // 일반 폼 필드는 사용자가 직접 스크롤 (scrollIntoView 제거)
                    });

                    input.addEventListener('keydown', function(event) {
                        handleAutocompleteKeyboard(event, inputId);
                    });

                    // 블러 이벤트 (약간 지연 후 숨기기 - 클릭 가능하도록)
                    input.addEventListener('blur', function() {
                        setTimeout(() => {
                            hideAllAutocomplete();
                        }, 200);
                    });
                }
            });

            // 문서 클릭 시 자동완성 숨기기
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.player-input-wrapper')) {
                    hideAllAutocomplete();
                }
            });
        });

        // 기존 saveMatch 함수 수정하여 선수 이름 저장
        const originalSaveMatch = saveMatch;
        saveMatch = function() {
            // 선수 이름들을 저장
            const names = [
                document.getElementById('teamA1').value.trim(),
                document.getElementById('teamA2').value.trim(),
                document.getElementById('teamB1').value.trim(),
                document.getElementById('teamB2').value.trim()
            ];
            
            names.forEach(name => {
                if (name) addPlayerName(name);
            });
            
            // 기존 saveMatch 함수 실행
            return originalSaveMatch();
        };
    </script>
</body>
</html>
